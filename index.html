<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OdontoFlow Pro - Sistema de Gestão Odontológica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-section { display: none; }
        .tooth-chart { display: grid; grid-template-columns: repeat(16, 1fr); gap: 5px; max-width: 100%; overflow-x: auto; padding: 10px; }
        .tooth { border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; background: white; }
        .tooth:hover { transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tooth.selected { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* Status Colors for Odontogram */
        .status-saudavel { color: #10b981; }
        .status-carie { color: #ef4444; }
        .status-restaurado { color: #3b82f6; }
        .status-ausente { color: #9ca3af; text-decoration: line-through; }
        .status-canal { color: #8b5cf6; }
        .status-implante { color: #f59e0b; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <div class="text-center mb-6">
                <i class="fas fa-tooth text-5xl text-blue-600 mb-2"></i>
                <h2 class="text-2xl font-bold text-gray-800">OdontoFlow Pro</h2>
                <p class="text-sm text-gray-500">Gestão Clínica Segura</p>
            </div>
            <form onsubmit="app.login(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Usuário</label>
                    <input type="text" id="loginUser" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="admin">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="loginPass" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="admin123">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200 font-semibold">Entrar no Sistema</button>
                <p class="text-xs text-center text-gray-400 mt-4">Padrão: admin / admin123</p>
            </form>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="appContainer" class="flex h-full hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white shadow-md flex flex-col z-10 hidden md:flex no-print">
            <div class="p-6 border-b flex items-center gap-3">
                <i class="fas fa-tooth text-2xl text-blue-600"></i>
                <span class="text-xl font-bold text-gray-800">OdontoFlow</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <a href="#" onclick="app.router('dashboard')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 border-r-4 border-transparent hover:border-blue-600 transition"><i class="fas fa-home w-6"></i> Dashboard</a>
                <a href="#" onclick="app.router('agenda')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 border-r-4 border-transparent hover:border-blue-600 transition"><i class="fas fa-calendar-alt w-6"></i> Agenda</a>
                <a href="#" onclick="app.router('pacientes')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 border-r-4 border-transparent hover:border-blue-600 transition"><i class="fas fa-user-injured w-6"></i> Pacientes & Prontuário</a>
                <a href="#" onclick="app.router('financeiro')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 border-r-4 border-transparent hover:border-blue-600 transition"><i class="fas fa-dollar-sign w-6"></i> Financeiro</a>
                <a href="#" onclick="app.router('estoque')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 border-r-4 border-transparent hover:border-blue-600 transition"><i class="fas fa-boxes w-6"></i> Estoque</a>
                <a href="#" onclick="app.router('config')" class="nav-item block px-6 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 border-r-4 border-transparent hover:border-blue-600 transition"><i class="fas fa-cogs w-6"></i> Configurações & Backup</a>
            </nav>
            <div class="p-4 border-t bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">Dr</div>
                    <div>
                        <p class="text-sm font-semibold">Dr. Admin</p>
                        <p class="text-xs text-gray-500">Cirurgião Dentista</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MOBILE HEADER -->
        <div class="md:hidden fixed top-0 w-full bg-white z-20 shadow-sm p-4 flex justify-between items-center no-print">
            <span class="font-bold text-lg">OdontoFlow</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-8 pt-16 md:pt-8">
            
            <!-- DASHBOARD VIEW -->
            <section id="view-dashboard" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Visão Geral</h2>
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Pacientes Hoje</p>
                                <h3 class="text-2xl font-bold" id="dash-today-count">0</h3>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-calendar-day"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Faturamento Mês</p>
                                <h3 class="text-2xl font-bold text-green-600" id="dash-revenue">R$ 0,00</h3>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full text-green-600"><i class="fas fa-chart-line"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Pacientes Totais</p>
                                <h3 class="text-2xl font-bold" id="dash-total-patients">0</h3>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full text-purple-600"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Pendências</p>
                                <h3 class="text-2xl font-bold" id="dash-pending">0</h3>
                            </div>
                            <div class="bg-red-100 p-3 rounded-full text-red-600"><i class="fas fa-exclamation-circle"></i></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold mb-4">Próximos Atendimentos</h3>
                        <ul id="dash-next-appointments" class="space-y-3">
                            <!-- JS Injected -->
                        </ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold mb-4">Faturamento Anual</h3>
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- AGENDA VIEW -->
            <section id="view-agenda" class="hidden-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Agenda</h2>
                    <button onclick="app.openModal('appointmentModal')" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700"><i class="fas fa-plus mr-2"></i>Novo Agendamento</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex gap-4 mb-4">
                        <input type="date" id="agendaDate" class="border p-2 rounded" onchange="app.renderAgenda()">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                                    <th class="p-3 border-b">Horário</th>
                                    <th class="p-3 border-b">Paciente</th>
                                    <th class="p-3 border-b">Procedimento</th>
                                    <th class="p-3 border-b">Status</th>
                                    <th class="p-3 border-b">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="agendaTableBody">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- PACIENTES VIEW -->
            <section id="view-pacientes" class="hidden-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Pacientes</h2>
                    <button onclick="app.openPatientModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700"><i class="fas fa-user-plus mr-2"></i>Novo Paciente</button>
                </div>
                
                <!-- Search -->
                <div class="bg-white p-4 rounded-lg shadow-sm flex gap-2">
                    <input type="text" id="patientSearch" placeholder="Buscar por nome, CPF ou telefone..." class="flex-1 border p-2 rounded" onkeyup="app.renderPatientList()">
                    <button class="bg-gray-100 px-4 py-2 rounded text-gray-600"><i class="fas fa-search"></i></button>
                </div>

                <!-- Lista -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="p-4">Nome</th>
                                <th class="p-4">Telefone</th>
                                <th class="p-4">Última Visita</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="patientListBody">
                            <!-- List -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- PRONTUÁRIO VIEW (Detalhes do Paciente) -->
            <section id="view-prontuario" class="hidden-section space-y-6">
                <div class="flex items-center gap-4">
                    <button onclick="app.router('pacientes')" class="text-gray-500 hover:text-blue-600"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <h2 class="text-2xl font-bold text-gray-800" id="prontuarioName">Nome do Paciente</h2>
                </div>

                <!-- Tabs -->
                <div class="flex border-b bg-white rounded-t-lg overflow-x-auto">
                    <button onclick="app.switchTab('tab-dados')" class="tab-btn active px-6 py-3 border-b-2 border-blue-600 text-blue-600 font-medium">Dados Pessoais</button>
                    <button onclick="app.switchTab('tab-anamnese')" class="tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-blue-600">Anamnese</button>
                    <button onclick="app.switchTab('tab-odontograma')" class="tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-blue-600">Odontograma & Plano</button>
                    <button onclick="app.switchTab('tab-evolucao')" class="tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-blue-600">Evolução Clínica</button>
                    <button onclick="app.switchTab('tab-financeiro-paciente')" class="tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-blue-600">Financeiro</button>
                </div>

                <!-- Content Tabs -->
                <div class="bg-white p-6 rounded-b-lg shadow-sm min-h-[500px]">
                    
                    <!-- Dados Pessoais -->
                    <div id="tab-dados" class="tab-content space-y-4">
                        <h3 class="font-bold text-lg mb-4">Cadastro Completo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="patientDetailsForm">
                            <!-- Rendered by JS -->
                        </div>
                        <div class="mt-4 flex justify-end">
                             <button onclick="app.savePatientDetails()" class="bg-green-600 text-white px-6 py-2 rounded">Salvar Alterações</button>
                        </div>
                    </div>

                    <!-- Anamnese -->
                    <div id="tab-anamnese" class="tab-content hidden-section">
                         <h3 class="font-bold text-lg mb-4">Anamnese Médica</h3>
                         <textarea id="anamneseText" class="w-full h-64 border p-4 rounded mb-4" placeholder="Histórico médico, alergias, medicações em uso..."></textarea>
                         <button onclick="app.saveAnamnese()" class="bg-blue-600 text-white px-6 py-2 rounded">Atualizar Anamnese</button>
                    </div>

                    <!-- Odontograma -->
                    <div id="tab-odontograma" class="tab-content hidden-section">
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg mb-2">Odontograma Interativo</h3>
                                <p class="text-sm text-gray-500 mb-4">Clique no dente para alterar o status.</p>
                                
                                <!-- Legenda -->
                                <div class="flex flex-wrap gap-3 mb-4 text-xs">
                                    <span class="px-2 py-1 rounded bg-gray-100 border text-gray-600">Clique 1x: Saudável</span>
                                    <span class="px-2 py-1 rounded bg-red-100 text-red-600 border border-red-200">2x: Cárie</span>
                                    <span class="px-2 py-1 rounded bg-blue-100 text-blue-600 border border-blue-200">3x: Restaurado</span>
                                    <span class="px-2 py-1 rounded bg-purple-100 text-purple-600 border border-purple-200">4x: Canal</span>
                                    <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-600 border border-yellow-200">5x: Implante</span>
                                    <span class="px-2 py-1 rounded bg-gray-200 text-gray-500 border border-gray-300 decoration-line-through">6x: Ausente</span>
                                </div>

                                <div id="odontogramaRender" class="tooth-chart bg-gray-50 border rounded-xl">
                                    <!-- Teeth rendered by JS -->
                                </div>
                            </div>
                            
                            <div class="w-full md:w-1/3 bg-gray-50 p-4 rounded border">
                                <h4 class="font-bold mb-2">Plano de Tratamento</h4>
                                <div id="treatmentPlanList" class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                                    <!-- Items -->
                                </div>
                                <button onclick="app.addTreatmentItem()" class="w-full bg-green-600 text-white py-2 rounded mb-2">+ Adicionar Procedimento</button>
                                <button onclick="window.print()" class="w-full bg-gray-600 text-white py-2 rounded"><i class="fas fa-print"></i> Imprimir Orçamento</button>
                            </div>
                        </div>
                    </div>

                    <!-- Evolução -->
                    <div id="tab-evolucao" class="tab-content hidden-section">
                        <h3 class="font-bold text-lg mb-4">Evolução do Tratamento (SOAP)</h3>
                        <div class="flex gap-2 mb-4">
                            <textarea id="newEvolutionNote" class="flex-1 border p-3 rounded" placeholder="Escreva a evolução de hoje (Queixa, Exame, Procedimento)..." rows="3"></textarea>
                            <button onclick="app.addEvolution()" class="bg-blue-600 text-white px-4 rounded">Adicionar</button>
                        </div>
                        <div id="evolutionTimeline" class="space-y-4 border-l-2 border-gray-200 ml-4 pl-4">
                            <!-- Timeline items -->
                        </div>
                    </div>
                    
                    <!-- Financeiro Paciente -->
                    <div id="tab-financeiro-paciente" class="tab-content hidden-section">
                        <h3 class="font-bold text-lg mb-4">Histórico Financeiro</h3>
                         <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2">Data</th>
                                    <th class="p-2">Descrição</th>
                                    <th class="p-2">Valor</th>
                                    <th class="p-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="patientFinanceList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- FINANCEIRO GERAL -->
            <section id="view-financeiro" class="hidden-section space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Gestão Financeira</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="app.openTransactionModal('entrada')" class="bg-green-500 text-white p-4 rounded shadow hover:bg-green-600 text-left">
                        <span class="block text-xs opacity-75">Registrar</span>
                        <span class="font-bold text-lg">Receita / Entrada</span>
                    </button>
                    <button onclick="app.openTransactionModal('saida')" class="bg-red-500 text-white p-4 rounded shadow hover:bg-red-600 text-left">
                        <span class="block text-xs opacity-75">Registrar</span>
                        <span class="font-bold text-lg">Despesa / Conta</span>
                    </button>
                </div>
                <div class="bg-white rounded shadow-sm overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4">Data</th>
                                <th class="p-4">Tipo</th>
                                <th class="p-4">Descrição</th>
                                <th class="p-4">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="financeTableBody"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- ESTOQUE -->
            <section id="view-estoque" class="hidden-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Controle de Estoque</h2>
                    <button onclick="app.openStockModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow">Novo Item</button>
                </div>
                <div class="bg-white rounded shadow-sm overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4">Item</th>
                                <th class="p-4">Qtd Atual</th>
                                <th class="p-4">Mínimo</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- CONFIGURAÇÕES -->
            <section id="view-config" class="hidden-section space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Configurações & Dados</h2>
                <div class="bg-white p-6 rounded shadow-sm space-y-4">
                    <h3 class="font-bold">Backup dos Dados</h3>
                    <p class="text-gray-600 text-sm">Como este sistema roda no seu navegador, é crucial fazer backups regulares baixando o arquivo de dados.</p>
                    <div class="flex gap-4">
                        <button onclick="app.exportData()" class="bg-blue-600 text-white px-4 py-2 rounded"><i class="fas fa-download"></i> Baixar Backup (JSON)</button>
                        
                        <label class="bg-gray-200 text-gray-700 px-4 py-2 rounded cursor-pointer hover:bg-gray-300">
                            <i class="fas fa-upload"></i> Restaurar Backup
                            <input type="file" class="hidden" onchange="app.importData(this)">
                        </label>
                    </div>
                </div>
                <div class="bg-white p-6 rounded shadow-sm space-y-4 border-l-4 border-red-500">
                    <h3 class="font-bold text-red-600">Zona de Perigo</h3>
                    <p class="text-sm text-gray-500">Apagar todos os dados do sistema localmente.</p>
                    <button onclick="app.resetSystem()" class="text-red-600 border border-red-200 px-4 py-2 rounded hover:bg-red-50">Resetar Sistema</button>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS (Hidden by default) -->
    <!-- Appointment Modal -->
    <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-96">
            <h3 class="font-bold mb-4">Novo Agendamento</h3>
            <form onsubmit="app.saveAppointment(event)" class="space-y-3">
                <select id="aptPatient" class="w-full border p-2 rounded" required></select>
                <input type="date" id="aptDate" class="w-full border p-2 rounded" required>
                <input type="time" id="aptTime" class="w-full border p-2 rounded" required>
                <input type="text" id="aptProc" class="w-full border p-2 rounded" placeholder="Procedimento" required>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="app.closeModal('appointmentModal')" class="text-gray-500 px-4 py-2">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Agendar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT APP LOGIC -->
    <script>
        const app = {
            data: {
                user: null,
                patients: [],
                appointments: [],
                transactions: [],
                inventory: [],
                config: { clinicName: 'Minha Clínica' }
            },
            currentPatientId: null,

            // --- 1. SYSTEM STARTUP ---
            init() {
                // Load data from LocalStorage
                const saved = localStorage.getItem('odontoFlowData');
                if (saved) {
                    this.data = JSON.parse(saved);
                } else {
                    // Seed Dummy Data for first run
                    this.seedData();
                }

                // Check Login
                if (sessionStorage.getItem('isLoggedIn')) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    this.updateUI();
                }
            },

            login(e) {
                e.preventDefault();
                const u = document.getElementById('loginUser').value;
                const p = document.getElementById('loginPass').value;
                // Simple Check (In real app, use backend)
                if (u === 'admin' && p === 'admin123') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    this.updateUI();
                } else {
                    alert('Credenciais inválidas! Tente admin / admin123');
                }
            },

            seedData() {
                // Basic Dummy Data
                this.data.patients.push({
                    id: 1, name: 'João da Silva', phone: '11999999999', cpf: '123.456.789-00', 
                    email: 'joao@email.com', anamnese: '', odontogram: {}, evolution: [],
                    createdAt: new Date().toISOString()
                });
                this.data.appointments.push({
                    id: Date.now(), patientId: 1, date: new Date().toISOString().split('T')[0], 
                    time: '14:00', procedure: 'Avaliação', status: 'Pendente'
                });
                this.save();
            },

            save() {
                localStorage.setItem('odontoFlowData', JSON.stringify(this.data));
                this.updateUI();
            },

            // --- 2. NAVIGATION ---
            router(viewName) {
                // Hide all sections
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden-section'));
                // Show selected
                document.getElementById(`view-${viewName}`).classList.remove('hidden-section');
                // Close Sidebar on mobile
                if(window.innerWidth < 768) document.querySelector('aside').classList.add('hidden');
            },

            updateUI() {
                this.renderDashboard();
                document.getElementById('agendaDate').valueAsDate = new Date();
                this.renderAgenda();
                this.renderFinanceChart();
            },

            // --- 3. DASHBOARD ---
            renderDashboard() {
                const today = new Date().toISOString().split('T')[0];
                const todayApts = this.data.appointments.filter(a => a.date === today);
                
                document.getElementById('dash-today-count').innerText = todayApts.length;
                document.getElementById('dash-total-patients').innerText = this.data.patients.length;
                document.getElementById('dash-pending').innerText = this.data.appointments.filter(a => a.status === 'Pendente').length;
                
                // Calc Revenue Month
                const currentMonth = new Date().getMonth();
                const revenue = this.data.transactions
                    .filter(t => t.type === 'entrada' && new Date(t.date).getMonth() === currentMonth)
                    .reduce((acc, curr) => acc + parseFloat(curr.value), 0);
                
                document.getElementById('dash-revenue').innerText = `R$ ${revenue.toFixed(2)}`;

                // Next Appointments List
                const list = document.getElementById('dash-next-appointments');
                list.innerHTML = '';
                todayApts.slice(0, 5).forEach(apt => {
                    const p = this.data.patients.find(pt => pt.id == apt.patientId);
                    list.innerHTML += `
                        <li class="flex justify-between border-b pb-2">
                            <div><span class="font-bold text-blue-600">${apt.time}</span> - ${p ? p.name : 'Desconhecido'}</div>
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">${apt.procedure}</span>
                        </li>
                    `;
                });
            },

            // --- 4. AGENDA ---
            renderAgenda() {
                const date = document.getElementById('agendaDate').value;
                const tbody = document.getElementById('agendaTableBody');
                tbody.innerHTML = '';

                const appts = this.data.appointments.filter(a => a.date === date).sort((a,b) => a.time.localeCompare(b.time));

                if(appts.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Sem agendamentos.</td></tr>';

                appts.forEach(apt => {
                    const p = this.data.patients.find(pt => pt.id == apt.patientId);
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">${apt.time}</td>
                            <td class="p-3 font-medium">${p ? p.name : 'Excluído'}</td>
                            <td class="p-3">${apt.procedure}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-xs ${apt.status === 'Concluído' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${apt.status}</span></td>
                            <td class="p-3 flex gap-2">
                                <button onclick="app.updateAppointmentStatus(${apt.id}, 'Concluído')" class="text-green-600" title="Concluir"><i class="fas fa-check"></i></button>
                                <button onclick="app.openWhatsApp('${p ? p.phone : ''}', '${apt.date}', '${apt.time}')" class="text-green-500" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
                                <button onclick="app.deleteAppointment(${apt.id})" class="text-red-500"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            },
            
            saveAppointment(e) {
                e.preventDefault();
                const pId = document.getElementById('aptPatient').value;
                const date = document.getElementById('aptDate').value;
                const time = document.getElementById('aptTime').value;
                const proc = document.getElementById('aptProc').value;

                this.data.appointments.push({
                    id: Date.now(),
                    patientId: parseInt(pId),
                    date, time, procedure: proc,
                    status: 'Pendente'
                });
                this.save();
                this.closeModal('appointmentModal');
                this.renderAgenda();
            },

            // --- 5. PATIENTS ---
            renderPatientList() {
                const term = document.getElementById('patientSearch').value.toLowerCase();
                const tbody = document.getElementById('patientListBody');
                tbody.innerHTML = '';

                this.data.patients
                    .filter(p => p.name.toLowerCase().includes(term) || p.cpf.includes(term))
                    .forEach(p => {
                        tbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="app.openPatientDetails(${p.id})">
                                <td class="p-4 font-medium">${p.name}</td>
                                <td class="p-4">${p.phone}</td>
                                <td class="p-4 text-gray-500 text-sm">Ver Histórico</td>
                                <td class="p-4 text-right"><i class="fas fa-chevron-right text-gray-400"></i></td>
                            </tr>
                        `;
                    });
            },

            openPatientModal() {
                const name = prompt("Nome do Paciente:");
                if(name) {
                    const newP = {
                        id: Date.now(), name, phone: '', cpf: '', 
                        anamnese: '', odontogram: {}, evolution: [], createdAt: new Date().toISOString()
                    };
                    this.data.patients.push(newP);
                    this.save();
                    this.openPatientDetails(newP.id);
                }
            },

            // --- 6. PATIENT DETAILS & ODONTOGRAM ---
            openPatientDetails(id) {
                this.currentPatientId = id;
                const p = this.data.patients.find(pt => pt.id === id);
                if(!p) return;

                document.getElementById('prontuarioName').innerText = p.name;
                this.router('prontuario');
                this.switchTab('tab-dados');

                // Populate Forms
                const formHtml = `
                    <div><label class="text-xs text-gray-500">Nome Completo</label><input id="pd-name" value="${p.name}" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-gray-500">CPF</label><input id="pd-cpf" value="${p.cpf || ''}" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-gray-500">Telefone</label><input id="pd-phone" value="${p.phone || ''}" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-gray-500">E-mail</label><input id="pd-email" value="${p.email || ''}" class="w-full border p-2 rounded"></div>
                    <div class="col-span-2"><label class="text-xs text-gray-500">Endereço</label><input id="pd-address" value="${p.address || ''}" class="w-full border p-2 rounded"></div>
                `;
                document.getElementById('patientDetailsForm').innerHTML = formHtml;
                document.getElementById('anamneseText').value = p.anamnese || '';

                this.renderOdontogram(p);
                this.renderEvolution(p);
                this.renderPatientFinance(p);
            },

            savePatientDetails() {
                const p = this.data.patients.find(pt => pt.id === this.currentPatientId);
                p.name = document.getElementById('pd-name').value;
                p.cpf = document.getElementById('pd-cpf').value;
                p.phone = document.getElementById('pd-phone').value;
                p.email = document.getElementById('pd-email').value;
                p.address = document.getElementById('pd-address').value;
                this.save();
                alert('Dados salvos!');
            },

            saveAnamnese() {
                const p = this.data.patients.find(pt => pt.id === this.currentPatientId);
                p.anamnese = document.getElementById('anamneseText').value;
                this.save();
                alert('Anamnese atualizada!');
            },

            // ODONTOGRAM LOGIC
            renderOdontogram(patient) {
                const container = document.getElementById('odontogramaRender');
                container.innerHTML = '';
                // Standard Tooth Numbering (ISO 3950)
                // 18-11, 21-28 (Upper)
                // 48-41, 31-38 (Lower)
                const teethOrder = [
                    18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28,
                    48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38
                ];

                teethOrder.forEach(num => {
                    const statusVal = patient.odontogram[num] || 0; 
                    // 0:Healthy, 1:Caries, 2:Restored, 3:Canal, 4:Implant, 5:Missing
                    const statusClasses = [
                        'status-saudavel', 'status-carie', 'status-restaurado', 
                        'status-canal', 'status-implante', 'status-ausente'
                    ];
                    const icon = num >= 40 || (num >= 30 && num < 40) ? 'fa-sort-up' : 'fa-sort-down'; // Simple visual distinction

                    const div = document.createElement('div');
                    div.className = `tooth ${statusClasses[statusVal]}`;
                    div.innerHTML = `
                        <span class="text-xs text-gray-400 block">${num}</span>
                        <i class="fas fa-tooth text-2xl"></i>
                    `;
                    div.onclick = () => {
                        let nextStatus = (statusVal + 1) % 6;
                        patient.odontogram[num] = nextStatus;
                        this.save();
                        this.renderOdontogram(patient); // Re-render
                    };
                    container.appendChild(div);
                });
            },

            // EVOLUTION (SOAP)
            addEvolution() {
                const text = document.getElementById('newEvolutionNote').value;
                if(!text) return;
                const p = this.data.patients.find(pt => pt.id === this.currentPatientId);
                p.evolution.unshift({
                    date: new Date().toLocaleString(),
                    note: text
                });
                this.save();
                document.getElementById('newEvolutionNote').value = '';
                this.renderEvolution(p);
            },

            renderEvolution(p) {
                const timeline = document.getElementById('evolutionTimeline');
                timeline.innerHTML = '';
                p.evolution.forEach(evo => {
                    timeline.innerHTML += `
                        <div class="relative pb-4">
                            <div class="absolute -left-6 mt-1 w-4 h-4 bg-blue-600 rounded-full"></div>
                            <p class="text-xs text-gray-500">${evo.date}</p>
                            <p class="text-gray-800 mt-1 bg-gray-50 p-3 rounded">${evo.note}</p>
                        </div>
                    `;
                });
            },

            // --- 7. FINANCEIRO ---
            openTransactionModal(type) {
                const desc = prompt("Descrição:");
                const val = parseFloat(prompt("Valor (ex: 150.00):"));
                if(desc && !isNaN(val)) {
                    this.data.transactions.push({
                        id: Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        type,
                        description: desc,
                        value: val
                    });
                    this.save();
                    this.router('financeiro');
                    this.renderFinanceTable();
                }
            },

            renderFinanceTable() {
                const tbody = document.getElementById('financeTableBody');
                tbody.innerHTML = '';
                this.data.transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-4">${t.date}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-xs ${t.type === 'entrada' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.type.toUpperCase()}</span></td>
                            <td class="p-4">${t.description}</td>
                            <td class="p-4 font-bold ${t.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">R$ ${t.value.toFixed(2)}</td>
                        </tr>
                    `;
                });
            },

            renderPatientFinance(p) {
                // Filter global transactions linked to this patient (Logic simplified: matching by name in desc or manual link needed in real app)
                // For demo, we just show empty or placeholder. Ideally, link Transaction ID to Patient ID.
                document.getElementById('patientFinanceList').innerHTML = `<tr><td colspan="4" class="p-2 text-gray-400 italic">Integração com módulo financeiro pendente nesta demo.</td></tr>`;
            },
            
            renderFinanceChart() {
                const ctx = document.getElementById('financeChart').getContext('2d');
                // Simple calculation per month
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const values = new Array(12).fill(0);
                
                this.data.transactions.filter(t => t.type === 'entrada').forEach(t => {
                    const m = new Date(t.date).getMonth();
                    values[m] += parseFloat(t.value);
                });

                if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Receita (R$)',
                            data: values,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true }
                });
            },

            // --- 8. ESTOQUE ---
            openStockModal() {
                const name = prompt("Nome do Produto:");
                const qtd = parseInt(prompt("Quantidade Atual:"));
                if(name && !isNaN(qtd)) {
                    this.data.inventory.push({ id: Date.now(), name, qtd, min: 5 });
                    this.save();
                    this.renderStock();
                }
            },

            renderStock() {
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = '';
                this.data.inventory.forEach(item => {
                    const status = item.qtd <= item.min ? '<span class="text-red-500 font-bold">Baixo</span>' : '<span class="text-green-500">OK</span>';
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-4">${item.name}</td>
                            <td class="p-4 font-bold">${item.qtd}</td>
                            <td class="p-4">${item.min}</td>
                            <td class="p-4">${status}</td>
                            <td class="p-4">
                                <button onclick="app.updateStock(${item.id}, 1)" class="px-2 bg-green-100 rounded">+</button>
                                <button onclick="app.updateStock(${item.id}, -1)" class="px-2 bg-red-100 rounded">-</button>
                            </td>
                        </tr>
                    `;
                });
            },
            
            updateStock(id, change) {
                const item = this.data.inventory.find(i => i.id === id);
                if(item) {
                    item.qtd += change;
                    if(item.qtd < 0) item.qtd = 0;
                    this.save();
                    this.renderStock();
                }
            },

            // --- 9. UTILS & HELPERS ---
            openModal(id) {
                document.getElementById(id).classList.remove('hidden');
                // Populate Patient Select
                const sel = document.getElementById('aptPatient');
                sel.innerHTML = '';
                this.data.patients.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = p.name;
                    sel.appendChild(opt);
                });
            },
            
            closeModal(id) { document.getElementById(id).classList.add('hidden'); },

            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-section'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('border-blue-600', 'text-blue-600');
                    el.classList.add('border-transparent', 'text-gray-500');
                });
                
                document.getElementById(tabId).classList.remove('hidden-section');
                // Highlight Button logic (simplified selector for demo)
                event.target.classList.remove('border-transparent', 'text-gray-500');
                event.target.classList.add('border-blue-600', 'text-blue-600');
            },

            openWhatsApp(phone, date, time) {
                if(!phone) return alert('Paciente sem telefone cadastrado.');
                // Remove non-numeric
                const num = phone.replace(/\D/g, '');
                const msg = `Olá! Confirmando sua consulta odontológica para dia ${date.split('-').reverse().join('/')} às ${time}. Podemos confirmar?`;
                window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
            },

            // --- 10. BACKUP SYSTEM ---
            exportData() {
                const dataStr = JSON.stringify(this.data);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `backup_odonto_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            },

            importData(input) {
                const file = input.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(confirm('Isso irá substituir todos os dados atuais pelos do backup. Tem certeza?')) {
                            this.data = json;
                            this.save();
                            alert('Backup restaurado com sucesso!');
                            location.reload();
                        }
                    } catch(err) {
                        alert('Erro ao ler arquivo de backup.');
                    }
                };
                reader.readAsText(file);
            },

            resetSystem() {
                if(confirm('ATENÇÃO: Isso apagará TUDO! Tem certeza?')) {
                    localStorage.removeItem('odontoFlowData');
                    location.reload();
                }
            }
        };

        // Start App
        app.init();
        // Pre-load some views
        app.renderPatientList();
        app.renderFinanceTable();
        app.renderStock();
    </script>
</body>
</html>