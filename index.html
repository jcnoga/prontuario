<!--
Prontuário Eletrônico Premium — single-file index.html (Firestore)
Licença: MIT-like
git commit -m "Add single-file Prontuario Eletronico Premium (firestore) — initial"
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prontuário Eletrônico Premium — Single File</title>

  <!-- Bibliotecas via CDN -->
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- FileSaver.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Interact.js for drag/drop -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <!-- dayjs -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>

  <style>
    body { padding-top: 100px; }
    #top-banner { position: fixed; top: 0; left: 0; right: 0; z-index: 1050; }
    .demo-badge { font-weight:700; color: #fff; background:#dc3545; padding: 6px 10px; border-radius:6px;}
    .connected-badge { font-weight:700; color:#fff; background:#198754; padding: 6px 10px; border-radius:6px;}
    .cursor-drag { cursor: grab; }
    .file-preview { max-width: 140px; max-height:120px; display:block; }
    .quill-editor { height: 200px; }
    .tooltip-i { cursor: help; color:#0d6efd; }
    .dark-theme { background:#1e1e1e; color:#eaeaea; }
  </style>
</head>
<body>
  <!-- Top banner: DEMO or FIRESTORE -->
  <div id="top-banner" class="p-2 shadow-sm bg-light">
    <div class="container d-flex justify-content-between align-items-center">
      <div>
        <span id="app-title" class="h5 mb-0">Prontuário Eletrônico Premium</span>
        <span id="mode-badge" class="ms-3 demo-badge">DEMO MODE</span>
        <span id="org-badge" class="ms-2 badge bg-secondary">Org: —</span>
      </div>
      <div>
        <button id="btn-toggle-theme" class="btn btn-outline-secondary btn-sm me-2" title="Alternar tema">Tema</button>
        <button id="btn-open-readme" class="btn btn-outline-primary btn-sm me-2"><i class="fa fa-book"></i> README</button>
        <button id="btn-clear-data" class="btn btn-outline-danger btn-sm me-2"><i class="fa fa-trash"></i> Recarregar Seeds</button>
        <span id="user-info" class="ms-2">—</span>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Onboarding / Login -->
    <div id="onboarding" class="card mb-4">
      <div class="card-body">
        <h5>Bem-vindo ao Prontuário</h5>
        <p class="mb-1">Este arquivo é single-file pronto para GitHub Pages. Cole seu firebaseConfig (veja README) ou opere em DEMO MODE.</p>

        <div id="firebase-config-area" class="mb-3">
          <label class="form-label">Firebase Config (JSON) — cole seu firebaseConfig aqui (opcional para demo)</label>
          <textarea id="firebaseConfigInput" class="form-control" rows="3" placeholder='{"apiKey": "...", "authDomain": "...", "projectId": "...", "storageBucket": "...", "messagingSenderId": "...", "appId": "..."}'></textarea>
          <div class="form-text">Após colar, clique em "Inicializar Firebase". Se ficar sem config, o app entra em DEMO MODE.</div>
          <div class="mt-2">
            <button id="btn-init-firebase" class="btn btn-success btn-sm">Inicializar Firebase</button>
            <button id="btn-enable-demo" class="btn btn-danger btn-sm">Ativar DEMO MODE</button>
            <button id="btn-seed-demo" class="btn btn-secondary btn-sm">Recarregar Seeds (demo)</button>
          </div>
        </div>

        <hr />

        <div class="row">
          <div class="col-md-6">
            <h6>Autenticação</h6>
            <div id="auth-area">
              <div id="auth-forms">
                <input id="email" class="form-control mb-2" placeholder="E-mail">
                <input id="password" type="password" class="form-control mb-2" placeholder="Senha">
                <div class="d-flex gap-2">
                  <button id="btn-login" class="btn btn-primary">Entrar (Email)</button>
                  <button id="btn-google" class="btn btn-outline-primary"><i class="fa fa-google"></i> Google</button>
                  <button id="btn-demo-login" class="btn btn-outline-secondary">Entrar (Demo User)</button>
                </div>
                <a href="#" id="btn-reset-password" class="d-block mt-2">Esqueci minha senha</a>
              </div>
              <div id="auth-status" class="mt-2"></div>
            </div>
          </div>

          <div class="col-md-6">
            <h6>Export / Import / Backup</h6>
            <div class="d-flex gap-2 mb-2">
              <button id="btn-export-json" class="btn btn-outline-success btn-sm"><i class="fa fa-download"></i> Export JSON</button>
              <button id="btn-import-json" class="btn btn-outline-secondary btn-sm"><i class="fa fa-upload"></i> Import JSON</button>
              <input type="file" id="importFileInput" style="display:none"/>
            </div>
            <div class="mb-2">
              <button id="btn-export-org" class="btn btn-warning btn-sm">Exportar dados da organização</button>
              <button id="btn-clear-all" class="btn btn-danger btn-sm">Limpar tudo</button>
            </div>
            <div>
              <small class="text-muted">Em modo real, export consulta Firestore. Em DEMO, exporta memória.</small>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Main UI: Tabs -->
    <div id="main-ui" style="display:none">
      <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-patients">Pacientes</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-evolutions">Evoluções</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-appointments">Agenda</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-team">Equipe</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-audit">Audit Logs</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-billing">Billing (Mock)</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-readme">README</a></li>
      </ul>

      <div class="tab-content">
        <div id="tab-dashboard" class="tab-pane fade show active">
          <div class="row">
            <div class="col-md-8">
              <div class="card mb-3">
                <div class="card-body">
                  <h5>Visão Geral</h5>
                  <canvas id="chartVisits"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <h6>Últimas Evoluções</h6>
                  <ul id="recent-evolutions" class="list-group"></ul>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>Indicadores</h6>
                  <p id="indicator-counts"></p>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <h6>Glossário</h6>
                  <ul id="glossary-list"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-patients" class="tab-pane fade">
          <div class="d-flex justify-content-between mb-2">
            <div>
              <input id="patient-search" class="form-control" placeholder="Pesquisar por nome, CPF, tag..." />
            </div>
            <div>
              <button id="btn-new-patient" class="btn btn-primary"><i class="fa fa-user-plus"></i> Novo Paciente</button>
              <div class="btn-group">
                <button id="btn-import-csv" class="btn btn-outline-secondary">Import CSV</button>
                <button id="btn-export-csv" class="btn btn-outline-success">Export CSV</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <table class="table table-sm" id="patients-table">
                <thead><tr><th>Nome</th><th>CPF</th><th>Data Nasc</th><th>Tags</th><th>Ações</th></tr></thead>
                <tbody></tbody>
              </table>
              <nav><ul class="pagination" id="patients-pagination"></ul></nav>
            </div>
          </div>
        </div>

        <div id="tab-evolutions" class="tab-pane fade">
          <div class="d-flex justify-content-between mb-2">
            <h6>Evoluções</h6>
            <button id="btn-new-evolution" class="btn btn-sm btn-primary">Nova Evolução</button>
          </div>
          <div class="card">
            <div class="card-body">
              <div id="evolutions-list"></div>
            </div>
          </div>
        </div>

        <div id="tab-appointments" class="tab-pane fade">
          <div class="d-flex justify-content-between mb-2">
            <h6>Agenda</h6>
            <div>
              <button id="btn-new-appointment" class="btn btn-sm btn-primary">Novo</button>
              <button id="btn-view-week" class="btn btn-sm btn-outline-secondary">Semana</button>
              <button id="btn-view-day" class="btn btn-sm btn-outline-secondary">Dia</button>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div id="calendar-area">
                <!-- Simple calendar placeholder; for production integrate FullCalendar -->
                <ul id="appointments-list" class="list-group"></ul>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-team" class="tab-pane fade">
          <div class="d-flex justify-content-between mb-2">
            <h6>Gerenciamento de Equipe</h6>
            <button id="btn-add-user" class="btn btn-sm btn-primary">Criar Usuário</button>
          </div>
          <div class="card">
            <div class="card-body">
              <table class="table table-sm" id="users-table">
                <thead><tr><th>Nome</th><th>Email</th><th>Role</th><th>Ações</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-audit" class="tab-pane fade">
          <h6>Audit Logs</h6>
          <div class="card">
            <div class="card-body">
              <button id="btn-export-audit" class="btn btn-sm btn-outline-success mb-2">Exportar Audit Logs</button>
              <ul id="audit-list" class="list-group"></ul>
            </div>
          </div>
        </div>

        <div id="tab-billing" class="tab-pane fade">
          <h6>Billing (Mock)</h6>
          <div class="card">
            <div class="card-body">
              <p>Planos mock: free / pro / enterprise</p>
              <button id="btn-start-trial" class="btn btn-sm btn-outline-primary">Iniciar Trial 30 dias</button>
              <div id="billing-info" class="mt-2"></div>
            </div>
          </div>
        </div>

        <div id="tab-readme" class="tab-pane fade">
          <div class="card">
            <div class="card-body">
              <h5>README embutido</h5>
              <div id="readme-content"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="patientModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="patientForm">
            <div class="modal-header">
              <h5 class="modal-title">Paciente</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="patient-id" />
              <div class="mb-2">
                <label>Nome <i class="fa fa-info-circle tooltip-i" title="Nome completo do paciente"></i></label>
                <input id="patient-nome" class="form-control" required />
              </div>
              <div class="mb-2 row">
                <div class="col"><label>CPF</label><input id="patient-cpf" class="form-control" /></div>
                <div class="col"><label>Data Nasc</label><input id="patient-datanasc" type="date" class="form-control" /></div>
                <div class="col"><label>Sexo</label><select id="patient-sexo" class="form-control"><option></option><option value="M">M</option><option value="F">F</option></select></div>
              </div>
              <div class="mb-2"><label>Tags (vírgula)</label><input id="patient-tags" class="form-control" /></div>
              <div class="mb-2"><label>Observações Privadas</label><textarea id="patient-obs" class="form-control"></textarea></div>
              <div class="mb-2"><label>Consentimento LGPD</label>
                <div class="form-check">
                  <input id="patient-consent" class="form-check-input" type="checkbox">
                  <label class="form-check-label">Aceito uso de dados</label>
                </div>
              </div>
              <div class="alert alert-warning small">Campos obrigatórios: Nome. Validações adicionais podem ser habilitadas em produção.</div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Salvar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Evolution editor modal -->
    <div class="modal fade" id="evolutionModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <form id="evolutionForm">
            <div class="modal-header">
              <h5 class="modal-title">Evolução</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="evolution-id" />
              <div class="mb-2">
                <label>Paciente</label>
                <select id="evolution-patient" class="form-select"></select>
              </div>
              <div class="mb-2">
                <label>Anamnese</label>
                <div id="quill-anamnese" class="quill-editor"></div>
              </div>
              <div class="mb-2">
                <label>Plano</label>
                <div id="quill-plano" class="quill-editor"></div>
              </div>
              <div>
                <label>Anexos</label>
                <input id="evolution-files" type="file" multiple />
                <div id="evolution-files-list" class="mt-2"></div>
              </div>
              <div class="form-check mt-2">
                <input id="evolution-sign" type="checkbox" class="form-check-input">
                <label class="form-check-label">Assinar visualmente (salva imagem)</label>
              </div>
              <div id="signature-canvas-area" style="display:none" class="mt-2">
                <canvas id="signature-canvas" width="600" height="120" style="border:1px solid #ccc"></canvas>
                <div><button id="clear-signature" class="btn btn-sm btn-danger mt-1">Limpar</button></div>
              </div>
              <div class="alert alert-info mt-2">Antes de salvar, o sistema criará uma versão em evolution_versions. Versões ficam acessíveis na UI.</div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Salvar Evolução</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts: Firebase modular SDKs via CDN (imports in module below) -->
  <script type="module">
  /* -------------------------------------------------------
     Notas importantes (Leia este comentário):
     - Cole seu firebaseConfig no textarea acima e clique em "Inicializar Firebase".
     - Ou clique em "Ativar DEMO MODE" para operar offline em memória.
     - Este arquivo usa as SDKs modulares do Firebase via CDN (imports abaixo).
     - Mantenha este arquivo como single-file para GitHub Pages.
     - Para migrar para backend: ver README embutido (guia para Cloud Functions/Admin SDK).
     ------------------------------------------------------- */

  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

  // App state
  const state = {
    firebaseApp: null,
    auth: null,
    db: null,
    storage: null,
    isDemo: true,
    demoData: {
      organizations: {},
      users: {},
      patients: {},
      evolutions: {},
      evolution_versions: {},
      appointments: {},
      files: {},
      audit_logs: {},
      billing_plans: {},
      billing_subscriptions: {},
      settings: {}
    },
    currentUser: null, // { uid, name, role, organizationId }
    loadedUsersCache: {},
    currentOrgId: null
  };

  /* ---------------------
     Helper: UUID generator (simple)
     --------------------- */
  function uid(prefix='id') {
    return prefix + '_' + Math.random().toString(36).slice(2, 11);
  }

  /* =========================
     1) Inicialização & helpers Firebase
     ========================= */

  // initFirebase(config) → inicializa Firebase (Auth, Firestore, Storage).
  async function initFirebase(config) {
    if (!config || !config.apiKey) {
      console.warn('firebaseConfig inválido');
      return false;
    }
    try {
      // evita reinicialização
      if (getApps().length === 0) {
        state.firebaseApp = initializeApp(config);
      } else {
        state.firebaseApp = getApps()[0];
      }
      state.auth = getAuth(state.firebaseApp);
      state.db = getFirestore(state.firebaseApp);
      state.storage = getStorage(state.firebaseApp);
      state.isDemo = false;
      updateModeBanner();
      await ensureSeedsIfEmpty();
      setupAuthListener();
      console.log('Firebase inicializado');
      return true;
    } catch (err) {
      console.error('Erro initFirebase', err);
      return false;
    }
  }

  // isFirebaseConfigured() → detecta se o config foi preenchido.
  function isFirebaseConfigured() {
    return state.firebaseApp !== null && !state.isDemo;
  }

  // enableDemoMode() → inicializa dados em memória (seed).
  function enableDemoMode() {
    state.isDemo = true;
    state.firebaseApp = null;
    state.auth = null;
    state.db = null;
    state.storage = null;
    seedDemoData();
    updateModeBanner();
    setupAuthListener(); // listener fake
    showMainUI();
  }

  // seedDemoData() → cria 1 org, 2 users, 5 patients, 6 evolutions, 5 appointments (apenas em demo).
  function seedDemoData() {
    // Limpa demo
    state.demoData = {
      organizations: {}, users: {}, patients: {}, evolutions: {}, evolution_versions: {},
      appointments: {}, files: {}, audit_logs: {}, billing_plans: {}, billing_subscriptions: {}, settings: {}
    };
    // Organization
    const orgId = uid('org');
    state.demoData.organizations[orgId] = { id: orgId, name: 'Clínica Demo', ownerUid: 'user_owner', settings: {} };
    // Users
    const ownerUid = 'user_owner';
    state.demoData.users[ownerUid] = { uid: ownerUid, name: 'Dono Demo', email: 'owner@demo.local', role: 'owner', organizationId: orgId, createdAt: new Date().toISOString() };
    const profUid = 'user_prof';
    state.demoData.users[profUid] = { uid: profUid, name: 'Profissional Demo', email: 'prof@demo.local', role: 'professional', organizationId: orgId, createdAt: new Date().toISOString() };

    // Patients
    for (let i=1;i<=5;i++){
      const pid = uid('p');
      state.demoData.patients[pid] = {
        id: pid,
        organizationId: orgId,
        nome: `Paciente ${i}`,
        cpf: `000.000.000-0${i}`,
        data_nasc: dayjs().subtract(20+i, 'year').format('YYYY-MM-DD'),
        sexo: i%2===0 ? 'F' : 'M',
        telefone: '',
        email: '',
        endereco: '',
        emergencia: '',
        alergias: '',
        historico: '',
        tags: i%2===0 ? ['crônico'] : ['novo'],
        observacoes_privadas: '',
        status: 'active',
        consentimento: { accepted: true, byUid: ownerUid, timestamp: new Date().toISOString() }
      };
    }

    // Evolutions (6)
    const pIds = Object.keys(state.demoData.patients);
    for (let i=0;i<6;i++){
      const eid = uid('evo');
      const pid = pIds[i % pIds.length];
      state.demoData.evolutions[eid] = {
        id: eid,
        patientId: pid,
        organizationId: orgId,
        profissionalId: profUid,
        data: new Date().toISOString(),
        tipo: 'consulta',
        anamnese: `Anamnese demo ${i+1}`,
        exames: '',
        sinais_vitais: '',
        plano: `Plano ${i+1}`,
        metas: '',
        attachments: [],
        signedByUid: null,
        signedAt: null
      };
      // version snapshot
      state.demoData.evolution_versions[uid('evv')] = { id: uid('evv'), evolutionId: eid, timestamp: new Date().toISOString(), userUid: ownerUid, content: { anamnese: `Anamnese demo ${i+1}` } };
    }

    // Appointments (5)
    const today = dayjs();
    const profs = [profUid];
    for (let i=0;i<5;i++){
      const apId = uid('ap');
      const pid = pIds[i % pIds.length];
      const start = today.add(i, 'day').hour(9 + (i%4)).minute(0).second(0).toISOString();
      state.demoData.appointments[apId] = {
        id: apId,
        patientId: pid,
        professionalId: profs[0],
        start,
        end: dayjs(start).add(45,'minute').toISOString(),
        duration: 45,
        room: 'Sala 1',
        status: 'scheduled',
        notes: '',
        organizationId: orgId
      };
    }

    // Audit log example
    state.demoData.audit_logs[uid('alog')] = { id: uid('alog'), userUid: ownerUid, action: 'seed', collection: 'system', docId: null, payload: { note: 'seed demo' }, timestamp: new Date().toISOString(), userAgent: navigator.userAgent, ip_simulated: '127.0.0.1' };

    state.currentOrgId = orgId;
    console.log('Seeds carregadas (demo).');
    renderPatientsTable();
    renderUsersTable();
    renderAppointments();
    renderDashboard();
    renderAuditLogs();
    showMainUI();
  }

  // exportFirestoreToJSON() / importJSONToFirestore() — versão básica
  async function exportFirestoreToJSON() {
    if (state.isDemo) {
      const blob = new Blob([JSON.stringify(state.demoData, null, 2)], { type: 'application/json' });
      saveAs(blob, `export_demo_${new Date().toISOString().slice(0,10)}.json`);
      return;
    }
    // Em modo real: consulta coleções relevantes
    const data = {};
    const colNames = ['organizations','users','patients','evolutions','appointments','files','audit_logs','billing_plans','billing_subscriptions','settings'];
    for (const name of colNames) {
      data[name] = [];
      const q = collection(state.db, name);
      try {
        const snaps = await getDocs(q);
        snaps.forEach(d => data[name].push({ id: d.id, ...d.data() }));
      } catch (err) {
        console.warn('Erro exportar collection', name, err);
      }
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    saveAs(blob, `export_${new Date().toISOString().slice(0,10)}.json`);
  }

  async function importJSONToFirestore(file) {
    if (!file) return;
    const text = await file.text();
    const parsed = JSON.parse(text);
    if (state.isDemo) {
      state.demoData = parsed;
      renderPatientsTable();
      renderUsersTable();
      renderAppointments();
      renderDashboard();
      alert('Importado para demo memory.');
      return;
    }
    // Em real, grava documentos (atenção às regras: cuidado em produção)
    for (const [collectionName, items] of Object.entries(parsed)) {
      if (!Array.isArray(items)) continue;
      for (const item of items) {
        const id = item.id || uid(collectionName);
        const d = { ...item };
        delete d.id;
        try {
          await setDoc(doc(state.db, collectionName, id), d);
        } catch (err) {
          console.error('Erro import doc', collectionName, id, err);
        }
      }
    }
    alert('Import concluído (Firestore).');
  }

  // clearAllData() → reset com confirmação.
  async function clearAllData() {
    if (!confirm('Confirma limpar TODOS os dados da aplicação? Em modo real, esta ação tenta apagar várias collections (pode levar tempo).')) return;
    if (state.isDemo) {
      seedDemoData();
      alert('Demo repopulado.');
      return;
    }
    // Em produção, deletar documentos em client pode ser demorado; recomendar Cloud Function para limpeza segura.
    const collectionsToClear = ['patients','evolutions','appointments','files','users','audit_logs'];
    for (const colName of collectionsToClear) {
      const colRef = collection(state.db, colName);
      try {
        const snaps = await getDocs(colRef);
        for (const docSnap of snaps.docs) {
          await deleteDoc(doc(state.db, colName, docSnap.id));
        }
      } catch (err) {
        console.warn('Erro limpar collection', colName, err);
      }
    }
    alert('Tentativa de limpeza concluída. Verifique console para detalhes.');
  }

  /* ===================
     Auth listener and flows
     =================== */
  function setupAuthListener() {
    // In demo mode, we simulate a lightweight auth: currentUser set to owner demo
    if (state.isDemo) {
      state.currentUser = Object.values(state.demoData.users)[0] || null;
      if (state.currentUser) {
        state.currentUser.uid = state.currentUser.uid || state.currentUser.email || 'demo_user';
        state.currentUser.displayName = state.currentUser.name;
        document.getElementById('user-info').innerText = `${state.currentUser.name} (${state.currentUser.role})`;
        state.currentOrgId = state.currentUser.organizationId;
        updateOrgBadge();
        showMainUI();
      }
      return;
    }

    if (!state.auth) return;
    onAuthStateChanged(state.auth, async (user) => {
      if (user) {
        const uid = user.uid;
        // carregar users/{uid}
        try {
          const docSnap = await getDoc(doc(state.db, 'users', uid));
          if (docSnap.exists()) {
            const userdata = docSnap.data();
            state.currentUser = { uid, name: userdata.name || user.displayName || user.email, role: userdata.role || 'viewer', organizationId: userdata.organizationId || null };
          } else {
            // criar usuário mínimo
            const newUserDoc = { uid, name: user.displayName || user.email, email: user.email, role: 'viewer', organizationId: null, createdAt: new Date().toISOString() };
            await setDoc(doc(state.db, 'users', uid), newUserDoc);
            state.currentUser = { uid, name: newUserDoc.name, role: 'viewer', organizationId: null };
          }
          document.getElementById('user-info').innerText = `${state.currentUser.name} (${state.currentUser.role})`;
          state.currentOrgId = state.currentUser.organizationId;
          updateOrgBadge();
          showMainUI();
        } catch (err) {
          console.error('Erro carregar user doc', err);
        }
      } else {
        // signed out
        state.currentUser = null;
        document.getElementById('user-info').innerText = '—';
        // show onboarding
        document.getElementById('main-ui').style.display = 'none';
      }
    });
  }

  // Login flows
  async function loginEmail(email, password) {
    if (state.isDemo) {
      // cria usuário demo simples
      const uidDemo = uid('user');
      const user = { uid: uidDemo, name: 'Usuário Demo', email, role: 'professional', organizationId: state.currentOrgId || Object.keys(state.demoData.organizations)[0], createdAt: new Date().toISOString() };
      state.demoData.users[uidDemo] = user;
      state.currentUser = user;
      document.getElementById('user-info').innerText = `${user.name} (${user.role})`;
      showMainUI();
      return;
    }
    try {
      await signInWithEmailAndPassword(state.auth, email, password);
    } catch (err) {
      alert('Erro login: ' + err.message);
    }
  }

  async function loginGoogle() {
    if (state.isDemo) {
      // criar usuário simulado
      const uidDemo = uid('user');
      const user = { uid: uidDemo, name: 'Google Demo', email: 'guser@demo.local', role: 'professional', organizationId: state.currentOrgId || Object.keys(state.demoData.organizations)[0], createdAt: new Date().toISOString() };
      state.demoData.users[uidDemo] = user;
      state.currentUser = user;
      document.getElementById('user-info').innerText = `${user.name} (${user.role})`;
      showMainUI();
      return;
    }
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(state.auth, provider);
    } catch (err) {
      // Instrução passo-a-passo se OAuth não estiver ativado
      alert('Erro Google SignIn. Se estiver usando Firebase real, verifique console: faça Login > Autenticação > Provedores de Login > Ativar Google e configurar credenciais OAuth.');
      console.error(err);
    }
  }

  async function logout() {
    if (state.isDemo) {
      state.currentUser = null;
      setupAuthListener();
      return;
    }
    await signOut(state.auth);
  }

  async function resetPassword(email) {
    if (state.isDemo) {
      alert('Modo DEMO: mostrar instruções. Em produção, use sendPasswordResetEmail no Firebase Auth.');
      return;
    }
    try {
      await sendPasswordResetEmail(state.auth, email);
      alert('E-mail de reset enviado.');
    } catch (err) {
      alert('Erro: ' + err.message);
    }
  }

  /* ===========================
     RBAC (verificações) — client-side
     roles: owner, admin_clinic, professional, reception, viewer
     =========================== */
  function canPerform(action) {
    const role = state.currentUser?.role || 'viewer';
    const rules = {
      'patient:create': ['owner','admin_clinic','professional','reception'],
      'patient:read': ['owner','admin_clinic','professional','reception','viewer'],
      'patient:update': ['owner','admin_clinic','professional'],
      'patient:delete': ['owner','admin_clinic'],
      'evolution:create': ['owner','admin_clinic','professional'],
      'evolution:edit': ['owner','admin_clinic','professional'],
      'evolution:sign': ['owner','admin_clinic','professional'],
      'export': ['owner','admin_clinic'],
      'billing:manage': ['owner']
    };
    const allowed = rules[action] || [];
    const ok = allowed.includes(role);
    if (!ok) {
      registerAudit({ action: 'forbidden_attempt', collection: action, docId: null, payload: { attemptedBy: state.currentUser?.uid } });
    }
    return ok;
  }

  /* ===========================
     CRUD Pacientes (demo & firestore)
     =========================== */

  async function createOrUpdatePatient(payload) {
    if (!canPerform(payload.id ? 'patient:update' : 'patient:create')) return alert('Sem permissão');
    if (state.isDemo) {
      const id = payload.id || uid('p');
      payload.id = id;
      state.demoData.patients[id] = payload;
      registerAudit({ action: payload.id ? 'patient:update' : 'patient:create', collection: 'patients', docId: id, payload });
      renderPatientsTable();
      return id;
    }
    // Firestore
    const id = payload.id || uid('p');
    const docRef = doc(state.db, 'patients', id);
    await setDoc(docRef, payload);
    registerAudit({ action: payload.id ? 'patient:update' : 'patient:create', collection: 'patients', docId: id, payload });
    renderPatientsTable();
    return id;
  }

  async function deletePatient(id) {
    if (!canPerform('patient:delete')) return alert('Sem permissão');
    if (state.isDemo) {
      delete state.demoData.patients[id];
      registerAudit({ action: 'patient:delete', collection: 'patients', docId: id, payload: {} });
      renderPatientsTable();
      return;
    }
    try {
      await deleteDoc(doc(state.db, 'patients', id));
      registerAudit({ action: 'patient:delete', collection: 'patients', docId: id, payload: {} });
      renderPatientsTable();
    } catch (err) {
      console.error('Erro deletar paciente', err);
      alert('Erro ao deletar paciente.');
    }
  }

  function renderPatientsTable(page=1, perPage=10) {
    const tbody = document.querySelector('#patients-table tbody');
    tbody.innerHTML = '';
    const patients = state.isDemo ? Object.values(state.demoData.patients) : []; // in real, would query
    const filtered = (patients || []).filter(p => {
      const q = (document.getElementById('patient-search')?.value || '').toLowerCase();
      if (!q) return true;
      return (p.nome || '').toLowerCase().includes(q) || (p.cpf || '').toLowerCase().includes(q) || (p.tags||[]).join(',').toLowerCase().includes(q);
    });
    const pageItems = filtered.slice((page-1)*perPage, page*perPage);
    for (const p of pageItems) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.nome}</td><td>${p.cpf||''}</td><td>${p.data_nasc||''}</td><td>${(p.tags||[]).join(', ')}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary btn-view" data-id="${p.id}"><i class="fa fa-eye"></i></button>
          <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="${p.id}"><i class="fa fa-edit"></i></button>
          <button class="btn btn-sm btn-outline-danger btn-del" data-id="${p.id}"><i class="fa fa-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    }
    // pagination simple
    const pagination = document.getElementById('patients-pagination');
    pagination.innerHTML = '';
    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total/perPage));
    for (let i=1;i<=pages;i++){
      const li = document.createElement('li'); li.className = 'page-item' + (i===page ? ' active' : '');
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.onclick = (ev) => { ev.preventDefault(); renderPatientsTable(i, perPage); };
      pagination.appendChild(li);
    }

    // bind actions
    document.querySelectorAll('.btn-view').forEach(b => b.onclick = () => { viewPatient(b.dataset.id); });
    document.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => { editPatient(b.dataset.id); });
    document.querySelectorAll('.btn-del').forEach(b => b.onclick = () => {
      if (confirm('Confirma excluir paciente?')) deletePatient(b.dataset.id);
    });
  }

  function viewPatient(id) {
    const p = state.isDemo ? state.demoData.patients[id] : null;
    if (!p) return alert('Paciente não encontrado');
    // abrir modal em modo view
    editPatient(id, true);
  }

  function editPatient(id, readonly=false) {
    const p = state.isDemo ? (id ? state.demoData.patients[id] : null) : null;
    document.getElementById('patient-id').value = p ? p.id : '';
    document.getElementById('patient-nome').value = p ? p.nome : '';
    document.getElementById('patient-cpf').value = p ? p.cpf : '';
    document.getElementById('patient-datanasc').value = p ? p.data_nasc || '' : '';
    document.getElementById('patient-sexo').value = p ? p.sexo || '' : '';
    document.getElementById('patient-tags').value = p ? (p.tags||[]).join(',') : '';
    document.getElementById('patient-obs').value = p ? p.observacoes_privadas || '' : '';
    document.getElementById('patient-consent').checked = !!(p && p.consentimento && p.consentimento.accepted);
    var patientModal = new bootstrap.Modal(document.getElementById('patientModal'));
    patientModal.show();
  }

  document.getElementById('patientForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const id = document.getElementById('patient-id').value || undefined;
    const payload = {
      id,
      organizationId: state.currentOrgId,
      nome: document.getElementById('patient-nome').value,
      cpf: document.getElementById('patient-cpf').value,
      data_nasc: document.getElementById('patient-datanasc').value,
      sexo: document.getElementById('patient-sexo').value,
      tags: document.getElementById('patient-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      observacoes_privadas: document.getElementById('patient-obs').value,
      consentimento: { accepted: document.getElementById('patient-consent').checked, byUid: state.currentUser?.uid || 'system', timestamp: new Date().toISOString() },
      status: 'active'
    };
    const newId = await createOrUpdatePatient(payload);
    // fechar modal
    bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
  });

  /* ===========================
     Evolutions — Quill editor, versions, attachments
     =========================== */
  let quillAnamnese, quillPlano;
  function initQuills() {
    quillAnamnese = new Quill('#quill-anamnese', { theme: 'snow' });
    quillPlano = new Quill('#quill-plano', { theme: 'snow' });
  }

  async function openNewEvolution() {
    if (!canPerform('evolution:create')) return alert('Sem permissão');
    // populate patients select
    const select = document.getElementById('evolution-patient');
    select.innerHTML = '';
    const patients = state.isDemo ? Object.values(state.demoData.patients) : [];
    for (const p of patients) {
      const opt = document.createElement('option');
      opt.value = p.id; opt.text = p.nome;
      select.appendChild(opt);
    }
    quillAnamnese.setText('');
    quillPlano.setText('');
    document.getElementById('evolution-files-list').innerHTML = '';
    document.getElementById('evolution-id').value = '';
    bootstrap.Modal.getOrCreateInstance(document.getElementById('evolutionModal')).show();
  }

  document.getElementById('btn-new-evolution').addEventListener('click', openNewEvolution);

  document.getElementById('evolutionForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    if (!canPerform('evolution:create')) return alert('Sem permissão');
    const id = document.getElementById('evolution-id').value || uid('evo');
    const patientId = document.getElementById('evolution-patient').value;
    const payload = {
      id,
      patientId,
      organizationId: state.currentOrgId,
      profissionalId: state.currentUser?.uid || 'unknown',
      data: new Date().toISOString(),
      tipo: 'consulta',
      anamnese: quillAnamnese.root.innerHTML,
      plano: quillPlano.root.innerHTML,
      attachments: []
    };
    if (state.isDemo) {
      state.demoData.evolutions[id] = payload;
      // save version
      const verId = uid('evv');
      state.demoData.evolution_versions[verId] = { id: verId, evolutionId: id, timestamp: new Date().toISOString(), userUid: state.currentUser?.uid, content: { anamnese: payload.anamnese, plano: payload.plano } };
      registerAudit({ action: 'evolution:create', collection: 'evolutions', docId: id, payload });
      renderEvolutions();
      bootstrap.Modal.getOrCreateInstance(document.getElementById('evolutionModal')).hide();
      return;
    }

    // In real, upload attachments then setDoc
    await setDoc(doc(state.db, 'evolutions', id), payload);
    // save version
    await addDoc(collection(state.db, 'evolution_versions'), { evolutionId: id, timestamp: new Date().toISOString(), userUid: state.currentUser.uid, content: { anamnese: payload.anamnese, plano: payload.plano } });
    registerAudit({ action: 'evolution:create', collection: 'evolutions', docId: id, payload });
    renderEvolutions();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('evolutionModal')).hide();
  });

  function renderEvolutions() {
    const container = document.getElementById('evolutions-list');
    container.innerHTML = '';
    const evos = state.isDemo ? Object.values(state.demoData.evolutions || {}) : [];
    for (const e of evos) {
      const el = document.createElement('div');
      el.className = 'card mb-2';
      el.innerHTML = `<div class="card-body">
        <h6>${(state.demoData.patients[e.patientId]||{}).nome || e.patientId} <small class="text-muted"> - ${dayjs(e.data).format('YYYY-MM-DD HH:mm')}</small></h6>
        <div>${e.anamnese}</div>
        <div class="mt-2">${e.plano}</div>
      </div>`;
      container.appendChild(el);
    }
  }

  /* ===========================
     Files / Storage (demo & real)
     =========================== */
  async function uploadFileForPatient(file, patientId, evolutionId) {
    if (state.isDemo) {
      const fid = uid('file');
      state.demoData.files[fid] = { id: fid, filename: file.name, storagePath: 'demo://'+fid, contentType: file.type, size: file.size, uploadedBy: state.currentUser?.uid, patientId, evolutionId, createdAt: new Date().toISOString() };
      return state.demoData.files[fid];
    }
    // Real: upload to Storage and save metadata
    const fileId = uid('file');
    const path = `/orgs/${state.currentOrgId}/patients/${patientId}/files/${fileId}_${file.name}`;
    const sref = storageRef(state.storage, path);
    await uploadBytes(sref, file);
    const url = await getDownloadURL(sref);
    const meta = { id: fileId, filename: file.name, storagePath: path, contentType: file.type, size: file.size, uploadedBy: state.currentUser.uid, patientId, evolutionId, createdAt: new Date().toISOString(), downloadURL: url };
    await setDoc(doc(state.db, 'files', fileId), meta);
    return meta;
  }

  /* ===========================
     Appointments (simple list + drag/drop mock)
     =========================== */
  function renderAppointments() {
    const ul = document.getElementById('appointments-list');
    ul.innerHTML = '';
    const apps = state.isDemo ? Object.values(state.demoData.appointments || {}) : [];
    for (const a of apps) {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center cursor-drag';
      li.innerHTML = `<div><strong>${(state.demoData.patients[a.patientId]||{}).nome||a.patientId}</strong> — ${dayjs(a.start).format('YYYY-MM-DD HH:mm')} (${a.room})</div>
        <div><span class="badge bg-info">${a.status}</span></div>`;
      ul.appendChild(li);
    }

    // Bind simple drag behavior to simulate reschedule
    interact('.cursor-drag').draggable({
      listeners: {
        start (event) {},
        move (event) {
          const target = event.target;
          const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
          const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
          target.style.transform = `translate(${x}px, ${y}px)`;
          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);
        },
        end (event) {
          // on drop, register a mock reschedule attempt
          registerAudit({ action: 'appointment:drag', collection: 'appointments', docId: null, payload: { user: state.currentUser?.uid } });
        }
      }
    });
  }

  /* ===========================
     Audit Logs
     =========================== */
  function registerAudit({ action, collection: coll, docId, payload }) {
    const log = { id: uid('alog'), userUid: state.currentUser?.uid || 'system', action, collection: coll, docId, payload, timestamp: new Date().toISOString(), userAgent: navigator.userAgent, ip_simulated: '0.0.0.0' };
    if (state.isDemo) {
      state.demoData.audit_logs[log.id] = log;
      renderAuditLogs();
      return;
    }
    // real: write to firestore
    setDoc(doc(state.db, 'audit_logs', log.id), log).catch(err => console.error('Erro audit log', err));
  }

  function renderAuditLogs() {
    const ul = document.getElementById('audit-list');
    ul.innerHTML = '';
    const logs = state.isDemo ? Object.values(state.demoData.audit_logs || {}) : [];
    for (const l of logs.slice().reverse()) {
      const li = document.createElement('li');
      li.className = 'list-group-item small';
      li.innerText = `[${dayjs(l.timestamp).format('YYYY-MM-DD HH:mm')}] ${l.action} by ${l.userUid} — ${l.collection} ${l.docId || ''}`;
      ul.appendChild(li);
    }
  }

  /* ===========================
     Dashboard (Chart.js)
     =========================== */
  function renderDashboard() {
    const ctx = document.getElementById('chartVisits').getContext('2d');
    const visits = [12, 15, 9, 8, 20, 14, 18];
    new Chart(ctx, { type: 'bar', data: { labels: ['Seg','Ter','Qua','Qui','Sex','Sab','Dom'], datasets: [{ label: 'Atendimentos', data: visits, backgroundColor: '#0d6efd' }] }, options: {} });
    document.getElementById('indicator-counts').innerHTML = `
      <strong>Pacientes:</strong> ${Object.keys(state.isDemo ? state.demoData.patients : {}).length} <br/>
      <strong>Atendimentos (seed):</strong> ${Object.keys(state.isDemo ? state.demoData.evolutions : {}).length}
    `;
    // recent evolutions
    const recent = Object.values(state.isDemo ? state.demoData.evolutions : {}).slice(-5).reverse();
    const ul = document.getElementById('recent-evolutions'); ul.innerHTML = '';
    recent.forEach(ev => {
      const li = document.createElement('li'); li.className = 'list-group-item small';
      li.innerText = `${(state.demoData.patients[ev.patientId]||{}).nome || ev.patientId} — ${dayjs(ev.data).format('YYYY-MM-DD')}: ${ev.anamnese.substring(0,80)}`;
      ul.appendChild(li);
    });
  }

  /* ===========================
     Team management (users CRUD)
     =========================== */
  function renderUsersTable() {
    const tbody = document.querySelector('#users-table tbody');
    tbody.innerHTML = '';
    const users = state.isDemo ? Object.values(state.demoData.users || {}) : [];
    for (const u of users) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary btn-edit-user" data-uid="${u.uid}">Editar</button>
      </td>`;
      tbody.appendChild(tr);
    }
    document.querySelectorAll('.btn-edit-user').forEach(b => b.onclick = () => {
      const uid = b.dataset.uid;
      const u = state.demoData.users[uid];
      const newRole = prompt('Role (owner/admin_clinic/professional/reception/viewer):', u.role);
      if (newRole) {
        u.role = newRole;
        registerAudit({ action: 'user:role_change', collection: 'users', docId: uid, payload: { newRole } });
        renderUsersTable();
      }
    });
  }

  /* ===========================
     Billing (mock)
     =========================== */
  function initBillingMock() {
    state.demoData.billing_plans = { free: { id:'free', name:'Free', limits: { patients: 200 } }, pro: { id:'pro', name:'Pro', limits: { patients: 2000 } } };
    state.demoData.billing_subscriptions = {};
    document.getElementById('billing-info').innerText = 'Plano atual: Free (mock)';
  }

  /* ===========================
     UI helpers, README embedded, tooltips
     =========================== */

  function updateModeBanner() {
    document.getElementById('mode-badge').innerText = state.isDemo ? 'DEMO MODE' : 'CONNECTED TO FIRESTORE';
    document.getElementById('mode-badge').className = state.isDemo ? 'demo-badge' : 'connected-badge';
  }

  function updateOrgBadge() {
    const b = document.getElementById('org-badge');
    if (state.currentOrgId) {
      const org = state.isDemo ? state.demoData.organizations[state.currentOrgId] : null;
      b.innerText = 'Org: ' + (org?.name || state.currentOrgId);
    } else {
      b.innerText = 'Org: —';
    }
  }

  function showMainUI() {
    document.getElementById('onboarding').style.display = 'none';
    document.getElementById('main-ui').style.display = 'block';
    updateModeBanner();
    updateOrgBadge();
    renderPatientsTable();
    renderEvolutions();
    renderAppointments();
    renderUsersTable();
    renderDashboard();
    renderAuditLogs();
    initBillingMock();
    fillGlossary();
  }

  function fillGlossary() {
    const list = document.getElementById('glossary-list');
    const items = [
      {k:'CMV', v:'Custo Médio de Venda'},
      {k:'ticket médio', v:'Valor médio por atendimento'},
      {k:'LGPD', v:'Lei Geral de Proteção de Dados (Brasil)'}
    ];
    list.innerHTML = '';
    items.forEach(it => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${it.k}</strong>: ${it.v}`;
      list.appendChild(li);
    });
  }

  /* ===========================
     Utilities: README content, CSV import/export, PDF
     =========================== */
  function loadReadmeEmbedded() {
    const el = document.getElementById('readme-content');
    el.innerHTML = `
      <h6>Como configurar Firebase</h6>
      <ol>
        <li>Console Firebase → Criar projeto</li>
        <li>Autenticação → Habilitar Email/senha e Google (configurar credenciais)</li>
        <li>Firestore → Criar modo de teste (após dev, aplicar regras)</li>
        <li>Storage → Criar bucket e regras recomendadas</li>
      </ol>
      <p>Cole o objeto firebaseConfig no campo no topo do app e clique em <strong>Inicializar Firebase</strong>.</p>
      <h6>Regras de segurança recomendadas</h6>
      <pre><code>// veja firestore.rules e storage.rules fornecidos separadamente</code></pre>
      <h6>Migrar para produção</h6>
      <p>Para operações sensíveis (agregações, envios de e-mail, pagamentos) mova a lógica para Cloud Functions + Admin SDK. Use Postgres ou BigQuery para análises avançadas.</p>
    `;
  }

  // CSV export simples (pacientes)
  function exportPatientsCSV() {
    const patients = Object.values(state.isDemo ? state.demoData.patients : {});
    const header = ['id','nome','cpf','data_nasc','sexo','tags','email'];
    const rows = patients.map(p => [p.id,p.nome,p.cpf,p.data_nasc,p.sexo,(p.tags||[]).join('|'),p.email||''].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(','));
    const csv = [header.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    saveAs(blob, `pacientes_${new Date().toISOString().slice(0,10)}.csv`);
  }

  // Simple export patient JSON package (single patient)
  async function exportPatientPackage(patientId) {
    const p = state.isDemo ? state.demoData.patients[patientId] : null;
    if (!p) return alert('Paciente não encontrado');
    const pkg = { patient: p, evolutions: [], files: [] };
    const evos = Object.values(state.isDemo ? state.demoData.evolutions : {}).filter(e => e.patientId === patientId);
    pkg.evolutions = evos;
    const files = Object.values(state.isDemo ? state.demoData.files : {}).filter(f => f.patientId === patientId);
    pkg.files = files;
    const blob = new Blob([JSON.stringify(pkg, null, 2)], { type: 'application/json' });
    saveAs(blob, `paciente_${p.nome.replace(/\s+/g,'_')}.json`);
  }

  /* ===========================
     Initialization: wire UI events
     =========================== */

  document.getElementById('btn-init-firebase').addEventListener('click', async () => {
    const txt = document.getElementById('firebaseConfigInput').value.trim();
    if (!txt) return alert('Cole seu firebaseConfig JSON no campo acima.');
    try {
      const cfg = JSON.parse(txt);
      const ok = await initFirebase(cfg);
      if (!ok) alert('Não foi possível inicializar Firebase. Veja console.');
    } catch (err) {
      alert('JSON inválido: ' + err.message);
    }
  });

  document.getElementById('btn-enable-demo').addEventListener('click', () => {
    enableDemoMode();
  });

  document.getElementById('btn-seed-demo').addEventListener('click', () => {
    if (confirm('Recarregar seeds de demo? Isso sobrescreverá dados em memória.')) seedDemoData();
  });

  document.getElementById('btn-clear-all').addEventListener('click', () => clearAllData());
  document.getElementById('btn-export-json').addEventListener('click', () => exportFirestoreToJSON());
  document.getElementById('btn-import-json').addEventListener('click', () => document.getElementById('importFileInput').click());
  document.getElementById('importFileInput').addEventListener('change', (ev) => importJSONToFirestore(ev.target.files[0]));

  document.getElementById('btn-export-org').addEventListener('click', async () => {
    const orgId = state.currentOrgId;
    if (!orgId) return alert('Nenhuma organização selecionada.');
    // export organization data (simple)
    const data = { organization: state.isDemo ? state.demoData.organizations[orgId] : {}, patients: [], evolutions: [] };
    if (state.isDemo) {
      data.patients = Object.values(state.demoData.patients).filter(p => p.organizationId === orgId);
      data.evolutions = Object.values(state.demoData.evolutions).filter(e => e.organizationId === orgId);
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      saveAs(blob, `org_${orgId}_export.json`);
    } else {
      // Real mode: gather collections with where organizationId == orgId
      alert('Em modo real, esta função consulta Firestore. Implementar queries paginadas/seguras em produção.');
    }
  });

  document.getElementById('btn-clear-data').addEventListener('click', () => {
    if (confirm('Deseja recarregar seeds (demo)?')) seedDemoData();
  });

  document.getElementById('btn-login').addEventListener('click', () => loginEmail(document.getElementById('email').value, document.getElementById('password').value));
  document.getElementById('btn-google').addEventListener('click', () => loginGoogle());
  document.getElementById('btn-demo-login').addEventListener('click', () => {
    // demo user
    if (!state.isDemo) {
      alert('Somente em demo.');
      return;
    }
    const demoUser = Object.values(state.demoData.users)[1] || Object.values(state.demoData.users)[0];
    state.currentUser = demoUser;
    document.getElementById('user-info').innerText = `${demoUser.name} (${demoUser.role})`;
    showMainUI();
  });
  document.getElementById('btn-reset-password').addEventListener('click', () => resetPassword(document.getElementById('email').value));

  document.getElementById('patient-search').addEventListener('input', () => renderPatientsTable());

  document.getElementById('btn-new-patient').addEventListener('click', () => editPatient());

  document.getElementById('btn-import-csv').addEventListener('click', () => alert('Import CSV: abra o README para instruções. Implemente mapeamento de colunas antes.'));

  document.getElementById('btn-export-csv').addEventListener('click', () => exportPatientsCSV());

  document.getElementById('btn-add-user').addEventListener('click', () => {
    if (!canPerform('billing:manage') && !canPerform('user:create')) {
      // show minimal create user for demo
      if (!state.isDemo) return alert('Sem permissão');
    }
    const name = prompt('Nome do usuário:');
    const email = prompt('Email:');
    const role = prompt('Role (owner/admin_clinic/professional/reception/viewer):', 'professional');
    if (name && email) {
      const uidNew = uid('user');
      const u = { uid: uidNew, name, email, role, organizationId: state.currentOrgId, createdAt: new Date().toISOString() };
      if (state.isDemo) {
        state.demoData.users[uidNew] = u;
        renderUsersTable();
      } else {
        setDoc(doc(state.db, 'users', uidNew), u);
      }
      registerAudit({ action: 'user:create', collection: 'users', docId: uidNew, payload: u });
    }
  });

  document.getElementById('btn-export-audit').addEventListener('click', () => {
    const logs = Object.values(state.demoData.audit_logs || {});
    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
    saveAs(blob, `audit_logs_${new Date().toISOString().slice(0,10)}.json`);
  });

  document.getElementById('btn-start-trial').addEventListener('click', () => {
    const subId = uid('sub');
    state.demoData.billing_subscriptions[subId] = { id: subId, plan: 'pro', startsAt: new Date().toISOString(), trialEndsAt: dayjs().add(30,'day').toISOString(), status: 'trial' };
    document.getElementById('billing-info').innerText = `Trial ativo até ${dayjs().add(30,'day').format('YYYY-MM-DD')}`;
    registerAudit({ action: 'billing:trial_start', collection: 'billing_subscriptions', docId: subId, payload: {} });
  });

  // theme toggle
  document.getElementById('btn-toggle-theme').addEventListener('click', () => {
    document.body.classList.toggle('dark-theme');
  });

  // README open
  document.getElementById('btn-open-readme').addEventListener('click', () => {
    const tab = new bootstrap.Tab(document.querySelector('a[href="#tab-readme"]'));
    tab.show();
  });

  // signature canvas
  const canvas = document.getElementById('signature-canvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mousemove', (e) => {
      if (!drawing) return;
      const r = canvas.getBoundingClientRect();
      const x = e.clientX - r.left;
      const y = e.clientY - r.top;
      ctx.fillRect(x,y,2,2);
    });
    document.getElementById('clear-signature').addEventListener('click', () => ctx.clearRect(0,0,canvas.width,canvas.height));
    document.getElementById('evolution-sign').addEventListener('change', (ev) => {
      document.getElementById('signature-canvas-area').style.display = ev.target.checked ? 'block' : 'none';
    });
  }

  /* ===========================
     On load: default to demo if no config
     =========================== */
  window.addEventListener('load', () => {
    // init quills
    const scriptQuill = document.createElement('script');
    scriptQuill.src = "https://cdn.quilljs.com/1.3.7/quill.min.js";
    scriptQuill.onload = () => {
      initQuills();
    };
    document.head.appendChild(scriptQuill);

    // If no firebase config, enable demo
    const configText = document.getElementById('firebaseConfigInput').value.trim();
    if (!configText) {
      enableDemoMode();
    } else {
      try {
        const cfg = JSON.parse(configText);
        initFirebase(cfg);
      } catch (err) {
        enableDemoMode();
      }
    }
    loadReadmeEmbedded();
  });

  </script>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Footer README and short instructions for migration are embedded in-tab -->
</body>
</html>