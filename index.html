<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Clinic Manager - Firebase Edition</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (Modais e Alertas bonitos) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-section { display: none; }
        .active-section { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tabs Prontu√°rio */
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">

    <!-- ========================================= -->
    <!-- TELA DE LOGIN -->
    <!-- ========================================= -->
    <div id="view-auth" class="h-full w-full flex items-center justify-center bg-slate-900 z-50 absolute top-0 left-0">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-3">
                    <i class="fa-solid fa-hospital text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Clinic SaaS</h1>
                <p class="text-slate-500 text-sm">Acesse sua conta para continuar</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">E-mail</label>
                    <input type="email" id="email" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition shadow-lg flex justify-center items-center gap-2">
                    Entrar <i class="fa-solid fa-arrow-right"></i>
                </button>
            </form>
            <p class="mt-4 text-center text-xs text-slate-400">
                N√£o tem conta? Entre em contato com o admin.<br>
                <span id="msg-login-error" class="text-red-500 font-bold hidden">Erro ao fazer login.</span>
            </p>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- APLICA√á√ÉO PRINCIPAL -->
    <!-- ========================================= -->
    <div id="view-app" class="h-full flex hidden-section">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col hidden md:flex">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <i class="fa-solid fa-heart-pulse text-blue-600 text-2xl"></i>
                <span class="font-bold text-xl tracking-tight">Clinic SaaS</span>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="router.navigate('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-600 font-medium flex items-center gap-3 transition" id="nav-dashboard">
                    <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
                </button>
                <button onclick="router.navigate('agenda')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-600 font-medium flex items-center gap-3 transition" id="nav-agenda">
                    <i class="fa-regular fa-calendar-days w-5"></i> Agenda
                </button>
                <button onclick="router.navigate('pacientes')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-600 font-medium flex items-center gap-3 transition" id="nav-pacientes">
                    <i class="fa-solid fa-users w-5"></i> Pacientes
                </button>
                <button onclick="router.navigate('checkin')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-600 font-medium flex items-center gap-3 transition" id="nav-checkin">
                    <i class="fa-solid fa-qrcode w-5"></i> Check-in / Recep√ß√£o
                </button>
                <button onclick="router.navigate('prontuario')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-600 font-medium flex items-center gap-3 transition" id="nav-prontuario">
                    <i class="fa-solid fa-file-medical w-5"></i> Prontu√°rio
                </button>
                <div class="border-t border-slate-100 my-2"></div>
                <button onclick="router.navigate('admin')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-600 font-medium flex items-center gap-3 transition" id="nav-admin">
                    <i class="fa-solid fa-gear w-5"></i> Admin
                </button>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold" id="user-avatar">U</div>
                        <div class="text-xs truncate max-w-[100px]">
                            <div class="font-bold text-slate-700" id="user-email">user@email.com</div>
                        </div>
                    </div>
                    <button id="btn-logout" class="text-slate-400 hover:text-red-500 transition" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full relative">
            <!-- Mobile Header -->
            <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center md:hidden">
                <span class="font-bold">Clinic SaaS</span>
                <button id="mobile-menu-btn" class="text-slate-600"><i class="fa-solid fa-bars"></i></button>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-slate-50">
                
                <!-- 1. DASHBOARD SECTION -->
                <div id="section-dashboard" class="section hidden-section">
                    <h2 class="text-2xl font-bold mb-6">Painel de Controle</h2>
                    
                    <!-- Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="text-xs font-bold text-slate-400 uppercase mb-1">Consultas Hoje</div>
                            <div class="text-3xl font-bold text-blue-600" id="dash-count-today">...</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="text-xs font-bold text-slate-400 uppercase mb-1">Pacientes</div>
                            <div class="text-3xl font-bold text-slate-700" id="dash-count-patients">...</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="text-xs font-bold text-slate-400 uppercase mb-1">Fila de Espera</div>
                            <div class="text-3xl font-bold text-orange-500" id="dash-count-waiting">...</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="text-xs font-bold text-slate-400 uppercase mb-1">Faturamento (Est.)</div>
                            <div class="text-3xl font-bold text-green-600">R$ <span id="dash-revenue">0</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="font-bold mb-4">Atendimentos Recentes</h3>
                            <ul id="dash-list-recent" class="space-y-3 text-sm">
                                <li class="text-slate-400 italic">Carregando...</li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="font-bold mb-4">A√ß√µes R√°pidas</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="router.navigate('agenda')" class="p-4 bg-blue-50 text-blue-600 rounded-lg font-bold hover:bg-blue-100 transition">Novo Agendamento</button>
                                <button onclick="router.navigate('pacientes')" class="p-4 bg-green-50 text-green-600 rounded-lg font-bold hover:bg-green-100 transition">Cadastrar Paciente</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. AGENDA SECTION -->
                <div id="section-agenda" class="section hidden-section">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold">Agenda Inteligente</h2>
                        <div class="flex gap-2">
                            <input type="date" id="agenda-date-filter" class="border rounded-lg px-3 py-2 text-sm">
                            <button onclick="app.agenda.openNewModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">
                                <i class="fa-solid fa-plus"></i> Agendar
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 font-medium">
                                    <tr>
                                        <th class="p-4">Hor√°rio</th>
                                        <th class="p-4">Paciente</th>
                                        <th class="p-4">Profissional</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="agenda-list" class="divide-y divide-slate-100">
                                    <!-- Render via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. PACIENTES SECTION -->
                <div id="section-pacientes" class="section hidden-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Pacientes</h2>
                        <div class="flex gap-2">
                            <button onclick="app.patients.exportCSV()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold">
                                <i class="fa-solid fa-file-csv"></i> CSV
                            </button>
                            <button onclick="app.patients.openNewModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">
                                <i class="fa-solid fa-user-plus"></i> Novo
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 mb-4">
                        <div class="p-4 border-b border-slate-100">
                            <input type="text" id="patient-search" placeholder="Buscar por nome ou CPF..." class="w-full border rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="overflow-x-auto max-h-[60vh]">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 sticky top-0">
                                    <tr>
                                        <th class="p-4">Nome</th>
                                        <th class="p-4">Contato</th>
                                        <th class="p-4">Conv√™nio</th>
                                        <th class="p-4 text-right">Prontu√°rio</th>
                                    </tr>
                                </thead>
                                <tbody id="patients-list" class="divide-y divide-slate-100">
                                    <!-- Render JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 4. CHECK-IN / RECEP√á√ÉO SECTION -->
                <div id="section-checkin" class="section hidden-section">
                    <h2 class="text-2xl font-bold mb-6">Recep√ß√£o & Check-in</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- QR Code Area -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 text-center">
                            <h3 class="font-bold mb-4">Check-in R√°pido</h3>
                            <div class="bg-slate-100 w-48 h-48 mx-auto rounded-lg flex items-center justify-center mb-4">
                                <i class="fa-solid fa-qrcode text-6xl text-slate-300"></i>
                            </div>
                            <p class="text-sm text-slate-500 mb-4">Aponte a c√¢mera ou digite o CPF</p>
                            <button onclick="app.checkin.manual()" class="bg-blue-600 text-white w-full py-2 rounded-lg font-bold">Check-in Manual</button>
                        </div>

                        <!-- Fila de Espera -->
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100">
                            <div class="p-4 border-b border-slate-100 font-bold bg-slate-50">Fila de Espera (Hoje)</div>
                            <ul id="checkin-list" class="divide-y divide-slate-100">
                                <!-- Render JS -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 5. PRONTU√ÅRIO SECTION -->
                <div id="section-prontuario" class="section hidden-section">
                    <h2 class="text-2xl font-bold mb-6">Prontu√°rio Eletr√¥nico</h2>
                    
                    <div id="prontuario-selector" class="bg-white p-8 rounded-xl text-center shadow-sm border border-slate-100">
                        <i class="fa-solid fa-file-medical text-4xl text-slate-300 mb-4"></i>
                        <p class="text-slate-500 mb-4">Selecione um paciente na aba "Pacientes" ou "Agenda" para abrir o prontu√°rio.</p>
                        <button onclick="router.navigate('pacientes')" class="text-blue-600 font-bold hover:underline">Ir para lista de pacientes</button>
                    </div>

                    <div id="prontuario-detail" class="hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800" id="pt-name">Nome do Paciente</h3>
                                <p class="text-sm text-slate-500" id="pt-info">CPF: 000... ‚Ä¢ Conv√™nio: Unimed</p>
                            </div>
                            <button onclick="app.prontuario.close()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i> Fechar</button>
                        </div>

                        <div class="flex gap-4 mb-4 border-b border-slate-200">
                            <button class="px-4 py-2 font-medium text-sm tab-active" id="tab-btn-timeline">Hist√≥rico</button>
                            <button class="px-4 py-2 font-medium text-sm text-slate-500 hover:text-blue-600" id="tab-btn-files">Arquivos</button>
                        </div>

                        <!-- Timeline Tab -->
                        <div id="tab-timeline" class="space-y-4">
                            <div class="bg-white p-4 rounded-xl border border-slate-200">
                                <textarea id="new-note-text" class="w-full border rounded-lg p-3 text-sm mb-2" rows="3" placeholder="Nova evolu√ß√£o cl√≠nica (SOAP)..."></textarea>
                                <div class="flex justify-end">
                                    <button onclick="app.prontuario.addNote()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Salvar Evolu√ß√£o</button>
                                </div>
                            </div>
                            <div id="timeline-list" class="space-y-4"></div>
                        </div>
                        
                        <!-- Files Tab (Simple placeholder) -->
                        <div id="tab-files" class="hidden bg-white p-6 rounded-xl border border-slate-200 text-center">
                            <input type="file" id="file-upload" class="hidden" onchange="app.prontuario.uploadFile(this)">
                            <button onclick="document.getElementById('file-upload').click()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold mb-4">
                                <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Upload de Exame
                            </button>
                            <p class="text-xs text-red-400 mt-2">* Requer configura√ß√£o de CORS no Firebase Storage.</p>
                            <div id="files-list" class="mt-4 text-left"></div>
                        </div>
                    </div>
                </div>

                <!-- 6. ADMIN SECTION -->
                <div id="section-admin" class="section hidden-section">
                    <h2 class="text-2xl font-bold mb-6">Administra√ß√£o</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold mb-4">Controle de Usu√°rios</h3>
                        <p class="text-sm text-slate-500 mb-4">Apenas usu√°rios autenticados e com a role 'admin' podem ver esta tela (simulado).</p>
                        <button onclick="Swal.fire('Info', 'Feature dispon√≠vel na vers√£o PRO para criar novos recepcionistas/m√©dicos.', 'info')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fa-solid fa-user-plus"></i> Adicionar Usu√°rio
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ========================================= -->
    <!-- JAVASCRIPT LOGIC (MODULE) -->
    <!-- ========================================= -->
    <script type="module">
        // -----------------------------------------------------------
        // 1. FIREBASE CONFIGURATION
        // -----------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, query, where, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // üö® SUBSTITUA ESTAS CREDENCIAIS PELAS DO SEU PROJETO!
const firebaseConfig = {
  apiKey: "AIzaSyC5lYxqNHxCOBPH-ZFK9Br4PHnOCFzUyXs",
  authDomain: "prontuario-ee1fd.firebaseapp.com",
  projectId: "prontuario-ee1fd",
  storageBucket: "prontuario-ee1fd.firebasestorage.app",
  messagingSenderId: "107787636728",
  appId: "1:107787636728:web:18ee71ce1eca6d4450100d",
  measurementId: "G-4614MWTTME"
};

        // Initialize Firebase
        let appFirebase, auth, db, storage;
        try {
            appFirebase = initializeApp(firebaseConfig);
            auth = getAuth(appFirebase);
            db = getFirestore(appFirebase);
            storage = getStorage(appFirebase);
        } catch (e) {
            console.error("Firebase init failed. Did you fill the config?", e);
            Swal.fire("Erro de Configura√ß√£o", "Voc√™ precisa editar o arquivo HTML e colocar suas credenciais do Firebase nas linhas de script.", "error");
        }

        // -----------------------------------------------------------
        // 2. ROUTING & UI STATE
        // -----------------------------------------------------------
        const router = {
            navigate: (viewId) => {
                // Highlight sidebar
                document.querySelectorAll('.nav-btn').forEach(el => {
                    el.classList.remove('bg-blue-50', 'text-blue-600');
                    el.classList.add('text-slate-600');
                });
                const navBtn = document.getElementById(`nav-${viewId}`);
                if(navBtn) {
                    navBtn.classList.add('bg-blue-50', 'text-blue-600');
                    navBtn.classList.remove('text-slate-600');
                }

                // Show section
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active-section', 'block'));
                document.querySelectorAll('.section').forEach(el => el.classList.add('hidden-section'));
                
                const section = document.getElementById(`section-${viewId}`);
                if(section) {
                    section.classList.remove('hidden-section');
                    section.classList.add('active-section');
                    // Trigger loads
                    if(viewId === 'dashboard') app.dashboard.load();
                    if(viewId === 'agenda') app.agenda.load();
                    if(viewId === 'pacientes') app.patients.load();
                    if(viewId === 'checkin') app.checkin.load();
                }
            }
        };

        // -----------------------------------------------------------
        // 3. APP LOGIC
        // -----------------------------------------------------------
        window.app = {
            user: null,

            // --- AUTHENTICATION ---
            auth: {
                login: async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const pass = document.getElementById('password').value;
                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                    } catch (error) {
                        document.getElementById('msg-login-error').classList.remove('hidden');
                        document.getElementById('msg-login-error').innerText = error.message;
                    }
                },
                logout: () => signOut(auth)
            },

            // --- DASHBOARD ---
            dashboard: {
                load: async () => {
                    // Simples counters (not real-time listeners to save reads in this MVP)
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Queries
                    const qAppts = query(collection(db, "appointments"), where("date", "==", today));
                    const snapAppts = await getDocs(qAppts);
                    const countAppts = snapAppts.size;

                    const snapPats = await getDocs(collection(db, "patients"));
                    const countPats = snapPats.size;

                    // Calculating Waiting
                    let waiting = 0;
                    let revenue = 0;
                    const listRecent = document.getElementById('dash-list-recent');
                    listRecent.innerHTML = '';

                    snapAppts.forEach(doc => {
                        const data = doc.data();
                        if(data.status === 'waiting') waiting++;
                        if(data.status !== 'canceled') revenue += (Number(data.value) || 0);

                        // Add to recent list (slice would be better on array)
                        if(listRecent.children.length < 5) {
                            listRecent.innerHTML += `<li class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                                <span>${data.patientName}</span>
                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">${data.time}</span>
                            </li>`;
                        }
                    });

                    document.getElementById('dash-count-today').innerText = countAppts;
                    document.getElementById('dash-count-patients').innerText = countPats;
                    document.getElementById('dash-count-waiting').innerText = waiting;
                    document.getElementById('dash-revenue').innerText = revenue.toFixed(2);
                }
            },

            // --- PATIENTS ---
            patients: {
                list: [],
                load: async () => {
                    const tbody = document.getElementById('patients-list');
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
                    
                    const q = query(collection(db, "patients"), orderBy("name"));
                    const querySnapshot = await getDocs(q);
                    
                    tbody.innerHTML = '';
                    app.patients.list = [];
                    
                    querySnapshot.forEach((doc) => {
                        const p = { id: doc.id, ...doc.data() };
                        app.patients.list.push(p);
                        tbody.innerHTML += `
                            <tr class="hover:bg-slate-50 group">
                                <td class="p-4 font-medium">${p.name}</td>
                                <td class="p-4 text-slate-500">${p.phone}<br><span class="text-xs">${p.email}</span></td>
                                <td class="p-4"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">${p.insurance || 'Particular'}</span></td>
                                <td class="p-4 text-right">
                                    <button onclick="app.prontuario.open('${p.id}')" class="text-blue-600 hover:text-blue-800 font-bold text-sm">
                                        <i class="fa-solid fa-folder-open"></i> Prontu√°rio
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                },
                openNewModal: async () => {
                    const { value: formValues } = await Swal.fire({
                        title: 'Novo Paciente',
                        html:
                            '<input id="swal-name" class="swal2-input" placeholder="Nome Completo">' +
                            '<input id="swal-cpf" class="swal2-input" placeholder="CPF">' +
                            '<input id="swal-phone" class="swal2-input" placeholder="Telefone">' +
                            '<input id="swal-email" class="swal2-input" placeholder="E-mail">' +
                            '<input id="swal-insurance" class="swal2-input" placeholder="Conv√™nio">',
                        focusConfirm: false,
                        showCancelButton: true,
                        preConfirm: () => {
                            return [
                                document.getElementById('swal-name').value,
                                document.getElementById('swal-cpf').value,
                                document.getElementById('swal-phone').value,
                                document.getElementById('swal-email').value,
                                document.getElementById('swal-insurance').value
                            ]
                        }
                    });

                    if (formValues) {
                        try {
                            await addDoc(collection(db, "patients"), {
                                name: formValues[0],
                                cpf: formValues[1],
                                phone: formValues[2],
                                email: formValues[3],
                                insurance: formValues[4],
                                createdAt: serverTimestamp()
                            });
                            Swal.fire('Sucesso', 'Paciente cadastrado!', 'success');
                            app.patients.load();
                        } catch(e) {
                            Swal.fire('Erro', e.message, 'error');
                        }
                    }
                },
                exportCSV: () => {
                    let csvContent = "data:text/csv;charset=utf-8,Nome,CPF,Email,Telefone\n";
                    app.patients.list.forEach(p => {
                        csvContent += `${p.name},${p.cpf},${p.email},${p.phone}\n`;
                    });
                    const encodedUri = encodeURI(csvContent);
                    window.open(encodedUri);
                }
            },

            // --- AGENDA ---
            agenda: {
                load: async () => {
                    const dateFilter = document.getElementById('agenda-date-filter').value || new Date().toISOString().split('T')[0];
                    document.getElementById('agenda-date-filter').value = dateFilter;

                    const tbody = document.getElementById('agenda-list');
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';

                    const q = query(collection(db, "appointments"), where("date", "==", dateFilter)); // Simple filter without orderBy to avoid index requirement err
                    const querySnapshot = await getDocs(q);
                    
                    // Sort client side
                    const appts = [];
                    querySnapshot.forEach(doc => appts.push({ id: doc.id, ...doc.data() }));
                    appts.sort((a,b) => a.time.localeCompare(b.time));

                    tbody.innerHTML = '';
                    if(appts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">Nenhum agendamento neste dia.</td></tr>';
                        return;
                    }

                    appts.forEach(a => {
                        let statusColor = 'bg-slate-100 text-slate-600';
                        if(a.status === 'confirmed') statusColor = 'bg-green-100 text-green-700';
                        if(a.status === 'waiting') statusColor = 'bg-orange-100 text-orange-700';
                        if(a.status === 'finished') statusColor = 'bg-blue-100 text-blue-700';

                        tbody.innerHTML += `
                            <tr class="hover:bg-slate-50">
                                <td class="p-4 font-bold">${a.time}</td>
                                <td class="p-4">
                                    <div class="font-bold">${a.patientName}</div>
                                    <div class="text-xs text-slate-400">${a.procedure}</div>
                                </td>
                                <td class="p-4 text-sm">${a.doctor}</td>
                                <td class="p-4"><span class="${statusColor} px-2 py-1 rounded text-xs font-bold uppercase">${a.status}</span></td>
                                <td class="p-4 text-right flex justify-end gap-2">
                                    <button onclick="app.agenda.sendReminder('${a.patientName}', '${a.date}', '${a.time}')" class="text-green-500 hover:bg-green-50 p-2 rounded" title="WhatsApp">
                                        <i class="fa-brands fa-whatsapp"></i>
                                    </button>
                                    <button onclick="app.agenda.setStatus('${a.id}', 'confirmed')" class="text-blue-500 hover:bg-blue-50 p-2 rounded" title="Confirmar">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                    <button onclick="app.agenda.setStatus('${a.id}', 'canceled')" class="text-red-500 hover:bg-red-50 p-2 rounded" title="Cancelar">
                                        <i class="fa-solid fa-ban"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                },
                openNewModal: async () => {
                    // First get patients for select
                    const snap = await getDocs(collection(db, "patients"));
                    let options = '';
                    snap.forEach(doc => options += `<option value="${doc.id}||${doc.data().name}">${doc.data().name}</option>`);

                    const { value: formValues } = await Swal.fire({
                        title: 'Novo Agendamento',
                        html:
                            `<select id="swal-patient" class="swal2-input">${options}</select>` +
                            '<input type="date" id="swal-date" class="swal2-input">' +
                            '<input type="time" id="swal-time" class="swal2-input">' +
                            '<input id="swal-proc" class="swal2-input" placeholder="Procedimento">' +
                            '<input id="swal-doc" class="swal2-input" placeholder="Profissional" value="Dr. Admin">' +
                            '<input type="number" id="swal-val" class="swal2-input" placeholder="Valor R$">',
                        focusConfirm: false,
                        showCancelButton: true,
                        preConfirm: () => {
                            return [
                                document.getElementById('swal-patient').value,
                                document.getElementById('swal-date').value,
                                document.getElementById('swal-time').value,
                                document.getElementById('swal-proc').value,
                                document.getElementById('swal-doc').value,
                                document.getElementById('swal-val').value
                            ]
                        }
                    });

                    if (formValues) {
                        const [patInfo, date, time, proc, docName, val] = formValues;
                        const [patId, patName] = patInfo.split('||');
                        await addDoc(collection(db, "appointments"), {
                            patientId: patId,
                            patientName: patName,
                            date, time, procedure: proc, doctor: docName, value: val,
                            status: 'scheduled'
                        });
                        Swal.fire('Agendado!', '', 'success');
                        app.agenda.load();
                    }
                },
                setStatus: async (id, status) => {
                    await updateDoc(doc(db, "appointments", id), { status: status });
                    app.agenda.load();
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                    Toast.fire({ icon: 'success', title: `Status alterado para ${status}` });
                },
                sendReminder: (name, date, time) => {
                    // Mock URL generator
                    const msg = `Ol√° ${name}, lembrete da sua consulta dia ${date} √†s ${time}. Responda para confirmar.`;
                    alert(`Simula√ß√£o: Link do WhatsApp abriria com:\n\n${msg}`);
                }
            },

            // --- CHECKIN ---
            checkin: {
                load: async () => {
                    const today = new Date().toISOString().split('T')[0];
                    const q = query(collection(db, "appointments"), where("date", "==", today), where("status", "==", "waiting"));
                    const snap = await getDocs(q);
                    const list = document.getElementById('checkin-list');
                    list.innerHTML = '';
                    
                    if(snap.size === 0) {
                        list.innerHTML = '<li class="p-4 text-slate-400 text-center">Ningu√©m na sala de espera.</li>';
                        return;
                    }

                    snap.forEach(doc => {
                        const d = doc.data();
                        list.innerHTML += `
                            <li class="p-4 flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-lg">${d.patientName}</div>
                                    <div class="text-sm text-slate-500">Chegou para: ${d.procedure} (${d.doctor})</div>
                                </div>
                                <button onclick="app.agenda.setStatus('${doc.id}', 'finished'); app.checkin.load()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                    Chamar
                                </button>
                            </li>
                        `;
                    });
                },
                manual: async () => {
                    // Simulate finding an appointment for today and setting to 'waiting'
                    const { value: name } = await Swal.fire({
                        title: 'Check-in Manual',
                        input: 'text',
                        inputLabel: 'Nome do Paciente',
                        inputPlaceholder: 'Digite o nome...'
                    });
                    
                    if(name) {
                        // In real app, search query. Here, mock action.
                        Swal.fire('Check-in realizado', `Paciente ${name} adicionado √† fila. (Simula√ß√£o: no app real buscaria o agendamento e alteraria status para 'waiting')`, 'success');
                    }
                }
            },

            // --- PRONTU√ÅRIO ---
            prontuario: {
                activePatientId: null,
                open: async (patId) => {
                    app.prontuario.activePatientId = patId;
                    
                    // UI Swap
                    router.navigate('prontuario');
                    document.getElementById('prontuario-selector').classList.add('hidden');
                    document.getElementById('prontuario-detail').classList.remove('hidden');

                    // Fetch Info
                    const pDoc = await getDoc(doc(db, "patients", patId));
                    if(pDoc.exists()) {
                        const p = pDoc.data();
                        document.getElementById('pt-name').innerText = p.name;
                        document.getElementById('pt-info').innerText = `CPF: ${p.cpf || '-'} ‚Ä¢ Conv√™nio: ${p.insurance || 'Particular'}`;
                    }

                    app.prontuario.loadNotes();
                },
                close: () => {
                    app.prontuario.activePatientId = null;
                    document.getElementById('prontuario-selector').classList.remove('hidden');
                    document.getElementById('prontuario-detail').classList.add('hidden');
                },
                loadNotes: async () => {
                    const list = document.getElementById('timeline-list');
                    list.innerHTML = '<div class="loader"></div>';
                    
                    // Subcollection or main collection filter
                    const q = query(collection(db, "medical_records"), where("patientId", "==", app.prontuario.activePatientId), orderBy("createdAt", "desc"));
                    const snap = await getDocs(q);

                    list.innerHTML = '';
                    if(snap.size === 0) list.innerHTML = '<p class="text-slate-400 text-sm text-center">Nenhuma anota√ß√£o ainda.</p>';

                    snap.forEach(d => {
                        const n = d.data();
                        const dateStr = n.createdAt ? n.createdAt.toDate().toLocaleString() : 'Agora';
                        list.innerHTML += `
                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                                    <div class="w-0.5 h-full bg-slate-200 my-1"></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-slate-100 shadow-sm w-full mb-4">
                                    <div class="text-xs text-slate-400 font-bold mb-1">${dateStr} - Dr. Admin</div>
                                    <p class="text-slate-700 text-sm whitespace-pre-wrap">${n.note}</p>
                                </div>
                            </div>
                        `;
                    });
                },
                addNote: async () => {
                    const txt = document.getElementById('new-note-text').value;
                    if(!txt) return;

                    await addDoc(collection(db, "medical_records"), {
                        patientId: app.prontuario.activePatientId,
                        note: txt,
                        doctorId: auth.currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    
                    document.getElementById('new-note-text').value = '';
                    app.prontuario.loadNotes();
                },
                uploadFile: async (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    
                    // Simple Storage Upload
                    try {
                        const storageRef = ref(storage, `patients/${app.prontuario.activePatientId}/${file.name}`);
                        await uploadBytes(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        
                        // Save ref in notes or separate collection
                        await addDoc(collection(db, "medical_records"), {
                            patientId: app.prontuario.activePatientId,
                            note: `[ARQUIVO] Upload realizado: ${file.name} - <a href="${url}" target="_blank" class="text-blue-500 underline">Ver Arquivo</a>`,
                            doctorId: auth.currentUser.uid,
                            createdAt: serverTimestamp()
                        });
                        
                        Swal.fire('Upload Conclu√≠do', 'Arquivo salvo no prontu√°rio.', 'success');
                        app.prontuario.loadNotes();
                    } catch (e) {
                        console.error(e);
                        Swal.fire('Erro de Upload', 'Verifique as regras de CORS no Firebase console se estiver rodando no navegador localmente.', 'error');
                    }
                }
            }
        };

        // -----------------------------------------------------------
        // 4. INITIALIZATION & LISTENERS
        // -----------------------------------------------------------
        
        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                app.user = user;
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden-section');
                // Start at dashboard
                router.navigate('dashboard');
            } else {
                app.user = null;
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden-section');
            }
        });

        // Event Binding
        document.getElementById('login-form').addEventListener('submit', app.auth.login);
        document.getElementById('btn-logout').addEventListener('click', app.auth.logout);
        
        document.getElementById('agenda-date-filter').addEventListener('change', app.agenda.load);
        document.getElementById('patient-search').addEventListener('keyup', (e) => {
            // Simple Client Side Filter for MVP
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#patients-list tr');
            rows.forEach(row => {
                const txt = row.innerText.toLowerCase();
                row.style.display = txt.includes(term) ? '' : 'none';
            });
        });

        // Mobile Menu
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.querySelector('aside').classList.toggle('hidden');
            document.querySelector('aside').classList.toggle('absolute');
            document.querySelector('aside').classList.toggle('h-full');
            document.querySelector('aside').classList.toggle('z-20');
        });
        
        // Expose app to window for HTML onclick handlers
        window.router = router;

    </script>
</body>
</html>