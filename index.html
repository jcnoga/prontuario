<!--
LICENÇA: MIT License

Copyright (c) 2023 [Seu Nome ou Nome da Empresa]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTI<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prontuário Eletrônico Premium - SaaS-lite (SQLite WASM)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <!-- Quill -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <!-- Simple styles -->
  <style>
    :root{
      --bg:#f8f9fa; --fg:#212529; --card:#ffffff;
    }
    [data-theme="dark"]{
      --bg:#0d1117; --fg:#c9d1d9; --card:#0b1220;
    }
    body{ background:var(--bg); color:var(--fg); }
    .card{ background:var(--card); }
    .sidebar { min-width:240px; max-width:320px; height:100vh; overflow:auto; position:fixed; }
    .content { margin-left:320px; padding:20px; }
    .small-muted { font-size:0.85rem; color: #6c757d; }
    .file-preview { max-width:100%; height:auto; }
    .drag-slot { min-height:60px; border:1px dashed rgba(0,0,0,0.1); padding:8px; margin-bottom:8px; border-radius:6px; background:rgba(255,255,255,0.02); }
    .appointment { padding:6px; margin:4px 0; border-radius:6px; background:#e9ecef; cursor:grab; }
    .appointment[data-status="miss"]{ background:#ffc9c9; }
    .tooltip-inner { max-width:300px; text-align:left; }
    .quill-editor { height:200px; }
    .hidden { display:none!important; }
    .glossary dt { font-weight:600; }
    .help-badge { cursor:help; }
    .seed-btn { margin-right:8px; }
    .file-list img { max-width:120px; margin:6px; border-radius:6px; }
    .AuditRow { font-family:monospace; font-size:0.9rem; }
    .org-pill { cursor:pointer; }
  </style>
</head>
<body data-theme="light">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Prontuário Premium (WASM SQLite)</a>
      <div class="d-flex align-items-center gap-2">
        <div class="me-2">
          <select id="orgSelect" class="form-select form-select-sm" title="Alternar organização"></select>
        </div>
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm" title="Alternar tema"><i class="fa fa-moon"></i></button>
        <div class="btn-group">
          <button id="userBtn" class="btn btn-sm btn-outline-primary">Entrar</button>
          <button id="importBtn" class="btn btn-sm btn-outline-secondary" title="Importar .sqlite"><i class="fa fa-file-import"></i></button>
          <button id="exportBtn" class="btn btn-sm btn-outline-success" title="Exportar .sqlite"><i class="fa fa-file-export"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar bg-light p-3 shadow-sm">
    <div class="mb-3">
      <strong>Menu</strong>
    </div>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a class="nav-link active" href="#onboarding" data-target="onboarding">Onboarding</a></li>
      <li class="nav-item"><a class="nav-link" href="#patients" data-target="patients">Pacientes</a></li>
      <li class="nav-item"><a class="nav-link" href="#evolutions" data-target="evolutions">Evoluções / Atendimentos</a></li>
      <li class="nav-item"><a class="nav-link" href="#agenda" data-target="agenda">Agenda</a></li>
      <li class="nav-item"><a class="nav-link" href="#files" data-target="files">Arquivos</a></li>
      <li class="nav-item"><a class="nav-link" href="#billing" data-target="billing">Billing (Mock)</a></li>
      <li class="nav-item"><a class="nav-link" href="#dashboard" data-target="dashboard">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="#audit" data-target="audit">Auditoria</a></li>
      <li class="nav-item"><a class="nav-link" href="#glossary" data-target="glossary">Glossário</a></li>
      <li class="nav-item"><a class="nav-link" href="#readme" data-target="readme">README</a></li>
    </ul>

    <hr/>
    <div>
      <button id="reloadSeedsBtn" class="btn btn-sm btn-outline-warning seed-btn">Recarregar Seeds</button>
      <button id="resetBtn" class="btn btn-sm btn-outline-danger">Reset DB</button>
    </div>
    <hr/>
    <div class="small-muted">
      Aviso: o banco vive apenas na memória enquanto o navegador estiver aberto. Faça backup regular do arquivo .sqlite.
    </div>
  </div>

  <!-- Main content -->
  <div class="content">
    <div id="flash" class="mb-3"></div>

    <!-- ONBOARDING -->
    <section id="onboardingSection" class="card mb-3 p-3">
      <h4>Onboarding <span class="badge bg-info">Tour</span></h4>
      <p class="small-muted">Bem-vindo! Este é um PEP (Prontuário Eletrônico Premium) rodando 100% no navegador usando SQLite via WASM. Você pode importar um .sqlite ou usar o banco seeded.</p>
      <div class="d-flex gap-2">
        <button id="startTourBtn" class="btn btn-primary btn-sm">Iniciar Tutorial</button>
        <button id="trySeedBtn" class="btn btn-outline-primary btn-sm">Carregar Seeds</button>
        <button id="tryImportBtn" class="btn btn-outline-secondary btn-sm">Importar .sqlite</button>
      </div>
      <hr/>
      <div>
        <h6>Limitações e mocks</h6>
        <ul>
          <li>Google Sign-in: mock — simula retorno e cria usuário local.</li>
          <li>Emails: mock — mostra instrução de envio. Para produção: conectar backend.</li>
          <li>Persistência: exporte .sqlite para salvar seu trabalho.</li>
        </ul>
      </div>
    </section>

    <!-- LOGIN / USER PANEL -->
    <section id="loginSection" class="card mb-3 p-3">
      <h5>Login</h5>
      <div id="authArea" class="row">
        <div class="col-md-4">
          <div class="mb-2"><input id="loginEmail" class="form-control form-control-sm" placeholder="Email"/></div>
          <div class="mb-2"><input id="loginPassword" type="password" class="form-control form-control-sm" placeholder="Senha"/></div>
          <div class="mb-2 d-flex gap-2">
            <button id="loginLocalBtn" class="btn btn-sm btn-success">Entrar</button>
            <button id="signupBtn" class="btn btn-sm btn-outline-primary">Criar conta</button>
          </div>
          <div class="mb-2">
            <button id="googleMockBtn" class="btn btn-sm btn-danger"><i class="fa fa-google"></i> Entrar com Google (mock)</button>
          </div>
          <div class="small-muted">Precisa redefinir senha? <a href="#" id="resetPassLink">Clique aqui</a> (mock).</div>
        </div>
        <div class="col-md-8">
          <div id="userInfo" class="hidden card p-2">
            <div><strong id="userNameDisplay"></strong> <span class="small-muted" id="userRoleDisplay"></span></div>
            <div class="small-muted"><span id="userEmailDisplay"></span></div>
            <div class="mt-2">
              <button id="logoutBtn" class="btn btn-sm btn-outline-danger">Sair</button>
              <button id="manageRolesBtn" class="btn btn-sm btn-outline-secondary">Gerenciar Papéis</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PATIENTS -->
    <section id="patientsSection" class="card mb-3 p-3 hidden">
      <div class="d-flex justify-content-between">
        <h5>Pacientes</h5>
        <div>
          <button id="importCsvBtn" class="btn btn-sm btn-outline-secondary">Import CSV</button>
          <button id="exportCsvBtn" class="btn btn-sm btn-outline-success">Export CSV</button>
          <button id="exportPatientsJsonBtn" class="btn btn-sm btn-outline-info">Export JSON</button>
          <button id="newPatientBtn" class="btn btn-sm btn-primary">Novo Paciente</button>
        </div>
      </div>
      <hr/>
      <div class="row">
        <div class="col-md-4">
          <input id="patientSearch" class="form-control form-control-sm" placeholder="Pesquisar por nome, cpf, tag..." />
          <div id="patientsList" class="mt-2"></div>
        </div>
        <div class="col-md-8">
          <div id="patientFormArea" class="hidden card p-3">
            <h6 id="patientFormTitle">Novo Paciente</h6>
            <form id="patientForm">
              <input type="hidden" id="patient_id" />
              <div class="row">
                <div class="col"><input id="p_nome" class="form-control form-control-sm" placeholder="Nome" required/></div>
                <div class="col"><input id="p_cpf" class="form-control form-control-sm" placeholder="CPF"/></div>
              </div>
              <div class="row mt-2">
                <div class="col"><input id="p_data_nasc" type="date" class="form-control form-control-sm"/></div>
                <div class="col"><select id="p_sexo" class="form-select form-select-sm"><option></option><option value="M">M</option><option value="F">F</option></select></div>
              </div>
              <div class="row mt-2">
                <div class="col"><input id="p_telefone" class="form-control form-control-sm" placeholder="Telefone"/></div>
                <div class="col"><input id="p_email" type="email" class="form-control form-control-sm" placeholder="Email"/></div>
              </div>
              <div class="mt-2">
                <textarea id="p_endereco" class="form-control form-control-sm" placeholder="Endereço"></textarea>
              </div>
              <div class="mt-2">
                <textarea id="p_observacoes" class="form-control form-control-sm" placeholder="Observações privadas"></textarea>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-success" type="submit">Salvar</button>
                <button id="patientCancelBtn" type="button" class="btn btn-sm btn-outline-secondary">Cancelar</button>
                <button id="patientDeleteBtn" type="button" class="btn btn-sm btn-danger">Excluir</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- EVOLUTIONS -->
    <section id="evolutionsSection" class="card mb-3 p-3 hidden">
      <div class="d-flex justify-content-between">
        <h5>Evoluções / Atendimentos</h5>
        <div>
          <button id="newEvolutionBtn" class="btn btn-sm btn-primary">Nova Evolução</button>
          <button id="exportEvolutionsPdfBtn" class="btn btn-sm btn-outline-success">Exportar PDF</button>
        </div>
      </div>
      <hr/>
      <div class="row">
        <div class="col-md-4">
          <select id="evoPatientFilter" class="form-select form-select-sm"><option value="">-- Filtrar por paciente --</option></select>
          <div id="evolutionsList" class="mt-2"></div>
        </div>
        <div class="col-md-8">
          <div id="evolutionEditorArea" class="hidden">
            <h6 id="evolutionTitle">Nova Evolução</h6>
            <div id="quillEditor" class="quill-editor"></div>
            <div class="mt-2">
              <input id="evoAttachInput" type="file" class="form-control form-control-sm" />
              <button id="saveEvolutionBtn" class="btn btn-sm btn-success mt-2">Salvar</button>
              <button id="cancelEvolutionBtn" class="btn btn-sm btn-outline-secondary mt-2">Cancelar</button>
            </div>
            <div class="mt-3">
              <h6>Versões</h6>
              <div id="evoVersions"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="agendaSection" class="card mb-3 p-3 hidden">
      <div class="d-flex justify-content-between">
        <h5>Agenda</h5>
        <div>
          <button id="viewDayBtn" class="btn btn-sm btn-outline-secondary">Dia</button>
          <button id="viewWeekBtn" class="btn btn-sm btn-outline-secondary">Semana</button>
          <button id="viewMonthBtn" class="btn btn-sm btn-outline-secondary">Mês</button>
          <button id="newApptBtn" class="btn btn-sm btn-primary">Novo</button>
        </div>
      </div>
      <hr/>
      <div id="agendaView" class="row">
        <div class="col-md-3">
          <div class="card p-2">
            <h6>Horários</h6>
            <div id="timeSlots"></div>
          </div>
        </div>
        <div class="col-md-9">
          <div id="appointmentsArea"></div>
        </div>
      </div>
    </section>

    <!-- FILES -->
    <section id="filesSection" class="card mb-3 p-3 hidden">
      <h5>Arquivos</h5>
      <div class="row">
        <div class="col-md-4">
          <select id="filesPatientFilter" class="form-select form-select-sm"><option value="">-- Selecionar paciente --</option></select>
          <input id="fileUploadInput" type="file" class="form-control form-control-sm mt-2" />
          <button id="uploadFileBtn" class="btn btn-sm btn-primary mt-2">Enviar e salvar no DB</button>
        </div>
        <div class="col-md-8">
          <div id="filesList" class="file-list"></div>
        </div>
      </div>
    </section>

    <!-- BILLING -->
    <section id="billingSection" class="card mb-3 p-3 hidden">
      <h5>Billing (Mock)</h5>
      <div class="row">
        <div class="col-md-6">
          <div id="billingInfo"></div>
        </div>
        <div class="col-md-6">
          <div>
            <button id="subscribeStarter" class="btn btn-sm btn-outline-primary">Assinar Starter</button>
            <button id="subscribePro" class="btn btn-sm btn-outline-primary">Assinar Pro</button>
            <button id="subscribeClinic" class="btn btn-sm btn-outline-primary">Assinar Clinic</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboardSection" class="card mb-3 p-3 hidden">
      <h5>Dashboard</h5>
      <div class="row">
        <div class="col-md-6">
          <canvas id="chartAppointments"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="chartPatients"></canvas>
        </div>
      </div>
      <hr/>
      <div id="dashboardStats" class="row"></div>
    </section>

    <!-- AUDIT -->
    <section id="auditSection" class="card mb-3 p-3 hidden">
      <h5>Auditoria</h5>
      <div id="auditList"></div>
      <div class="mt-2">
        <button id="exportAuditBtn" class="btn btn-sm btn-outline-secondary">Exportar / Anonimizar (mock)</button>
      </div>
    </section>

    <!-- GLOSSARY -->
    <section id="glossarySection" class="card mb-3 p-3 hidden">
      <h5>Glossário</h5>
      <dl class="glossary">
        <dt>CMV</dt><dd>Custo Médio de Venda. No contexto aqui é apenas um exemplo.</dd>
        <dt>Ticket Médio</dt><dd>Receita média por atendimento.</dd>
        <dt>LGPD</dt><dd>Lei Geral de Proteção de Dados — respeite a privacidade dos pacientes.</dd>
      </dl>
    </section>

    <!-- README -->
    <section id="readmeSection" class="card mb-3 p-3 hidden">
      <h5>README (interno)</h5>
      <p>Deploy no GitHub Pages:</p>
      <ol>
        <li>Crie repositório.</li>
        <li>Enviar apenas index.html para a branch main.</li>
        <li>Ativar GitHub Pages → branch main → / (root).</li>
      </ol>
      <h6>Como transformar em SaaS real</h6>
      <ul>
        <li>Implementar backend (Node/Python/Go) com autenticação e armazenamento central.</li>
        <li>Upload automático do SQLite ou migrar para RDBMS/Cloud DB.</li>
        <li>Servir arquivos por CDN e controlar RBAC no backend.</li>
      </ul>
    </section>
  </div>

  <!-- Hidden file input for sqlite import fallback -->
  <input id="sqliteFileInput" type="file" accept=".sqlite,.db" class="hidden" />

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs@1.11.0/dist/interact.min.js"></script>

  <!-- sql.js (WASM) -->
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>

  <script>
    // Globals
    let SQL = null;
    let db = null;
    let currentUser = null;
    let currentOrgId = null;
    let quill = null;
    let charts = {};
    const simulatedIP = () => '192.0.2.' + Math.floor(Math.random()*255);
    const nowISO = () => new Date().toISOString();

    // Initialize sql.js
    async function initEngine() {
      try {
        SQL = await initSqlJs({ locateFile: file => 'https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.wasm' });
        // Try to prompt for file (File System Access API) cautiously
        try {
          if ('showOpenFilePicker' in window) {
            // We don't auto-open picker to avoid blocking; show a non-blocking prompt in UI instead.
            console.log('File System Access API available.');
          }
        } catch(e){console.warn(e);}
        await initDB(); // create in-memory DB with seeds if needed
        uiInit();
        flash('Banco inicializado (em memória). Faça export .sqlite para salvar.', 'info');
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar SQLite WASM: ' + err.message);
      }
    }

    // Create schema + seeds
    async function initDB({seed=true} = {}) {
      if(!SQL) return;
      db = new SQL.Database();
      // Schema
      const schema = `
      PRAGMA foreign_keys = ON;
      CREATE TABLE organizations (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, created_at TEXT);
      CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, organization_id INTEGER, name TEXT, email TEXT UNIQUE, password TEXT, role TEXT, created_at TEXT, FOREIGN KEY(organization_id) REFERENCES organizations(id));
      CREATE TABLE patients (id INTEGER PRIMARY KEY AUTOINCREMENT, organization_id INTEGER, nome TEXT, cpf TEXT, data_nasc TEXT, sexo TEXT, telefone TEXT, email TEXT, endereco TEXT, emergencia TEXT, alergias TEXT, historico TEXT, tags TEXT, observacoes TEXT, status TEXT, consentimento INTEGER, created_at TEXT, updated_at TEXT, ip TEXT, FOREIGN KEY(organization_id) REFERENCES organizations(id));
      CREATE TABLE evolutions (id INTEGER PRIMARY KEY AUTOINCREMENT, organization_id INTEGER, patient_id INTEGER, professional_id INTEGER, content TEXT, created_at TEXT, FOREIGN KEY(organization_id) REFERENCES organizations(id), FOREIGN KEY(patient_id) REFERENCES patients(id));
      CREATE TABLE evolution_versions (id INTEGER PRIMARY KEY AUTOINCREMENT, evolution_id INTEGER, content TEXT, created_at TEXT);
      CREATE TABLE files (id INTEGER PRIMARY KEY AUTOINCREMENT, organization_id INTEGER, patient_id INTEGER, filename TEXT, mime TEXT, data_base64 TEXT, created_at TEXT);
      CREATE TABLE appointments (id INTEGER PRIMARY KEY AUTOINCREMENT, organization_id INTEGER, patient_id INTEGER, professional_id INTEGER, data_hora TEXT, duracao INTEGER, sala TEXT, status TEXT, notas TEXT);
      CREATE TABLE billing_subscriptions (id INTEGER PRIMARY KEY AUTOINCREMENT, organization_id INTEGER, user_id INTEGER, plan TEXT, started_at TEXT, trial_until TEXT, status TEXT);
      CREATE TABLE audit_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER, action TEXT, table_name TEXT, row_id TEXT, timestamp TEXT, ip TEXT, userAgent TEXT);
      `;
      db.exec(schema);

      if (seed) {
        // Seeds
        db.run("INSERT INTO organizations (name, created_at) VALUES (?,?)", ['Clinica Demo', nowISO()]);
        const orgId = db.exec("SELECT id FROM organizations")[0].values[0][0];
        db.run("INSERT INTO users (organization_id,name,email,password,role,created_at) VALUES (?,?,?,?,?,?)", [orgId, 'Owner Demo','owner@demo.local','ownerpass','owner', nowISO()]);
        db.run("INSERT INTO users (organization_id,name,email,password,role,created_at) VALUES (?,?,?,?,?,?)", [orgId, 'Dr. Profissional','pro@demo.local','propass','professional', nowISO()]);
        // 5 patients
        const patients = [
          ['João Silva','12345678901','1980-05-10','M','(11)99999-0001','joao@demo.local','Rua A, 1','Contato: Maria','Nenhuma','Histórico A','tag1,tag2','Obs privada','active',1],
          ['Maria Oliveira','98765432100','1992-08-21','F','(11)99999-0002','maria@demo.local','Rua B, 2','Contato: José','Penicilina','Histórico B','tag3','Obs','active',1],
          ['Carlos Pereira','11122233344','1975-02-15','M','(11)99999-0003','carlos@demo.local','Av C, 10','Contato: Ana','Nenhuma','Histórico C','tag2','Obs','active',1],
          ['Ana Souza','22233344455','2000-11-11','F','(11)99999-0004','ana@demo.local','R. D, 5','Contato: Paulo','Alergia X','Histórico D','tag4','Obs','active',1],
          ['Paulo Lima','33344455566','1985-03-03','M','(11)99999-0005','paulo@demo.local','Travessa E, 7','Contato: Rita','Nenhuma','Histórico E','tag5','Obs','active',1]
        ];
        let stmt = db.prepare("INSERT INTO patients (organization_id,nome,cpf,data_nasc,sexo,telefone,email,endereco,emergencia,alergias,historico,tags,observacoes,status,consentimento,created_at,updated_at,ip) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
        for(let p of patients){
          stmt.run([orgId, ...p, nowISO(), nowISO(), simulatedIP()]);
        }
        stmt.free();
        // 6 evolutions
        const pats = db.exec("SELECT id FROM patients")[0].values.map(r=>r[0]);
        for(let i=0;i<6;i++){
          const pid = pats[i%pats.length];
          db.run("INSERT INTO evolutions (organization_id,patient_id,professional_id,content,created_at) VALUES (?,?,?,?,?)", [orgId, pid, 2, `Evolução inicial ${i+1} para paciente ${pid}`, nowISO()]);
        }
        // versions
        const evos = db.exec("SELECT id, content FROM evolutions").length ? db.exec("SELECT id, content FROM evolutions")[0].values : [];
        for(let e of evos){
          db.run("INSERT INTO evolution_versions (evolution_id, content, created_at) VALUES (?,?,?)", [e[0], e[1], nowISO()]);
        }
        // 5 appointments
        for(let i=0;i<5;i++){
          const pid = pats[i%pats.length];
          db.run("INSERT INTO appointments (organization_id,patient_id,professional_id,data_hora,duracao,sala,status,notas) VALUES (?,?,?,?,?,?,?,?)",
            [orgId, pid, 2, new Date(Date.now() + i*3600*1000).toISOString(), 30, 'Sala A', i%4===0?'miss':'confirmed', 'Agendamento seed']);
        }
        // billing mock
        db.run("INSERT INTO billing_subscriptions (organization_id,user_id,plan,started_at,trial_until,status) VALUES (?,?,?,?,?,?)", [orgId,1,'Starter', nowISO(), new Date(Date.now()+30*24*3600*1000).toISOString(), 'trial']);
      }
      // default currentOrg
      const orgs = db.exec("SELECT id,name FROM organizations");
      if (orgs && orgs[0] && orgs[0].values.length) {
        currentOrgId = orgs[0].values[0][0];
      }
      auditLog(null, 'init_db', 'database', null);
    }

    // Load DB from .sqlite file (File or ArrayBuffer)
    async function loadDBFromFile(file) {
      try {
        const ab = await file.arrayBuffer();
        db = new SQL.Database(new Uint8Array(ab));
        // pick first organization if exists
        const orgs = db.exec("SELECT id FROM organizations");
        if (orgs && orgs[0] && orgs[0].values.length) currentOrgId = orgs[0].values[0][0];
        uiInit();
        flash('Banco .sqlite carregado com sucesso.', 'success');
        auditLog(currentUser?.id || null, 'load_db', 'database', null);
      } catch (e) {
        console.error(e); flash('Erro ao carregar .sqlite: ' + e.message, 'danger');
      }
    }

    // Export DB to .sqlite (download)
    function exportDB() {
      if(!db){ flash('Nenhum banco carregado', 'warning'); return; }
      const binary = db.export();
      const blob = new Blob([binary], {type: 'application/x-sqlite3'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'prontuario.sqlite';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      auditLog(currentUser?.id || null, 'export_db', 'database', null);
      flash('Arquivo .sqlite exportado. Faça backup!', 'success');
    }

    // Backup to JSON
    function backupToJSON() {
      if(!db){ flash('Nenhum banco', 'warning'); return; }
      const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'")[0].values.map(r=>r[0]);
      const out = {};
      for(const t of tables){
        try{
          const res = db.exec(`SELECT * FROM ${t}`);
          if(res && res[0]){
            const cols = res[0].columns;
            out[t] = res[0].values.map(row=>{
              const o = {};
              for(let i=0;i<cols.length;i++) o[cols[i]] = row[i];
              return o;
            });
          } else out[t] = [];
        } catch(e){ out[t] = []; }
      }
      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      auditLog(currentUser?.id || null, 'backup_json', 'database', null);
      flash('Backup JSON baixado.', 'success');
    }

    // Restore from JSON (structure must match)
    function restoreFromJSONFile(file) {
      file.text().then(txt=>{
        try{
          const obj = JSON.parse(txt);
          // naive restore: drop all, recreate via schema (assumes same schema)
          initDB({seed:false}); // resets schema in memory
          // insert tables
          for(const t of Object.keys(obj)){
            if(!Array.isArray(obj[t])) continue;
            const rows = obj[t];
            if(rows.length===0) continue;
            const cols = Object.keys(rows[0]);
            const placeholders = cols.map(()=>'?').join(',');
            const stmt = db.prepare(`INSERT INTO ${t} (${cols.join(',')}) VALUES (${placeholders})`);
            db.run("BEGIN");
            for(const r of rows){ stmt.run(cols.map(c=>r[c])); }
            db.run("COMMIT");
            stmt.free();
          }
          flash('Restaurado JSON no DB em memória.', 'success');
          auditLog(currentUser?.id || null, 'restore_json', 'database', null);
          uiInit();
        } catch(e){
          flash('Erro ao restaurar JSON: ' + e.message, 'danger');
        }
      });
    }

    // Reset DB with confirmation
    async function resetDB() {
      if(!confirm('Confirmar reset do banco para estado limpo com seeds? Isso perderá o banco atual em memória.')) return;
      await initDB({seed:true});
      uiInit();
      flash('DB reiniciado com seeds.', 'success');
      auditLog(currentUser?.id || null, 'reset_db', 'database', null);
    }

    // UI and interactions
    function uiInit(){
      // Populate org select
      const orgs = db.exec("SELECT id,name FROM organizations");
      const sel = document.getElementById('orgSelect');
      sel.innerHTML = '';
      if(orgs && orgs[0]){
        for(const row of orgs[0].values){
          const opt = document.createElement('option');
          opt.value = row[0]; opt.textContent = row[1];
          sel.appendChild(opt);
        }
        if(!currentOrgId) currentOrgId = orgs[0].values[0][0];
        sel.value = currentOrgId;
      } else {
        const opt = document.createElement('option'); opt.textContent='-- Sem organização --'; sel.appendChild(opt);
      }
      sel.onchange = (e)=>{ currentOrgId = Number(e.target.value); refreshAll(); }
      // Setup user area
      refreshUsersList();
      // init sections
      initPatientsUI();
      initEvolutionsUI();
      initAgendaUI();
      initFilesUI();
      initBillingUI();
      initDashboard();
      initAuditUI();
      bindNavLinks();
    }

    // Flash messages
    function flash(msg, type='info', timeout=4000){
      const div = document.getElementById('flash');
      div.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
      if(timeout) setTimeout(()=>{ if(div) div.innerHTML=''; }, timeout);
    }

    // AUDIT
    function auditLog(userId, action, table, rowId){
      try{
        db.run("INSERT INTO audit_logs (user_id,action,table_name,row_id,timestamp,ip,userAgent) VALUES (?,?,?,?,?,?,?)",
          [userId, action, table, rowId, nowISO(), simulatedIP(), navigator.userAgent.slice(0,120)]);
      } catch(e){ console.warn('auditLog failed', e); }
    }

    // USERS / Auth (local + mock Google)
    function refreshUsersList(){
      // If there's a logged in user, show info
      const ui = document.getElementById('userInfo');
      const userBtn = document.getElementById('userBtn');
      if(currentUser){
        ui.classList.remove('hidden');
        document.getElementById('userNameDisplay').textContent = currentUser.name;
        document.getElementById('userEmailDisplay').textContent = currentUser.email;
        document.getElementById('userRoleDisplay').textContent = '(' + currentUser.role + ')';
        userBtn.textContent = currentUser.name;
      } else {
        ui.classList.add('hidden');
        userBtn.textContent = 'Entrar';
      }
    }

    function loginLocal(email, password){
      try{
        const res = db.exec("SELECT id, organization_id,name,email,role FROM users WHERE email = ? AND password = ?", [email, password]);
        if(res && res[0] && res[0].values.length){
          const r = res[0].values[0];
          currentUser = { id:r[0], organization_id:r[1], name:r[2], email:r[3], role:r[4] };
          currentOrgId = currentUser.organization_id;
          auditLog(currentUser.id, 'login_local', 'users', currentUser.id);
          uiInit(); refreshAll();
          flash('Login efetuado: ' + currentUser.name, 'success');
        } else {
          flash('Credenciais inválidas', 'danger');
        }
      } catch(e){ flash('Erro login: '+e.message,'danger'); }
    }
    function signupLocal(name,email,password){
      try{
        db.run("INSERT INTO users (organization_id,name,email,password,role,created_at) VALUES (?,?,?,?,?,?)", [currentOrgId, name, email, password, 'viewer', nowISO()]);
        flash('Conta criada. Faça login.', 'success');
        auditLog(null, 'signup', 'users', null);
      } catch(e){ flash('Erro criar usuário: ' + e.message, 'danger'); }
    }
    function googleMockSignIn(){
      // Simulate OAuth response
      const mocked = { name: 'Google User', email: 'google.user@mock.local' };
      // create user if not exists
      try{
        const res = db.exec("SELECT id,name,role FROM users WHERE email = ?", [mocked.email]);
        if(res && res[0] && res[0].values.length){
          const r = res[0].values[0];
          currentUser = { id:r[0], name:r[1], email:mocked.email, role:r[2] };
        } else {
          db.run("INSERT INTO users (organization_id,name,email,password,role,created_at) VALUES (?,?,?,?,?,?)", [currentOrgId, mocked.name, mocked.email, 'oauth-mock', 'viewer', nowISO()]);
          const id = db.exec("SELECT id FROM users WHERE email = ?", [mocked.email])[0].values[0][0];
          currentUser = { id, name:mocked.name, email:mocked.email, role:'viewer' };
        }
        auditLog(currentUser.id, 'google_mock_signin', 'users', currentUser.id);
        uiInit(); refreshAll();
        flash('Login Google (mock) efetuado. Instruções para integrar: veja README.', 'info');
      } catch(e){ flash('Erro Google mock: '+e.message,'danger'); }
    }

    function logout(){
      auditLog(currentUser?.id || null, 'logout', 'users', currentUser?.id || null);
      currentUser = null; refreshUsersList(); flash('Logout efetuado','info'); refreshAll();
    }

    // RBAC check
    function requiresRole(roles){
      const allowed = Array.isArray(roles) ? roles : [roles];
      return currentUser && allowed.includes(currentUser.role);
    }

    // PATIENTS UI
    function initPatientsUI(){
      document.getElementById('patientsSection').classList.remove('hidden');
      document.getElementById('newPatientBtn').onclick = ()=>{ showPatientForm(); };
      document.getElementById('patientCancelBtn').onclick = ()=>{ hidePatientForm(); };
      document.getElementById('patientForm').onsubmit = savePatient;
      document.getElementById('patientDeleteBtn').onclick = deletePatient;
      document.getElementById('patientSearch').oninput = refreshPatientsList;
      document.getElementById('importCsvBtn').onclick = importPatientsCSV;
      document.getElementById('exportCsvBtn').onclick = exportPatientsCSV;
      document.getElementById('exportPatientsJsonBtn').onclick = exportPatientsJSON;
      refreshPatientsList();
    }

    function refreshPatientsList(){
      const q = document.getElementById('patientSearch').value.toLowerCase();
      const res = db.exec("SELECT id,nome,cpf,telefone,email,created_at FROM patients WHERE organization_id = ? ORDER BY nome", [currentOrgId]);
      const list = document.getElementById('patientsList'); list.innerHTML='';
      if(res && res[0]){
        for(const r of res[0].values){
          const id=r[0], nome=r[1], cpf=r[2];
          if(q && !(nome.toLowerCase().includes(q) || (cpf||'').includes(q))) continue;
          const el = document.createElement('div'); el.className='card p-2 mb-1';
          el.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${nome}</strong><div class="small-muted">${cpf}</div></div><div><button class="btn btn-sm btn-outline-primary" data-id="${id}">Abrir</button></div></div>`;
          el.querySelector('button').onclick = ()=>{ loadPatient(id); };
          list.appendChild(el);
        }
      }
    }

    function showPatientForm(data){
      document.getElementById('patientFormArea').classList.remove('hidden');
      document.getElementById('patientFormTitle').textContent = data ? 'Editar Paciente' : 'Novo Paciente';
      if(data){
        document.getElementById('patient_id').value = data.id;
        document.getElementById('p_nome').value = data.nome;
        document.getElementById('p_cpf').value = data.cpf;
        document.getElementById('p_data_nasc').value = data.data_nasc || '';
        document.getElementById('p_sexo').value = data.sexo || '';
        document.getElementById('p_telefone').value = data.telefone || '';
        document.getElementById('p_email').value = data.email || '';
        document.getElementById('p_endereco').value = data.endereco || '';
        document.getElementById('p_observacoes').value = data.observacoes || '';
      } else {
        document.getElementById('patientForm').reset();
        document.getElementById('patient_id').value = '';
      }
    }
    function hidePatientForm(){
      document.getElementById('patientFormArea').classList.add('hidden');
    }
    function loadPatient(id){
      const res = db.exec("SELECT * FROM patients WHERE id = ?", [id]);
      if(res && res[0] && res[0].values.length){
        const cols = res[0].columns;
        const vals = res[0].values[0];
        const obj = {}; for(let i=0;i<cols.length;i++) obj[cols[i]] = vals[i];
        showPatientForm(obj);
        // also switch to evolutions filter
        document.querySelector('a[data-target="evolutions"]').click();
        document.getElementById('evoPatientFilter').value = id;
        refreshEvolutionsList();
      }
    }
    function savePatient(e){
      e.preventDefault();
      const id = document.getElementById('patient_id').value;
      const payload = {
        nome:document.getElementById('p_nome').value,
        cpf:document.getElementById('p_cpf').value,
        data_nasc:document.getElementById('p_data_nasc').value,
        sexo:document.getElementById('p_sexo').value,
        telefone:document.getElementById('p_telefone').value,
        email:document.getElementById('p_email').value,
        endereco:document.getElementById('p_endereco').value,
        observacoes:document.getElementById('p_observacoes').value,
      };
      try{
        if(id){
          const stmt = db.prepare("UPDATE patients SET nome=?,cpf=?,data_nasc=?,sexo=?,telefone=?,email=?,endereco=?,observacoes=?,updated_at=?,ip=? WHERE id = ?");
          stmt.run([payload.nome,payload.cpf,payload.data_nasc,payload.sexo,payload.telefone,payload.email,payload.endereco,payload.observacoes, nowISO(), simulatedIP(), id]);
          stmt.free();
          auditLog(currentUser?.id || null, 'update_patient', 'patients', id);
          flash('Paciente atualizado','success');
        } else {
          const stmt = db.prepare("INSERT INTO patients (organization_id,nome,cpf,data_nasc,sexo,telefone,email,endereco,observacoes,status,consentimento,created_at,updated_at,ip) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
          stmt.run([currentOrgId, payload.nome,payload.cpf,payload.data_nasc,payload.sexo,payload.telefone,payload.email,payload.endereco,payload.observacoes,'active',1,nowISO(),nowISO(),simulatedIP()]);
          stmt.free();
          auditLog(currentUser?.id || null, 'create_patient', 'patients', null);
          flash('Paciente criado','success');
        }
        hidePatientForm(); refreshPatientsList(); refreshEvolutionsList(); refreshFilesList(); refreshDashboard();
      } catch(e){ flash('Erro salvar paciente: '+e.message,'danger'); }
    }
    function deletePatient(){
      const id = document.getElementById('patient_id').value;
      if(!id) return;
      if(!confirm('Excluir paciente ID ' + id + '?')) return;
      try{
        db.run("DELETE FROM patients WHERE id = ?", [id]);
        auditLog(currentUser?.id || null, 'delete_patient', 'patients', id);
        flash('Paciente excluído','success');
        hidePatientForm(); refreshPatientsList(); refreshEvolutionsList(); refreshFilesList(); refreshDashboard();
      } catch(e){ flash('Erro excluir: '+e.message,'danger'); }
    }

    function importPatientsCSV(){
      const input = document.createElement('input'); input.type='file'; input.accept='.csv';
      input.onchange = ()=> {
        const f = input.files[0];
        f.text().then(txt=>{
          const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
          if(lines.length<1) return;
          const headers = lines[0].split(',');
          db.run("BEGIN");
          const insert = db.prepare("INSERT INTO patients (organization_id,nome,cpf,created_at,updated_at,ip) VALUES (?,?,?,?,?,?)");
          for(let i=1;i<lines.length;i++){
            const vals = lines[i].split(',');
            const nome = vals[0]||('Paciente '+i);
            const cpf = vals[1]||'';
            insert.run([currentOrgId,nome,cpf, nowISO(), nowISO(), simulatedIP()]);
          }
          db.run("COMMIT");
          insert.free();
          flash('CSV importado','success'); refreshPatientsList();
          auditLog(currentUser?.id || null, 'import_csv', 'patients', null);
        });
      };
      input.click();
    }

    function exportPatientsCSV(){
      const res = db.exec("SELECT nome,cpf,data_nasc,telefone,email FROM patients WHERE organization_id = ?", [currentOrgId]);
      const rows = [ ['nome','cpf','data_nasc','telefone','email'] ];
      if(res && res[0]){
        for(const r of res[0].values) rows.push(r);
      }
      const csv = rows.map(r=>r.map(c=>'"'+String(c||'').replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='patients.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      auditLog(currentUser?.id || null, 'export_csv', 'patients', null);
      flash('CSV preparado para download','success');
    }

    function exportPatientsJSON(){
      const res = db.exec("SELECT * FROM patients WHERE organization_id = ?", [currentOrgId]);
      const out = [];
      if(res && res[0]) {
        const cols = res[0].columns;
        for(const r of res[0].values){
          const obj = {};
          for(let i=0;i<cols.length;i++) obj[cols[i]] = r[i];
          out.push(obj);
        }
      }
      const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='patients.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      auditLog(currentUser?.id || null, 'export_json', 'patients', null);
      flash('JSON de pacientes gerado','success');
    }

    // EVOLUTIONS UI
    function initEvolutionsUI(){
      document.getElementById('evolutionsSection').classList.remove('hidden');
      quill = new Quill('#quillEditor', { theme: 'snow' });
      document.getElementById('newEvolutionBtn').onclick = ()=>{ showEvolutionEditor(); };
      document.getElementById('saveEvolutionBtn').onclick = saveEvolution;
      document.getElementById('cancelEvolutionBtn').onclick = ()=>{ hideEvolutionEditor(); };
      document.getElementById('evoPatientFilter').onchange = refreshEvolutionsList;
      document.getElementById('evoAttachInput').onchange = (e)=>{ /* handled in save */ };
      document.getElementById('exportEvolutionsPdfBtn').onclick = exportEvolutionsPDF;
      refreshEvolutionsList();
    }

    function refreshEvolutionsList(){
      const pid = document.getElementById('evoPatientFilter').value;
      const stmt = pid ? db.exec("SELECT id,patient_id,content,created_at FROM evolutions WHERE organization_id = ? AND patient_id = ? ORDER BY created_at DESC", [currentOrgId, pid]) : db.exec("SELECT id,patient_id,content,created_at FROM evolutions WHERE organization_id = ? ORDER BY created_at DESC", [currentOrgId]);
      const list = document.getElementById('evolutionsList'); list.innerHTML='';
      if(stmt && stmt[0]){
        for(const r of stmt[0].values){
          const id=r[0], patient_id=r[1], content=(r[2]||'').slice(0,120);
          const el = document.createElement('div'); el.className='card p-2 mb-1';
          el.innerHTML = `<div class="d-flex justify-content-between"><div><strong>Paciente #${patient_id}</strong><div class="small-muted">${content}</div></div><div><button class="btn btn-sm btn-outline-primary" data-id="${id}">Abrir</button></div></div>`;
          el.querySelector('button').onclick = ()=>{ openEvolution(id); };
          list.appendChild(el);
        }
      }
      // fill patient filter
      const pf = document.getElementById('evoPatientFilter'); pf.innerHTML = '<option value="">-- Filtrar por paciente --</option>';
      const pats = db.exec("SELECT id,nome FROM patients WHERE organization_id = ?", [currentOrgId]);
      if(pats && pats[0]) for(const r of pats[0].values){ const o=document.createElement('option'); o.value=r[0]; o.textContent=`${r[1]} (#${r[0]})`; pf.appendChild(o); }
    }

    function showEvolutionEditor(evo){
      document.getElementById('evolutionEditorArea').classList.remove('hidden');
      document.getElementById('evolutionTitle').textContent = evo ? 'Editar Evolução' : 'Nova Evolução';
      if(evo){
        quill.root.innerHTML = evo.content;
        document.getElementById('saveEvolutionBtn').dataset.evoId = evo.id;
        loadEvolutionVersions(evo.id);
      } else { quill.root.innerHTML = ''; document.getElementById('saveEvolutionBtn').dataset.evoId=''; document.getElementById('evoVersions').innerHTML=''; }
    }
    function hideEvolutionEditor(){ document.getElementById('evolutionEditorArea').classList.add('hidden'); }
    function openEvolution(id){
      const res = db.exec("SELECT id,patient_id,content FROM evolutions WHERE id = ?", [id]);
      if(res && res[0] && res[0].values.length){
        const r = res[0].values[0];
        document.getElementById('evoPatientFilter').value = r[1];
        showEvolutionEditor({id:r[0],patient_id:r[1],content:r[2]});
        loadEvolutionVersions(r[0]);
      }
    }
    function saveEvolution(){
      const evoId = this.dataset.evoId;
      const content = quill.root.innerHTML;
      const patientId = document.getElementById('evoPatientFilter').value;
      if(!patientId){ flash('Selecione um paciente para vincular a evolução.','warning'); return; }
      if(evoId){
        db.run("UPDATE evolutions SET content=?, updated_at=? WHERE id = ?", [content, nowISO(), evoId]);
        db.run("INSERT INTO evolution_versions (evolution_id,content,created_at) VALUES (?,?,?)", [evoId, content, nowISO()]);
        auditLog(currentUser?.id || null, 'update_evolution', 'evolutions', evoId);
        flash('Evolução atualizada e versão salva.','success');
      } else {
        db.run("INSERT INTO evolutions (organization_id,patient_id,professional_id,content,created_at) VALUES (?,?,?,?,?)", [currentOrgId, patientId, currentUser?.id || null, content, nowISO()]);
        const newId = db.exec("SELECT last_insert_rowid()")[0].values[0][0];
        db.run("INSERT INTO evolution_versions (evolution_id,content,created_at) VALUES (?,?,?)", [newId, content, nowISO()]);
        auditLog(currentUser?.id || null, 'create_evolution', 'evolutions', newId);
        flash('Evolução criada','success');
      }
      hideEvolutionEditor(); refreshEvolutionsList(); refreshDashboard();
    }

    function loadEvolutionVersions(evolutionId){
      const res = db.exec("SELECT id,content,created_at FROM evolution_versions WHERE evolution_id = ? ORDER BY created_at DESC", [evolutionId]);
      const area = document.getElementById('evoVersions'); area.innerHTML='';
      if(res && res[0]){
        for(const r of res[0].values){
          const id=r[0], content=r[1], created=r[2];
          const div = document.createElement('div'); div.className='card p-2 mb-1';
          div.innerHTML = `<div class="d-flex justify-content-between"><div class="small-muted">${created}</div><div><button class="btn btn-sm btn-outline-secondary">Ver diffs</button></div></div><div class="mt-2">${content}</div>`;
          div.querySelector('button').onclick = ()=>{ showDiff(evolutionId, id); };
          area.appendChild(div);
        }
      }
    }

    function showDiff(evolutionId, versionId){
      // simple textual diff: compare with previous version
      const curr = db.exec("SELECT content FROM evolution_versions WHERE id = ?", [versionId])[0].values[0][0];
      const prevRes = db.exec("SELECT content FROM evolution_versions WHERE evolution_id = ? AND id < ? ORDER BY id DESC LIMIT 1", [evolutionId, versionId]);
      const prev = prevRes && prevRes[0] && prevRes[0].values.length ? prevRes[0].values[0][0] : '';
      // simple diff: show lines present in curr not in prev and vice versa
      const a = prev.split(/[\r\n]+/);
      const b = curr.split(/[\r\n]+/);
      const added = b.filter(x=>!a.includes(x)).map(l=>`+ ${escapeHtml(l)}`).join('<br>');
      const removed = a.filter(x=>!b.includes(x)).map(l=>`- ${escapeHtml(l)}`).join('<br>');
      const modal = createModal('Diff versão', `<div><h6>Adicionado</h6><div style="color:green">${added||'<em>nenhum</em>'}</div><h6>Removido</h6><div style="color:red">${removed||'<em>nenhum</em>'}</div></div>`);
      modal.show();
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    // FILES UI
    function initFilesUI(){
      document.getElementById('filesSection').classList.remove('hidden');
      document.getElementById('uploadFileBtn').onclick = uploadFileToDB;
      refreshFilesList();
    }

    function uploadFileToDB(){
      const input = document.getElementById('fileUploadInput');
      const file = input.files[0];
      const patientId = document.getElementById('filesPatientFilter').value;
      if(!file) { flash('Selecione um arquivo','warning'); return; }
      if(!patientId){ flash('Selecione um paciente primeiro','warning'); return; }
      const reader = new FileReader();
      reader.onload = ()=>{
        const base64 = reader.result.split(',')[1];
        db.run("INSERT INTO files (organization_id,patient_id,filename,mime,data_base64,created_at) VALUES (?,?,?,?,?,?)", [currentOrgId, patientId, file.name, file.type, base64, nowISO()]);
        auditLog(currentUser?.id || null, 'upload_file', 'files', null);
        flash('Arquivo salvo no banco (base64)','success'); refreshFilesList();
      };
      reader.readAsDataURL(file);
    }

    function refreshFilesList(){
      const fl = document.getElementById('filesList'); fl.innerHTML='';
      const pf = document.getElementById('filesPatientFilter'); pf.innerHTML = '<option value="">-- Selecionar paciente --</option>';
      const pats = db.exec("SELECT id,nome FROM patients WHERE organization_id = ?", [currentOrgId]);
      if(pats && pats[0]) for(const r of pats[0].values){ const o=document.createElement('option'); o.value=r[0]; o.textContent=`${r[1]} (#${r[0]})`; pf.appendChild(o); }
      const pid = pf.value || (pats && pats[0] && pats[0].values[0] && pats[0].values[0][0]);
      if(!pid) return;
      const res = db.exec("SELECT id,filename,mime,data_base64,created_at FROM files WHERE organization_id = ? AND patient_id = ?", [currentOrgId, pid]);
      if(res && res[0]){
        for(const r of res[0].values){
          const id=r[0], filename=r[1], mime=r[2], data=r[3];
          const div = document.createElement('div'); div.className='card p-2 mb-1';
          let preview = '';
          if(mime.startsWith('image/')) preview = `<img src="data:${mime};base64,${data}" class="file-preview">`;
          else if(mime === 'application/pdf') preview = `<iframe src="data:${mime};base64,${data}" style="width:100%;height:200px;"></iframe>`;
          else preview = `<div class="small-muted">${mime}</div>`;
          div.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${filename}</strong><div class="small-muted">${r[4]}</div></div><div><button class="btn btn-sm btn-outline-success">Download</button></div></div><div class="mt-2">${preview}</div>`;
          div.querySelector('button').onclick = ()=>{
            const blob = base64ToBlob(data, mime);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          };
          fl.appendChild(div);
        }
      }
    }

    function base64ToBlob(base64, mime){
      const bytes = atob(base64);
      let buf = new Uint8Array(bytes.length);
      for(let i=0;i<bytes.length;i++) buf[i]=bytes.charCodeAt(i);
      return new Blob([buf], {type:mime});
    }

    // AGENDA UI (simple)
    function initAgendaUI(){
      document.getElementById('agendaSection').classList.remove('hidden');
      document.getElementById('newApptBtn').onclick = createNewAppointment;
      document.getElementById('viewDayBtn').onclick = ()=>renderAgenda('day');
      document.getElementById('viewWeekBtn').onclick = ()=>renderAgenda('week');
      document.getElementById('viewMonthBtn').onclick = ()=>renderAgenda('month');
      renderAgenda('day');
    }

    function renderAgenda(view='day'){
      const timeSlots = document.getElementById('timeSlots'); timeSlots.innerHTML='';
      for(let h=8;h<=18;h++){
        const slot = document.createElement('div'); slot.className='drag-slot'; slot.dataset.time = `${h}:00`;
        slot.innerHTML = `<strong>${h}:00</strong><div class="slot-body" data-time="${h}:00"></div>`;
        timeSlots.appendChild(slot);
      }
      const apArea = document.getElementById('appointmentsArea'); apArea.innerHTML='';
      const res = db.exec("SELECT id,patient_id,professional_id,data_hora,duracao,status FROM appointments WHERE organization_id = ? ORDER BY data_hora", [currentOrgId]);
      if(res && res[0]){
        for(const r of res[0].values){
          const id=r[0], pid=r[1], prof=r[2], date=r[3], dur=r[4], status=r[5];
          const dt = new Date(date); const hour = dt.getHours();
          const el = document.createElement('div'); el.className='appointment'; el.dataset.id=id; el.innerHTML = `<strong>#${id}</strong> Paciente:${pid} Prof:${prof} <div class="small-muted">${dt.toLocaleString()}</div>`;
          el.draggable = true;
          el.ondragstart = (ev)=>{ ev.dataTransfer.setData('text/plain', id); };
          // find slot
          const slot = [...document.querySelectorAll('.slot-body')].find(s=>s.dataset.time.startsWith(hour+':'));
          if(slot) slot.appendChild(el);
          apArea.appendChild(el);
        }
      }
      // Make slots droppable (Interact.js)
      interact('.slot-body').dropzone({
        accept: '.appointment',
        ondrop: function (event) {
          const apId = event.relatedTarget.dataset.id;
          const targetTime = event.target.dataset.time;
          // set appointment to today at that hour
          const dt = new Date(); const parts = targetTime.split(':'); dt.setHours(Number(parts[0])); dt.setMinutes(0); dt.setSeconds(0);
          db.run("UPDATE appointments SET data_hora = ? WHERE id = ?", [dt.toISOString(), apId]);
          auditLog(currentUser?.id || null, 'move_appointment', 'appointments', apId);
          flash('Agendamento movido para ' + dt.toLocaleString(), 'success');
          renderAgenda(view);
        }
      });
    }

    function createNewAppointment(){
      const pid = prompt('ID do paciente para agendar:');
      if(!pid) return;
      const dt = prompt('Data/Hora (ISO ou vazio para agora):');
      const iso = dt ? new Date(dt).toISOString() : new Date().toISOString();
      db.run("INSERT INTO appointments (organization_id,patient_id,professional_id,data_hora,duracao,sala,status,notas) VALUES (?,?,?,?,?,?,?,?)", [currentOrgId, pid, currentUser?.id || null, iso, 30, 'Sala A', 'confirmed', 'Criado manual']);
      auditLog(currentUser?.id || null, 'create_appointment', 'appointments', null);
      flash('Agendamento criado', 'success'); renderAgenda();
    }

    // BILLING UI
    function initBillingUI(){
      document.getElementById('billingSection').classList.remove('hidden');
      document.getElementById('subscribeStarter').onclick = ()=>subscribePlan('Starter');
      document.getElementById('subscribePro').onclick = ()=>subscribePlan('Pro');
      document.getElementById('subscribeClinic').onclick = ()=>subscribePlan('Clinic');
      refreshBillingInfo();
    }
    function subscribePlan(plan){
      db.run("INSERT INTO billing_subscriptions (organization_id,user_id,plan,started_at,trial_until,status) VALUES (?,?,?,?,?,?)", [currentOrgId, currentUser?.id || null, plan, nowISO(), new Date(Date.now()+30*24*3600*1000).toISOString(), 'active']);
      auditLog(currentUser?.id || null, 'subscribe', 'billing_subscriptions', null);
      flash('Inscrito no plano ' + plan + ' (mock).', 'success'); refreshBillingInfo();
    }
    function refreshBillingInfo(){
      const res = db.exec("SELECT plan,started_at,trial_until,status FROM billing_subscriptions WHERE organization_id = ? ORDER BY id DESC LIMIT 1", [currentOrgId]);
      const area = document.getElementById('billingInfo'); area.innerHTML = '';
      if(res && res[0] && res[0].values.length){
        const r = res[0].values[0];
        area.innerHTML = `<div>Plano: <strong>${r[0]}</strong><br/>Iniciado: ${r[1]}<br/>Trial até: ${r[2]}<br/>Status: ${r[3]}</div>`;
      } else area.innerHTML = '<div class="small-muted">Nenhuma assinatura (mock)</div>';
    }

    // DASHBOARD
    function initDashboard(){
      document.getElementById('dashboardSection').classList.remove('hidden');
      refreshDashboard();
    }
    function refreshDashboard(){
      // Chart: appointments per day (last 7 days)
      const apptsRes = db.exec("SELECT date(data_hora) as dia, count(*) as cnt FROM appointments WHERE organization_id = ? GROUP BY date(data_hora) ORDER BY dia DESC LIMIT 7", [currentOrgId]);
      const labels = []; const data = [];
      if(apptsRes && apptsRes[0]){
        for(const r of apptsRes[0].values){ labels.push(r[0]); data.push(r[1]); }
      }
      const ctxA = document.getElementById('chartAppointments').getContext('2d');
      if(charts.appts) charts.appts.destroy();
      charts.appts = new Chart(ctxA, { type:'bar', data:{ labels:labels.reverse(), datasets:[{label:'Atendimentos', data:data.reverse(), backgroundColor:'#0d6efd'}] } });

      // Chart: new patients evolution
      const patsRes = db.exec("SELECT date(created_at) as dia, count(*) as cnt FROM patients WHERE organization_id = ? GROUP BY date(created_at) ORDER BY dia DESC LIMIT 7", [currentOrgId]);
      const labels2=[]; const data2=[];
      if(patsRes && patsRes[0]) for(const r of patsRes[0].values){ labels2.push(r[0]); data2.push(r[1]); }
      const ctxP = document.getElementById('chartPatients').getContext('2d');
      if(charts.pats) charts.pats.destroy();
      charts.pats = new Chart(ctxP, { type:'line', data:{ labels:labels2.reverse(), datasets:[{label:'Novos pacientes', data:data2.reverse(), borderColor:'#198754', fill:false}] } });

      // stats
      const stats = document.getElementById('dashboardStats'); stats.innerHTML='';
      const totalAppts = db.exec("SELECT count(*) FROM appointments WHERE organization_id = ?", [currentOrgId])[0].values[0][0];
      const missed = db.exec("SELECT count(*) FROM appointments WHERE organization_id = ? AND status = 'miss'", [currentOrgId])[0].values[0][0];
      const totalPatients = db.exec("SELECT count(*) FROM patients WHERE organization_id = ?", [currentOrgId])[0].values[0][0];
      const avgTicket = (Math.random()*200).toFixed(2); // mock ticket médio
      const html = `<div class="col-md-3"><div class="card p-2">Atendimentos: <strong>${totalAppts}</strong></div></div>
      <div class="col-md-3"><div class="card p-2">Faltas: <strong>${missed}</strong></div></div>
      <div class="col-md-3"><div class="card p-2">Pacientes: <strong>${totalPatients}</strong></div></div>
      <div class="col-md-3"><div class="card p-2">Ticket médio (mock): <strong>R$ ${avgTicket}</strong></div></div>`;
      stats.innerHTML = html;
    }

    // AUDIT UI
    function initAuditUI(){
      document.getElementById('auditSection').classList.remove('hidden');
      document.getElementById('exportAuditBtn').onclick = ()=>{ exportAudit(); };
      refreshAudit();
    }
    function refreshAudit(){
      const res = db.exec("SELECT id,user_id,action,table_name,row_id,timestamp,ip,userAgent FROM audit_logs WHERE 1=1 ORDER BY id DESC LIMIT 100");
      const area = document.getElementById('auditList'); area.innerHTML='';
      if(res && res[0]){
        for(const r of res[0].values){
          const div = document.createElement('div'); div.className='card p-2 mb-1 AuditRow';
          div.innerHTML = `<div><strong>${r[2]}</strong> table=${r[3]} row=${r[4]} byUser=${r[1]} at=${r[5]} ip=${r[6]}</div><div class="small-muted">${r[7]}</div>`;
          area.appendChild(div);
        }
      }
    }
    function exportAudit(){
      const res = db.exec("SELECT user_id,action,table_name,row_id,timestamp,ip,userAgent FROM audit_logs");
      const rows = [];
      if(res && res[0]){
        for(const r of res[0].values) rows.push({user_id:r[0],action:r[1],table_name:r[2],row_id:r[3],timestamp:r[4],ip:'REDACTED',userAgent:r[6].slice(0,80)});
      }
      const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='audit_export.json'; document.body.appendChild(a); a.click(); a.remove();
      flash('Audit export (anonimizado) gerado','success');
    }

    // NAV
    function bindNavLinks(){
      document.querySelectorAll('.nav-link').forEach(a=>{
        a.onclick = (e)=>{
          e.preventDefault();
          const t = a.dataset.target;
          document.querySelectorAll('section.card').forEach(s=>s.classList.add('hidden'));
          switch(t){
            case 'onboarding': document.getElementById('onboardingSection').classList.remove('hidden'); break;
            case 'patients': document.getElementById('patientsSection').classList.remove('hidden'); break;
            case 'evolutions': document.getElementById('evolutionsSection').classList.remove('hidden'); break;
            case 'agenda': document.getElementById('agendaSection').classList.remove('hidden'); break;
            case 'files': document.getElementById('filesSection').classList.remove('hidden'); break;
            case 'billing': document.getElementById('billingSection').classList.remove('hidden'); break;
            case 'dashboard': document.getElementById('dashboardSection').classList.remove('hidden'); break;
            case 'audit': document.getElementById('auditSection').classList.remove('hidden'); break;
            case 'glossary': document.getElementById('glossarySection').classList.remove('hidden'); break;
            case 'readme': document.getElementById('readmeSection').classList.remove('hidden'); break;
          }
        };
      });
    }

    // Helpers: modals
    function createModal(title, html){
      const id = 'm' + Math.random().toString(36).slice(2,9);
      const modalHtml = `<div class="modal fade" id="${id}" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">${title}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">${html}</div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div></div></div></div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const el = document.getElementById(id);
      const bs = new bootstrap.Modal(el);
      el.addEventListener('hidden.bs.modal', ()=>el.remove());
      return bs;
    }

    // Export evolutions to PDF via jsPDF
    async function exportEvolutionsPDF(){
      const res = db.exec("SELECT e.id, p.nome, e.content, e.created_at FROM evolutions e LEFT JOIN patients p ON e.patient_id = p.id WHERE e.organization_id = ? ORDER BY e.created_at DESC", [currentOrgId]);
      if(!res || !res[0] || !res[0].values.length){ flash('Sem evoluções','warning'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      for(const r of res[0].values){
        const id=r[0], nome=r[1], content = r[2], created=r[3];
        doc.setFontSize(12); doc.text(`Evolução #${id} - ${nome} - ${created}`, 10, y); y += 6;
        const text = stripHtml(content).slice(0,1000);
        doc.setFontSize(10); doc.text(text, 10, y); y += 20;
        if(y>270){ doc.addPage(); y=10; }
      }
      doc.save('evolutions.pdf');
      auditLog(currentUser?.id || null, 'export_pdf', 'evolutions', null);
      flash('PDF de evoluções gerado', 'success');
    }
    function stripHtml(html){ return html.replace(/<[^>]*>?/gm, ''); }

    // Misc UI bindings
    function refreshAll(){
      uiInit();
      refreshPatientsList(); refreshEvolutionsList(); renderAgenda(); refreshFilesList(); refreshBillingInfo(); refreshDashboard(); refreshAudit();
    }

    // Bind actions
    document.getElementById('loginLocalBtn').onclick = ()=> loginLocal(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
    document.getElementById('signupBtn').onclick = ()=> {
      const name = prompt('Nome:'); const email = prompt('Email:'); const pass = prompt('Senha:');
      if(name && email && pass) signupLocal(name,email,pass);
    };
    document.getElementById('googleMockBtn').onclick = googleMockSignIn;
    document.getElementById('logoutBtn').onclick = logout;
    document.getElementById('importBtn').onclick = ()=> document.getElementById('sqliteFileInput').click();
    document.getElementById('sqliteFileInput').onchange = (e)=> {
      const f = e.target.files[0]; if(!f) return; loadDBFromFile(f);
    };
    document.getElementById('exportBtn').onclick = exportDB;
    document.getElementById('backupJsonBtn')?.addEventListener('click', backupToJSON);
    document.getElementById('resetBtn').onclick = resetDB;
    document.getElementById('reloadSeedsBtn').onclick = ()=>{ initDB({seed:true}); refreshAll(); flash('Seeds recarregadas','success'); };
    document.getElementById('startTourBtn').onclick = startTour;
    document.getElementById('trySeedBtn').onclick = ()=>{ initDB({seed:true}); uiInit(); flash('Seeds carregadas', 'success'); };
    document.getElementById('tryImportBtn').onclick = ()=> document.getElementById('sqliteFileInput').click();
    document.getElementById('userBtn').onclick = ()=>{ document.querySelector('a[data-target="onboarding"]').click(); };

    // Theme toggle
    document.getElementById('themeToggle').onclick = ()=> {
      const el = document.body; el.dataset.theme = el.dataset.theme === 'dark' ? 'light' : 'dark';
    };

    // Onboarding tour (simple)
    function startTour(){
      const steps = [
        {title:'Bem-vindo', text:'Este tour mostra as principais áreas: Pacientes, Evoluções, Agenda, Arquivos, Dashboard e Auditoria.'},
        {title:'Pacientes', text:'Aqui você cria/edita pacientes e importa/exporta CSV/JSON.'},
        {title:'Evoluções', text:'Editor Quill para evoluções, versões e diffs.'},
        {title:'Agenda', text:'Arraste agendamentos entre horários.'},
        {title:'Salvar banco', text:'Faça export .sqlite regularmente — sem servidor/IndexedDB.'},
      ];
      let i=0;
      function next(){
        if(i>=steps.length) return;
        const s = steps[i++];
        const m = createModal(s.title, `<p>${s.text}</p><div class="d-flex justify-content-end"><button id="tourNext" class="btn btn-primary btn-sm">Próximo</button></div>`);
        m.show();
        document.getElementById('tourNext').onclick = ()=>{ m.hide(); next(); };
      }
      next();
    }

    // small helpers
    function createElementFromHTML(htmlString) {
      const div = document.createElement('div');
      div.innerHTML = htmlString.trim();
      return div.firstChild;
    }

    // Export/import DB via FS Access API if available
    async function tryAutoOpenLast() {
      // Not storing handles (no IndexedDB), so cannot auto-open previous files.
      // We'll simply show a notice suggesting import/export.
    }

    // Readme on load
    window.addEventListener('load', ()=>{
      initEngine();
      tryAutoOpenLast();
      // show onboarding first
      document.querySelector('a[data-target="onboarding"]').click();
    });

    // Additional UI wiring
    document.getElementById('resetPassLink').onclick = (e)=>{ e.preventDefault(); const email = prompt('Email para reset (mock):'); if(email) alert('Mock: enviar email com link de reset para '+email + '\\nEm produção, integrar SMTP/Serviço.'); };

    // Allow import JSON restore via drag/drop
    window.addEventListener('dragover', e=>e.preventDefault());
    window.addEventListener('drop', e=>{
      e.preventDefault();
      for(const f of e.dataTransfer.files){
        if(f.name.endsWith('.sqlite') || f.name.endsWith('.db')) loadDBFromFile(f);
        else if(f.name.endsWith('.json')) restoreFromJSONFile(f);
      }
    });

  </script>
</body>
</html>S OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

Notas sobre uso comercial:
Este código é um ponto de partida para um Prontuário Eletrônico Premium.
Ele simula funcionalidades de backend para demonstração. Para uso comercial em produção,
é crucial implementar um backend robusto para autenticação real, segurança de dados,
escalabilidade e integração com serviços externos (pagamentos, 2FA, e-mail/SMS, assinatura digital legal).
A criptografia local provida é básica e não deve ser considerada como segurança de nível de produção sem validação de especialistas.
-->

<!-- Git Commit Message para o deploy inicial: -->
<!--
git commit -m "Add single-file Prontuario Eletronico Premium — initial"
-->

<!-- README.md para o repositório GitHub Pages: -->
<!--
# Prontuário Eletrônico Premium (Single File for GitHub Pages)

Este é um projeto de Prontuário Eletrônico Premium implementado em um único arquivo HTML (`index.html`), projetado para ser facilmente implantado no GitHub Pages. Ele simula muitas funcionalidades complexas de um sistema SaaS real usando armazenamento local (IndexedDB) e oferece placeholders claros para integração futura com serviços de backend.

## Funcionalidades Principais:

-   **Multi-tenant Local:** Gerencie múltiplas organizações diretamente no navegador.
-   **Autenticação Local:** Login com e-mail/senha armazenados localmente, com mocks para login social (Google) e 2FA.
-   **RBAC (Role-Based Access Control):** Gerenciamento de usuários e permissões por função.
-   **CRUD de Pacientes:** Ficha completa, histórico, evoluções, arquivos, consentimento LGPD.
-   **Evoluções/Atendimentos:** Editor rich text, templates, histórico de versões, assinatura digital mock.
-   **Agenda Inteligente:** Visualizações de dia/semana/mês, drag-and-drop, filtros.
-   **Arquivos:** Upload, pré-visualização, organização por paciente.
-   **Documentos:** Gerador de prescrições/atestados com exportação para PDF.
-   **Dashboard:** Métricas e gráficos interativos (Chart.js).
-   **Billing Mock:** Simulação de planos e assinaturas.
-   **Segurança & LGPD:** Consentimento, logs de auditoria, criptografia local básica.
-   **Export/Import/Backup:** Ferramentas para gerenciamento de dados locais.
-   **UI/UX:** Layout responsivo (Bootstrap), tema claro/escuro, tooltips, tutorial.

## Como fazer o Deploy no GitHub Pages:

1.  **Crie um novo repositório GitHub:** Vá para [github.com/new](https://github.com/new).
2.  **Clone o repositório** para sua máquina local.
3.  **Copie este arquivo `index.html`** para a raiz do seu repositório.
4.  **Faça commit e push:**
    ```bash
    git add index.html
    git commit -m "Add single-file Prontuario Eletronico Premium — initial"
    git push origin main
    ```
5.  **Ative o GitHub Pages:**
    *   No seu repositório GitHub, vá em `Settings` (Configurações).
    *   No menu lateral esquerdo, clique em `Pages`.
    *   Em `Build and deployment`, certifique-se de que `Source` esteja configurado para `Deploy from a branch`.
    *   Em `Branch`, selecione `main` (ou a branch que você usou) e escolha a pasta `/(root)`.
    *   Clique em `Save`.
6.  **Acesse seu aplicativo:** O GitHub Pages levará alguns minutos para construir. Seu aplicativo estará disponível em `https://[seu-usuario].github.io/[nome-do-repositorio]`.

## Observações Importantes (Limitações e Futuras Integrações):

Este aplicativo é um MVP funcional para demonstração. **Não deve ser usado em produção sem um backend real.**

-   **Autenticação:** O login social (Google), 2FA e reset de senha são mocks. Para produção, integre com Google OAuth, Twilio/Auth0 para 2FA real e um serviço de e-mail (SendGrid/Mailgun) para reset de senha seguro.
-   **Armazenamento de Dados:** Usa IndexedDB, que é local ao navegador. **Não há sincronização ou backup automático na nuvem.** Recomenda-se exportar dados JSON periodicamente. Para produção, migre para um banco de dados de backend (PostgreSQL, MongoDB).
-   **Assinatura Digital:** A assinatura visual é apenas um mock. Para validade jurídica, integre com serviços como DocuSign, HelloSign ou ICP-Brasil.
-   **Cobrança Recorrente:** A seção de billing é um placeholder. Integre com Stripe, PayPal ou outro gateway de pagamento para transações reais.
-   **Comunicações (E-mail/WhatsApp):** As notificações e envios são mocks. Use APIs como Twilio, Zenvia ou serviços de e-mail para envio real de mensagens.
-   **Segurança:** A criptografia local é básica e para fins de demonstração. Um backend provê segurança muito superior, especialmente para dados sensíveis de saúde.
-   **Arquivos:** Os arquivos são armazenados como Base64 ou Blob URLs localmente, o que pode consumir bastante espaço no IndexedDB. Para produção, use armazenamento em nuvem (AWS S3, Google Cloud Storage).

Este projeto é uma base excelente para evoluir para um SaaS completo. Basta conectar os endpoints do backend onde indicado nos comentários do código!
-->
<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário Eletrônico Premium</title>

    <!-- CDNs para Bibliotecas Essenciais -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.10/main.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7.1.1/build/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/localizedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/timezone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/csv-parse@5.5.3/dist/cjs/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
        }
        [data-bs-theme="dark"] {
            --primary-color: #6daffb;
            --secondary-color: #adb5bd;
            --background-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: #495057;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar, .footer {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar {
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            min-height: calc(100vh - 56px); /* Altura da navbar */
            padding-top: 1rem;
        }
        .nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-radius: .25rem;
        }
        .nav-link {
            color: var(--text-color);
        }
        .nav-link:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        .form-control, .form-select, .ql-toolbar.ql-snow, .ql-container.ql-snow {
            background-color: var(--background-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .modal-header {
            border-bottom-color: var(--border-color);
        }
        .modal-footer {
            border-top-color: var(--border-color);
        }
        .tooltip-icon {
            cursor: help;
            margin-left: 5px;
            color: var(--secondary-color);
        }
        .alert {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        .toast {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .trial-indicator {
            background-color: #ffc107;
            color: #343a40;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 15px;
        }
        .signature-area {
            border: 1px dashed var(--border-color);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            text-align: center;
        }
        .signature-img {
            max-width: 100%;
            max-height: 90px;
        }
        .quill-container {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            min-height: 200px;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .quill-container .ql-editor {
            color: var(--text-color);
        }
        .quill-container .ql-stroke {
            fill: none;
            stroke: var(--text-color);
        }
        .quill-container .ql-fill {
            fill: var(--text-color);
        }
        .fullcalendar {
            max-width: 100%;
            margin: 0 auto;
        }
        .fc .fc-button-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .fc .fc-button-primary:not(:disabled):active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .fc-theme-bootstrap5 a {
            color: var(--text-color);
        }
        .fc-theme-bootstrap5 .fc-bg-event {
            opacity: 0.1;
        }
        .fc-event {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        .drag-drop-area {
            border: 2px dashed var(--border-color);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-bottom: 1rem;
        }
        .drag-drop-area.highlight {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: var(--primary-color);
        }
        .file-preview {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
        .online-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            z-index: 1000;
        }
        .online-status.online {
            background-color: #28a745;
            color: white;
        }
        .online-status.offline {
            background-color: #dc3545;
            color: white;
        }
        .header-action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        @media (max-width: 767.98px) {
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .content-area {
                margin-left: 0 !important;
            }
            .header-action-buttons {
                justify-content: center;
                margin-top: 10px;
            }
        }
        /* Style for tour steps */
        .tour-highlight {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            transition: all 0.3s ease-in-out;
        }
        .tour-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            pointer-events: none; /* Allow interaction with underlying elements if needed for advanced tour */
        }
        .tour-tooltip {
            position: absolute;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            max-width: 300px;
            color: var(--text-color);
        }
        .tour-tooltip button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="loading-spinner" class="d-flex justify-content-center align-items-center" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <!-- Onboarding / Login / Org Selector -->
    <div id="onboarding-screen" class="d-flex flex-column justify-content-center align-items-center vh-100 p-3" style="display: none;">
        <div class="card p-5 shadow-lg text-center" style="max-width: 600px;">
            <h1 class="card-title mb-4">Bem-vindo ao Prontuário Eletrônico Premium</h1>
            <p class="card-text mb-4">Este é um sistema de prontuário eletrônico completo, funcionando diretamente no seu navegador, perfeito para demonstrações e uso offline. Ele foi projetado para ser facilmente integrado a um backend real no futuro.</p>

            <div id="org-selection-area" class="mb-4" style="display: none;">
                <h5 class="mb-3">Selecione sua Organização:</h5>
                <select id="org-select" class="form-select mb-3"></select>
                <button id="create-new-org-btn" class="btn btn-outline-primary me-2"><i class="fas fa-plus-circle me-1"></i> Criar Nova Organização</button>
                <button id="select-org-proceed-btn" class="btn btn-primary" disabled><i class="fas fa-arrow-right me-1"></i> Entrar</button>
            </div>

            <div id="login-register-area" class="mb-4" style="display: none;">
                <h5 class="mb-3">Entrar ou Registrar</h5>
                <input type="email" id="login-email" class="form-control mb-2" placeholder="Seu e-mail">
                <input type="password" id="login-password" class="form-control mb-3" placeholder="Sua senha">
                <div class="d-grid gap-2 mb-3">
                    <button id="login-btn" class="btn btn-primary"><i class="fas fa-sign-in-alt me-1"></i> Entrar</button>
                    <button id="register-btn" class="btn btn-outline-secondary"><i class="fas fa-user-plus me-1"></i> Registrar Novo Usuário</button>
                    <button id="reset-password-mock-btn" class="btn btn-link text-decoration-none">Esqueceu a senha?</button>
                </div>

                <div class="separator my-3">Ou</div>
                <button id="google-login-mock-btn" class="btn btn-outline-danger w-100 mb-2"><i class="fab fa-google me-1"></i> Entrar com Google (Mock)</button>
                <button id="login-back-to-org-select-btn" class="btn btn-sm btn-link mt-2"><i class="fas fa-arrow-left me-1"></i> Voltar para seleção de organização</button>
            </div>

            <button id="seed-data-btn" class="btn btn-success me-2 mt-3"><i class="fas fa-seedling me-1"></i> Carregar Dados de Exemplo</button>
            <button id="skip-onboarding-btn" class="btn btn-secondary mt-3"><i class="fas fa-arrow-right me-1"></i> Pular Onboarding (Limpo)</button>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="main-app" style="display: none;" class="d-flex flex-column flex-grow-1">
        <nav class="navbar navbar-expand-lg sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-notes-medical me-2"></i>Prontuário Premium
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <!-- Itens do menu principal podem ser adicionados aqui se necessário -->
                    </ul>
                    <div class="d-flex align-items-center">
                        <span id="trial-indicator" class="trial-indicator me-3" style="display:none;"><i class="fas fa-star me-1"></i> Trial de 7 dias!</span>
                        <span class="me-3">Org: <strong id="current-org-name"></strong></span>
                        <span class="me-3">Usuário: <strong id="current-user-name"></strong> (<span id="current-user-role"></span>)</span>
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input" type="checkbox" id="darkModeToggle">
                            <label class="form-check-label" for="darkModeToggle"><i class="fas fa-moon"></i></label>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="#" id="profile-link"><i class="fas fa-user-cog me-2"></i>Meu Perfil</a></li>
                                <li><a class="dropdown-item" href="#" id="manage-orgs-link"><i class="fas fa-building me-2"></i>Gerenciar Organizações</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" id="logout-btn"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="d-flex flex-grow-1">
            <!-- Sidebar -->
            <div class="sidebar d-flex flex-column flex-shrink-0 p-3 bg-light" style="width: 280px;">
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" data-target="dashboard">
                            <i class="fas fa-chart-line me-2"></i>Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#patients" class="nav-link" data-target="patients">
                            <i class="fas fa-user-injured me-2"></i>Pacientes
                        </a>
                    </li>
                    <li>
                        <a href="#appointments" class="nav-link" data-target="appointments">
                            <i class="fas fa-calendar-alt me-2"></i>Agenda
                        </a>
                    </li>
                    <li>
                        <a href="#evolutions" class="nav-link" data-target="evolutions" style="display:none;">
                            <i class="fas fa-notes-medical me-2"></i>Evoluções
                        </a>
                    </li>
                    <li>
                        <a href="#documents" class="nav-link" data-target="documents">
                            <i class="fas fa-file-alt me-2"></i>Documentos & Prescrições
                        </a>
                    </li>
                    <li>
                        <a href="#files" class="nav-link" data-target="files">
                            <i class="fas fa-folder me-2"></i>Arquivos
                        </a>
                    </li>
                    <li>
                        <a href="#team" class="nav-link" data-target="team">
                            <i class="fas fa-users-cog me-2"></i>Equipe & Permissões
                        </a>
                    </li>
                    <li>
                        <a href="#billing" class="nav-link" data-target="billing">
                            <i class="fas fa-dollar-sign me-2"></i>Assinatura & Planos
                        </a>
                    </li>
                    <li>
                        <a href="#audit-logs" class="nav-link" data-target="audit-logs">
                            <i class="fas fa-clipboard-list me-2"></i>Logs de Auditoria
                        </a>
                    </li>
                    <li><hr></li>
                    <li>
                        <a href="#settings" class="nav-link" data-target="settings">
                            <i class="fas fa-cogs me-2"></i>Configurações
                        </a>
                    </li>
                    <li>
                        <a href="#help" class="nav-link" data-target="help">
                            <i class="fas fa-question-circle me-2"></i>Ajuda & Documentação
                        </a>
                    </li>
                    <li>
                        <a href="#glossary" class="nav-link" data-target="glossary">
                            <i class="fas fa-book me-2"></i>Glossário
                        </a>
                    </li>
                    <li><hr></li>
                    <li>
                        <button class="btn btn-outline-danger w-100" id="clear-all-data-btn"><i class="fas fa-trash me-2"></i>Limpar TODOS os Dados</button>
                    </li>
                </ul>
            </div>

            <!-- Main Content Area -->
            <main class="content-area flex-grow-1 p-4 overflow-auto">
                <div id="content-dashboard" class="content-section">
                    <h2 class="mb-4">Dashboard da Organização <i class="fas fa-chart-line"></i></h2>
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> Este dashboard fornece uma visão geral das métricas da sua clínica. Dados financeiros são simulados.
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">Atendimentos no Mês</h5>
                                    <i class="fas fa-calendar-check fa-2x text-primary"></i>
                                </div>
                                <h3 id="dashboard-total-appointments">0</h3>
                                <p class="card-text text-muted">Total de agendamentos finalizados este mês.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">Taxa de Faltas</h5>
                                    <i class="fas fa-user-slash fa-2x text-warning"></i>
                                </div>
                                <h3 id="dashboard-missed-rate">0%</h3>
                                <p class="card-text text-muted">Percentual de pacientes que faltaram aos agendamentos.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">Novos Pacientes (30 dias)</h5>
                                    <i class="fas fa-user-plus fa-2x text-success"></i>
                                </div>
                                <h3 id="dashboard-new-patients">0</h3>
                                <p class="card-text text-muted">Pacientes registrados nos últimos 30 dias.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5 class="card-title mb-3">Atendimentos por Mês</h5>
                                <canvas id="appointmentsChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5 class="card-title mb-3">Receita Mensal (Mock)</h5>
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card p-3">
                                <h5 class="card-title mb-3">Ocupação por Profissional (Mock)</h5>
                                <canvas id="professionalOccupationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-patients" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="mb-0">Pacientes <i class="fas fa-user-injured"></i></h2>
                        <div class="header-action-buttons">
                            <button class="btn btn-primary" id="new-patient-btn"><i class="fas fa-plus-circle me-2"></i>Adicionar Paciente</button>
                            <button class="btn btn-outline-secondary" id="import-patients-btn"><i class="fas fa-upload me-2"></i>Importar CSV</button>
                            <button class="btn btn-outline-secondary" id="export-patients-btn"><i class="fas fa-download me-2"></i>Exportar CSV</button>
                        </div>
                    </div>
                    <input type="text" id="patient-search" class="form-control mb-4" placeholder="Buscar paciente por nome ou CPF...">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF</th>
                                    <th>Data Nasc.</th>
                                    <th>Telefone</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="patients-list">
                                <tr><td colspan="6" class="text-center">Nenhum paciente encontrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="content-appointments" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="mb-0">Agenda <i class="fas fa-calendar-alt"></i></h2>
                        <div class="header-action-buttons">
                            <button class="btn btn-primary" id="new-appointment-btn"><i class="fas fa-plus-circle me-2"></i>Novo Agendamento</button>
                            <select id="appointment-professional-filter" class="form-select w-auto me-2">
                                <option value="">Todos os Profissionais</option>
                                <!-- Profissionais serão carregados aqui -->
                            </select>
                        </div>
                    </div>
                    <div id='calendar' class="fullcalendar"></div>
                    <div class="card mt-4 p-3">
                        <h5>Log de Notificações (Mock)</h5>
                        <div id="notification-log" class="small text-muted" style="max-height: 150px; overflow-y: auto;">
                            Nenhuma notificação enviada ainda.
                        </div>
                        <small class="mt-2 text-info"><i class="fas fa-info-circle"></i> As notificações são simuladas. Para envio real, integre com APIs de SMS/WhatsApp/E-mail (Twilio, Zenvia, SendGrid).</small>
                    </div>
                </div>

                <div id="content-evolutions" class="content-section" style="display: none;">
                    <h2 class="mb-4">Evoluções <i class="fas fa-notes-medical"></i></h2>
                    <p>Esta seção é acessada através da ficha do paciente. Selecione um paciente para ver suas evoluções.</p>
                </div>

                <div id="content-documents" class="content-section" style="display: none;">
                    <h2 class="mb-4">Documentos & Prescrições <i class="fas fa-file-alt"></i></h2>
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> Selecione um paciente para gerar documentos específicos. Aqui você pode criar modelos gerais.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3 mb-4">
                                <h5 class="card-title">Gerar Documento Avulso</h5>
                                <div class="mb-3">
                                    <label for="doc-patient-select" class="form-label">Paciente</label>
                                    <select id="doc-patient-select" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="doc-type-select" class="form-label">Tipo de Documento</label>
                                    <select id="doc-type-select" class="form-select">
                                        <option value="prescription">Prescrição</option>
                                        <option value="exam_request">Solicitação de Exame</option>
                                        <option value="medical_certificate">Atestado Médico</option>
                                        <option value="medical_report">Laudo Médico</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="doc-template-select" class="form-label">Template</label>
                                    <select id="doc-template-select" class="form-select">
                                        <option value="">(Nenhum template)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="doc-content" class="form-label">Conteúdo do Documento</label>
                                    <div id="doc-content-editor" class="quill-container"></div>
                                </div>
                                <button class="btn btn-primary" id="generate-document-pdf-btn"><i class="fas fa-file-pdf me-2"></i>Gerar PDF</button>
                                <button class="btn btn-outline-success mt-2" id="mock-send-doc-btn"><i class="fas fa-paper-plane me-2"></i>Enviar (Mock)</button>
                                <small class="mt-2 text-info"><i class="fas fa-info-circle"></i> O envio é simulado. Para envio real, integre com APIs de WhatsApp/E-mail.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 mb-4">
                                <h5 class="card-title">Gerenciar Templates de Documentos</h5>
                                <button class="btn btn-outline-primary mb-3" id="new-template-btn"><i class="fas fa-plus me-2"></i>Novo Template</button>
                                <ul id="template-list" class="list-group">
                                    <!-- Templates will be listed here -->
                                    <li class="list-group-item d-flex justify-content-between align-items-center">Nenhum template cadastrado.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-files" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="mb-0">Arquivos <i class="fas fa-folder"></i></h2>
                        <div class="header-action-buttons">
                            <label for="file-upload-input" class="btn btn-primary mb-0 me-2"><i class="fas fa-upload me-2"></i>Upload Arquivo</label>
                            <input type="file" id="file-upload-input" class="d-none" multiple>
                            <select id="files-patient-filter" class="form-select w-auto me-2">
                                <option value="">Todos os Pacientes</option>
                                <!-- Pacientes serão carregados aqui -->
                            </select>
                            <select id="files-folder-filter" class="form-select w-auto">
                                <option value="">Todas as Pastas</option>
                                <option value="Exames">Exames</option>
                                <option value="Receitas">Receitas</option>
                                <option value="Documentos">Documentos</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>

                    <div id="file-drag-drop-area" class="drag-drop-area">
                        <p><i class="fas fa-cloud-upload-alt fa-3x text-primary"></i></p>
                        <p>Arraste e solte arquivos aqui ou clique para selecionar.</p>
                        <small class="text-muted"><i class="fas fa-info-circle"></i> Os arquivos são armazenados localmente no seu navegador. Para produção, integre com um serviço de armazenamento em nuvem (ex: AWS S3).</small>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome do Arquivo</th>
                                    <th>Paciente</th>
                                    <th>Pasta</th>
                                    <th>Tipo</th>
                                    <th>Tamanho</th>
                                    <th>Data Upload</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="files-list">
                                <tr><td colspan="7" class="text-center">Nenhum arquivo enviado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="content-team" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="mb-0">Equipe & Permissões <i class="fas fa-users-cog"></i></h2>
                        <div class="header-action-buttons">
                            <button class="btn btn-primary" id="add-team-member-btn"><i class="fas fa-user-plus me-2"></i>Adicionar Membro</button>
                        </div>
                    </div>
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> Gerencie os usuários da sua organização e atribua papéis. As permissões são aplicadas localmente no navegador.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Papel</th>
                                    <th>2FA Ativo?</th>
                                    <th>Último Login</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="team-list">
                                <tr><td colspan="6" class="text-center">Nenhum membro da equipe encontrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="content-billing" class="content-section" style="display: none;">
                    <h2 class="mb-4">Assinatura & Planos <i class="fas fa-dollar-sign"></i></h2>
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i> Esta seção é um **MOCK**. Não há cobrança real. Para integrar pagamentos, você precisará de um backend e APIs como Stripe ou PayPal.
                    </div>

                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">Seu Plano Atual</h4>
                        <div id="current-subscription-info">
                            <p>Status: <span class="badge bg-success" id="sub-status">Ativo</span></p>
                            <p>Plano: <strong id="sub-plan-name">Starter</strong> (<span id="sub-plan-price">R$ 49/mês</span>)</p>
                            <p>Início: <span id="sub-start-date">--</span></p>
                            <p>Próxima Cobrança: <span id="sub-next-bill-date">--</span></p>
                            <p class="text-info" id="sub-trial-note" style="display:none;"><i class="fas fa-info-circle"></i> Você está em período de trial! Faltam <span id="sub-trial-days-left"></span> dias.</p>
                        </div>
                        <hr>
                        <button class="btn btn-outline-primary mt-3" id="change-plan-btn"><i class="fas fa-sync-alt me-2"></i>Alterar Plano</button>
                        <button class="btn btn-outline-danger mt-2" id="cancel-subscription-btn"><i class="fas fa-times-circle me-2"></i>Cancelar Assinatura (Mock)</button>
                    </div>

                    <div id="plan-selection-area" class="card p-4 mb-4" style="display:none;">
                        <h4 class="mb-3">Escolha seu Plano</h4>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 p-3 text-center border-primary">
                                    <h5 class="card-title">Plano Starter</h5>
                                    <h2 class="mb-3">R$ 49 <small>/mês</small></h2>
                                    <ul class="list-unstyled text-start mb-4">
                                        <li><i class="fas fa-check text-success me-2"></i>1 Usuário</li>
                                        <li><i class="fas fa-check text-success me-2"></i>20 Pacientes</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Armazenamento Básico</li>
                                        <li><i class="fas fa-times text-danger me-2"></i>Sem Templates Avançados</li>
                                    </ul>
                                    <button class="btn btn-primary select-plan-btn" data-plan="starter"><i class="fas fa-check-circle me-2"></i>Selecionar</button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 p-3 text-center">
                                    <h5 class="card-title">Plano Pro</h5>
                                    <h2 class="mb-3">R$ 99 <small>/mês</small></h2>
                                    <ul class="list-unstyled text-start mb-4">
                                        <li><i class="fas fa-check text-success me-2"></i>5 Usuários</li>
                                        <li><i class="fas fa-check text-success me-2"></i>500 Pacientes</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Armazenamento Ilimitado</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Templates Avançados</li>
                                    </ul>
                                    <button class="btn btn-outline-primary select-plan-btn" data-plan="pro"><i class="fas fa-check-circle me-2"></i>Selecionar</button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 p-3 text-center">
                                    <h5 class="card-title">Plano Clinic</h5>
                                    <h2 class="mb-3">R$ 199 <small>/mês</small></h2>
                                    <ul class="list-unstyled text-start mb-4">
                                        <li><i class="fas fa-check text-success me-2"></i>Usuários Ilimitados</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Pacientes Ilimitados</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Armazenamento Ilimitado</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Todos os Recursos</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Suporte Prioritário</li>
                                    </ul>
                                    <button class="btn btn-outline-primary select-plan-btn" data-plan="clinic"><i class="fas fa-check-circle me-2"></i>Selecionar</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary mt-3" id="cancel-plan-change-btn">Cancelar</button>
                    </div>

                    <button class="btn btn-success mt-3" id="start-trial-btn" style="display:none;"><i class="fas fa-star me-2"></i>Iniciar Trial de 7 Dias</button>
                    <small class="mt-2 text-info"><i class="fas fa-info-circle"></i> Para processar pagamentos reais, você precisará integrar com provedores como Stripe ou PayPal.</small>
                </div>

                <div id="content-audit-logs" class="content-section" style="display: none;">
                    <h2 class="mb-4">Logs de Auditoria <i class="fas fa-clipboard-list"></i></h2>
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> Este log registra ações importantes realizadas no sistema para fins de segurança e conformidade.
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" id="audit-filter-user" class="form-control" placeholder="Filtrar por usuário...">
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="audit-filter-action" class="form-control" placeholder="Filtrar por ação...">
                        </div>
                        <div class="col-md-4">
                            <input type="date" id="audit-filter-date" class="form-control">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Detalhes</th>
                                    <th>IP (Simulado)</th>
                                    <th>User Agent</th>
                                </tr>
                            </thead>
                            <tbody id="audit-logs-list">
                                <tr><td colspan="6" class="text-center">Nenhum log de auditoria encontrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="content-settings" class="content-section" style="display: none;">
                    <h2 class="mb-4">Configurações <i class="fas fa-cogs"></i></h2>
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">Configurações da Organização</h4>
                        <div class="mb-3">
                            <label for="org-name-setting" class="form-label">Nome da Organização</label>
                            <input type="text" id="org-name-setting" class="form-control" placeholder="Nome da sua clínica/organização">
                        </div>
                        <div class="mb-3">
                            <label for="org-address-setting" class="form-label">Endereço</label>
                            <input type="text" id="org-address-setting" class="form-control" placeholder="Endereço completo">
                        </div>
                        <div class="mb-3">
                            <label for="org-phone-setting" class="form-label">Telefone</label>
                            <input type="text" id="org-phone-setting" class="form-control" placeholder="(XX) XXXXX-XXXX">
                        </div>
                        <div class="mb-3">
                            <label for="org-email-setting" class="form-label">Email de Contato</label>
                            <input type="email" id="org-email-setting" class="form-control" placeholder="contato@suaclinica.com">
                        </div>
                        <button class="btn btn-primary" id="save-org-settings-btn"><i class="fas fa-save me-2"></i>Salvar Configurações da Organização</button>
                    </div>

                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">Exportar / Importar Dados</h4>
                        <p class="text-muted"><i class="fas fa-info-circle"></i> Recomendamos exportar seus dados regularmente para backup.</p>
                        <button class="btn btn-outline-primary mb-2" id="export-db-json-btn"><i class="fas fa-download me-2"></i>Exportar DB Completo (JSON)</button>
                        <p class="small text-muted">Aviso: A importação irá sobrescrever os dados da organização atual.</p>
                        <input type="file" id="import-db-json-input" class="form-control mb-2" accept=".json">
                        <button class="btn btn-warning" id="import-db-json-btn" disabled><i class="fas fa-upload me-2"></i>Importar DB (JSON)</button>
                    </div>
                </div>

                <div id="content-help" class="content-section" style="display: none;">
                    <h2 class="mb-4">Ajuda & Documentação <i class="fas fa-question-circle"></i></h2>
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">Tutorial de Primeiros Passos</h4>
                        <p>Clique no botão abaixo para iniciar um tour guiado pelas principais funcionalidades do sistema.</p>
                        <button class="btn btn-info" id="start-tour-btn"><i class="fas fa-play-circle me-2"></i>Iniciar Tour</button>
                        <hr>
                        <h4 class="mb-3">README / Deploy no GitHub Pages</h4>
                        <p>Esta seção contém as instruções para deploy e notas importantes sobre as limitações e futuras integrações do sistema.</p>
                        <pre class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; color: var(--text-color); border: 1px solid var(--border-color);">
<code id="embedded-readme">
<!-- O conteúdo do README embutido será injetado aqui via JS -->
</code>
                        </pre>
                        <p class="small text-muted mt-3"><i class="fas fa-lightbulb"></i> Para transformar este app em um produto real com backend, você precisará implementar:
                            <ul>
                                <li>**Autenticação:** Google OAuth, JWTs, 2FA real (via SMS/TOTP).</li>
                                <li>**Banco de Dados:** PostgreSQL, MongoDB ou similar, na nuvem.</li>
                                <li>**Armazenamento de Arquivos:** AWS S3, Google Cloud Storage.</li>
                                <li>**Pagamentos:** Integração com Stripe, PayPal, PagSeguro.</li>
                                <li>**Comunicações:** APIs de E-mail (SendGrid, Mailgun) e SMS/WhatsApp (Twilio, Zenvia).</li>
                                <li>**Assinatura Digital:** Integração com DocuSign, HelloSign ou ICP-Brasil para validade jurídica.</li>
                                <li>**API RESTful:** Para comunicação entre o frontend e o backend.</li>
                            </ul>
                        </p>
                    </div>
                </div>

                <div id="content-glossary" class="content-section" style="display: none;">
                    <h2 class="mb-4">Glossário <i class="fas fa-book"></i></h2>
                    <div class="card p-4">
                        <h4 class="mb-3">Termos Comuns</h4>
                        <dl class="row">
                            <dt class="col-sm-3">CMV</dt>
                            <dd class="col-sm-9">Custo da Mercadoria Vendida. Em clínicas, pode ser adaptado para Custo do Serviço Prestado.</dd>

                            <dt class="col-sm-3">Ticket Médio</dt>
                            <dd class="col-sm-9">Valor médio gasto por paciente em um determinado período. Calculado como Receita Total / Número de Atendimentos.</dd>

                            <dt class="col-sm-3">Margem</dt>
                            <dd class="col-sm-9">Lucro obtido sobre o custo de um serviço ou produto, geralmente expresso em porcentagem. (Receita - Custo) / Receita.</dd>

                            <dt class="col-sm-3">Consentimento LGPD</dt>
                            <dd class="col-sm-9">Autorização expressa e inequívoca do paciente para o tratamento de seus dados pessoais, conforme a Lei Geral de Proteção de Dados.</dd>

                            <dt class="col-sm-3">Evolução</dt>
                            <dd class="col-sm-9">Registro detalhado de cada atendimento ou acompanhamento do paciente, incluindo anamnese, conduta, exames e plano terapêutico.</dd>

                            <dt class="col-sm-3">Anamnese</dt>
                            <dd class="col-sm-9">Coleta de dados sobre a história clínica do paciente, seus sintomas, estilo de vida e histórico familiar, essencial para o diagnóstico.</dd>

                            <dt class="col-sm-3">Metas SMART</dt>
                            <dd class="col-sm-9">Critérios para definir metas eficazes: Específicas (Specific), Mensuráveis (Measurable), Atingíveis (Achievable), Relevantes (Relevant) e com Prazo definido (Time-bound).</dd>

                            <dt class="col-sm-3">RBAC</dt>
                            <dd class="col-sm-9">Role-Based Access Control (Controle de Acesso Baseado em Papéis). Um método de restringir o acesso ao sistema com base nos papéis individuais dos usuários dentro de uma organização.</dd>
                        </dl>
                    </div>
                </div>
            </main>
        </div>

        <!-- Footer -->
        <footer class="footer mt-auto py-3">
            <div class="container-fluid text-center">
                <span class="text-muted">Prontuário Eletrônico Premium &copy; 2023. Desenvolvido para demonstração.</span>
            </div>
        </footer>
    </div>

    <!-- Modals -->

    <!-- Modal Novo/Editar Paciente -->
    <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalLabel">Paciente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="patientTabs" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="dados-pessoais-tab" data-bs-toggle="tab" data-bs-target="#dados-pessoais" type="button" role="tab" aria-controls="dados-pessoais" aria-selected="true">Dados Pessoais</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="contatos-tab" data-bs-toggle="tab" data-bs-target="#contatos" type="button" role="tab" aria-controls="contatos" aria-selected="false">Contatos</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">Histórico Clínico</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="evols-tab" data-bs-toggle="tab" data-bs-target="#evols" type="button" role="tab" aria-controls="evols" aria-selected="false">Evoluções</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#patient-files" type="button" role="tab" aria-controls="patient-files" aria-selected="false">Arquivos</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="consentimento-tab" data-bs-toggle="tab" data-bs-target="#consentimento" type="button" role="tab" aria-controls="consentimento" aria-selected="false">Consentimento LGPD</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="patient-settings-tab" data-bs-toggle="tab" data-bs-target="#patient-settings" type="button" role="tab" aria-controls="patient-settings" aria-selected="false">Configurações</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="dados-pessoais" role="tabpanel" aria-labelledby="dados-pessoais-tab">
                            <form id="patient-form">
                                <input type="hidden" id="patient-id">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="patient-name" class="form-label">Nome Completo <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nome completo do paciente. Essencial para identificação e em relatórios."></i></label>
                                        <input type="text" id="patient-name" class="form-control" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="patient-cpf" class="form-label">CPF <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Cadastro de Pessoa Física. Importante para identificação única e emissão de documentos."></i></label>
                                        <input type="text" id="patient-cpf" class="form-control" pattern="\d{3}\.?\d{3}\.?\d{3}-?\d{2}" placeholder="XXX.XXX.XXX-XX">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="patient-dob" class="form-label">Data de Nascimento <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Data de nascimento do paciente. Usada para calcular idade e para fins demográficos."></i></label>
                                        <input type="date" id="patient-dob" class="form-control">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="patient-sex" class="form-label">Sexo</label>
                                        <select id="patient-sex" class="form-select">
                                            <option value="">Selecione</option>
                                            <option value="Masculino">Masculino</option>
                                            <option value="Feminino">Feminino</option>
                                            <option value="Outro">Outro</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="patient-status" class="form-label">Status <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Status do paciente no sistema: Ativo, Inativo ou Arquivado. Afeta a visibilidade em listagens."></i></label>
                                        <select id="patient-status" class="form-select">
                                            <option value="Ativo">Ativo</option>
                                            <option value="Inativo">Inativo</option>
                                            <option value="Arquivado">Arquivado</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label for="patient-tags" class="form-label">Tags <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Palavras-chave para categorizar o paciente, como 'diabético', 'hipertenso', 'pós-cirúrgico'."></i></label>
                                        <input type="text" id="patient-tags" class="form-control" placeholder="Ex: diabético, hipertenso (separar por vírgula)">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="patient-private-notes" class="form-label">Observações Privadas <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Notas confidenciais sobre o paciente, visíveis apenas para profissionais com permissão adequada."></i></label>
                                    <textarea id="patient-private-notes" class="form-control" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="contatos" role="tabpanel" aria-labelledby="contatos-tab">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="patient-phone" class="form-label">Telefone Principal</label>
                                    <input type="tel" id="patient-phone" class="form-control" placeholder="(XX) XXXXX-XXXX">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="patient-email" class="form-label">Email</label>
                                    <input type="email" id="patient-email" class="form-control" placeholder="email@exemplo.com">
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="patient-address" class="form-label">Endereço Completo</label>
                                    <input type="text" id="patient-address" class="form-control" placeholder="Rua, Número, Complemento, Bairro, Cidade - Estado, CEP">
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="patient-emergency-contact" class="form-label">Contato de Emergência</label>
                                    <input type="text" id="patient-emergency-contact" class="form-control" placeholder="Nome do Contato, Telefone">
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
                            <div class="mb-3">
                                <label for="patient-clinical-history" class="form-label">Histórico Clínico</label>
                                <textarea id="patient-clinical-history" class="form-control" rows="5" placeholder="Doenças preexistentes, cirurgias anteriores, hospitalizações, histórico familiar relevante..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="patient-allergies" class="form-label">Alergias</label>
                                <textarea id="patient-allergies" class="form-control" rows="3" placeholder="Alergias a medicamentos, alimentos, ambiente..."></textarea>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="evols" role="tabpanel" aria-labelledby="evols-tab">
                            <div class="d-flex justify-content-between mb-3">
                                <h4>Evoluções do Paciente</h4>
                                <button class="btn btn-primary" id="new-evolution-btn"><i class="fas fa-plus-circle me-2"></i>Nova Evolução</button>
                            </div>
                            <ul id="patient-evolutions-list" class="list-group">
                                <!-- Evoluções serão carregadas aqui -->
                                <li class="list-group-item text-center text-muted">Nenhuma evolução registrada para este paciente.</li>
                            </ul>
                        </div>
                        <div class="tab-pane fade" id="patient-files" role="tabpanel" aria-labelledby="files-tab">
                            <div class="d-flex justify-content-between mb-3">
                                <h4>Arquivos do Paciente</h4>
                                <label for="patient-file-upload-input" class="btn btn-primary mb-0"><i class="fas fa-upload me-2"></i>Upload Arquivo</label>
                                <input type="file" id="patient-file-upload-input" class="d-none" multiple>
                            </div>
                            <div id="patient-file-drag-drop-area" class="drag-drop-area">
                                <p><i class="fas fa-cloud-upload-alt fa-2x text-primary"></i></p>
                                <p>Arraste e solte arquivos aqui.</p>
                            </div>
                            <input type="text" id="patient-file-search" class="form-control mb-3" placeholder="Buscar arquivos...">
                            <ul id="patient-files-list" class="list-group">
                                <!-- Arquivos do paciente serão carregados aqui -->
                                <li class="list-group-item text-center text-muted">Nenhum arquivo enviado para este paciente.</li>
                            </ul>
                        </div>
                        <div class="tab-pane fade" id="consentimento" role="tabpanel" aria-labelledby="consentimento-tab">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="patient-lgpd-consent">
                                    <label class="form-check-label" for="patient-lgpd-consent">
                                        O paciente consente com o tratamento de seus dados pessoais para fins de atendimento clínico, conforme a LGPD. <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Confirmação do consentimento do paciente para o uso de seus dados. Essencial para conformidade com a LGPD."></i>
                                    </label>
                                </div>
                            </div>
                            <div id="lgpd-consent-details" style="display:none;">
                                <p class="mb-1"><strong>Data do Consentimento:</strong> <span id="patient-lgpd-timestamp"></span></p>
                                <p class="mb-1"><strong>IP Simulada:</strong> <span id="patient-lgpd-ip"></span></p>
                            </div>
                            <div class="alert alert-warning mt-3" role="alert" id="lgpd-alert-no-consent" style="display:none;">
                                <i class="fas fa-exclamation-triangle"></i> **ATENÇÃO:** Este paciente não possui consentimento LGPD registrado.
                            </div>
                        </div>
                        <div class="tab-pane fade" id="patient-settings" role="tabpanel" aria-labelledby="patient-settings-tab">
                            <h5 class="mb-3">Exportar Prontuário Completo</h5>
                            <button class="btn btn-outline-primary mb-2" id="export-patient-json-btn"><i class="fas fa-download me-2"></i>Exportar Dados (JSON)</button>
                            <button class="btn btn-outline-primary mb-2" id="export-patient-pdf-btn"><i class="fas fa-file-pdf me-2"></i>Exportar Prontuário (PDF)</button>
                            <button class="btn btn-outline-primary mb-2" id="export-patient-zip-btn"><i class="fas fa-file-archive me-2"></i>Exportar Pacote de Dados (ZIP)</button>
                            <hr>
                            <h5 class="mb-3">Remoção de Dados</h5>
                            <button class="btn btn-danger" id="request-patient-anonymization-mock-btn"><i class="fas fa-user-secret me-2"></i>Solicitar Anonimização (Mock)</button>
                            <p class="small text-muted mt-2"><i class="fas fa-info-circle"></i> Esta é uma função simulada. Em um sistema real, acionaria um processo de exclusão/anonimização permanente de dados. </p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="save-patient-btn">Salvar Paciente</button>
                    <button type="button" class="btn btn-danger" id="delete-patient-btn" style="display: none;">Excluir Paciente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Evolução -->
    <div class="modal fade" id="evolutionModal" tabindex="-1" aria-labelledby="evolutionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="evolutionModalLabel">Nova Evolução para <span id="evolution-patient-name-title"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="evolution-id">
                    <input type="hidden" id="evolution-patient-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="evolution-date" class="form-label">Data e Hora</label>
                            <input type="datetime-local" id="evolution-date" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="evolution-professional" class="form-label">Profissional</label>
                            <select id="evolution-professional" class="form-select" required></select>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="evolution-type" class="form-label">Tipo de Atendimento</label>
                            <input type="text" id="evolution-type" class="form-control" placeholder="Ex: Consulta, Retorno, Teleconsulta">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="evolution-template" class="form-label">Template de Evolução</label>
                            <select id="evolution-template" class="form-select">
                                <option value="">(Nenhum template)</option>
                                <!-- Templates serão carregados aqui -->
                            </select>
                            <small class="text-muted">Selecione um template para preencher o conteúdo da evolução.</small>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="evolution-anamnese" class="form-label">Anamnese / Observações</label>
                            <div id="evolution-anamnese-editor" class="quill-container"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="evolution-vitals" class="form-label">Sinais Vitais / Exames (Estruturado)</label>
                            <textarea id="evolution-vitals" class="form-control" rows="4" placeholder="Ex: PA: 120/80 mmHg, FC: 70 bpm, Temperatura: 36.5°C"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="evolution-therapeutic-plan" class="form-label">Plano Terapêutico / Conduta</label>
                            <textarea id="evolution-therapeutic-plan" class="form-control" rows="4" placeholder="Ex: Manter medicação, solicitar exames X, agendar retorno em 30 dias."></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="evolution-smart-goals" class="form-label">Metas SMART <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Defina metas Específicas, Mensuráveis, Atingíveis, Relevantes e com Prazo definido."></i></label>
                            <textarea id="evolution-smart-goals" class="form-control" rows="3" placeholder="Ex: Paciente irá reduzir peso em 5kg em 3 meses (realizando dieta e exercícios 3x/sem)."></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="evolution-prescribed-activities" class="form-label">Atividades Prescritas</label>
                            <textarea id="evolution-prescribed-activities" class="form-control" rows="3" placeholder="Ex: Caminhada diária de 30min, 2L de água/dia, evitar alimentos processados."></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="evolution-signature-area" class="form-label">Assinatura Digital (Mock)</label>
                            <div id="evolution-signature-area" class="signature-area">
                                <span id="evolution-signature-text">Clique para assinar</span>
                                <img id="evolution-signature-img" class="signature-img" src="" style="display:none;">
                            </div>
                            <input type="hidden" id="evolution-signature-data">
                            <small class="text-muted"><i class="fas fa-info-circle"></i> Esta é uma assinatura visual simulada. Para validade jurídica, integre com DocuSign, HelloSign ou ICP-Brasil.</small>
                        </div>
                    </div>

                    <h5 class="mt-4">Anexos da Evolução</h5>
                    <label for="evolution-file-upload-input" class="btn btn-outline-secondary mb-2"><i class="fas fa-paperclip me-2"></i>Anexar Arquivo</label>
                    <input type="file" id="evolution-file-upload-input" class="d-none" multiple>
                    <ul id="evolution-attachments-list" class="list-group mb-3">
                        <li class="list-group-item text-center text-muted">Nenhum anexo.</li>
                    </ul>

                    <h5 class="mt-4">Histórico de Versões</h5>
                    <div id="evolution-version-history" style="max-height: 200px; overflow-y: auto;">
                        <ul class="list-group" id="evolution-versions-list">
                            <li class="list-group-item text-center text-muted">Nenhuma versão anterior.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="save-evolution-btn">Salvar Evolução</button>
                    <button type="button" class="btn btn-danger" id="delete-evolution-btn" style="display: none;">Excluir Evolução</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Evolução (somente leitura com histórico) -->
    <div class="modal fade" id="viewEvolutionModal" tabindex="-1" aria-labelledby="viewEvolutionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewEvolutionModalLabel">Visualizar Evolução</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Paciente:</strong> <span id="view-evolution-patient-name"></span><br>
                        <strong>Data:</strong> <span id="view-evolution-date"></span><br>
                        <strong>Profissional:</strong> <span id="view-evolution-professional"></span><br>
                        <strong>Tipo:</strong> <span id="view-evolution-type"></span>
                    </div>
                    <hr>
                    <h6 class="mb-2">Anamnese / Observações:</h6>
                    <div id="view-evolution-anamnese" class="ql-editor p-0 border-0"></div>
                    <h6 class="mt-3 mb-2">Sinais Vitais / Exames:</h6>
                    <p id="view-evolution-vitals"></p>
                    <h6 class="mt-3 mb-2">Plano Terapêutico / Conduta:</h6>
                    <p id="view-evolution-therapeutic-plan"></p>
                    <h6 class="mt-3 mb-2">Metas SMART:</h6>
                    <p id="view-evolution-smart-goals"></p>
                    <h6 class="mt-3 mb-2">Atividades Prescritas:</h6>
                    <p id="view-evolution-prescribed-activities"></p>
                    <h6 class="mt-3 mb-2">Assinatura:</h6>
                    <div class="signature-area border-0 bg-transparent" style="min-height: auto;">
                        <img id="view-evolution-signature-img" class="signature-img" src="" style="display:none;">
                        <span id="view-evolution-signature-text"></span>
                    </div>

                    <h6 class="mt-4 mb-2">Anexos:</h6>
                    <ul id="view-evolution-attachments-list" class="list-group mb-3"></ul>

                    <h6 class="mt-4 mb-2">Histórico de Versões:</h6>
                    <select id="view-evolution-version-selector" class="form-select mb-3"></select>
                    <div id="evolution-version-diff" class="border p-3 rounded bg-light" style="max-height: 250px; overflow-y: auto;">
                        <!-- Diff content will be loaded here -->
                        Selecione uma versão para ver os detalhes.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="edit-evolution-from-view-btn"><i class="fas fa-edit me-2"></i>Editar</button>
                    <button type="button" class="btn btn-outline-primary" id="export-evolution-pdf-btn"><i class="fas fa-file-pdf me-2"></i>Gerar PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Agendamento -->
    <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="appointmentModalLabel">Novo Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="appointment-form">
                        <input type="hidden" id="appointment-id">
                        <div class="mb-3">
                            <label for="appointment-patient" class="form-label">Paciente</label>
                            <select id="appointment-patient" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="appointment-professional" class="form-label">Profissional</label>
                            <select id="appointment-professional" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="appointment-date" class="form-label">Data</label>
                            <input type="date" id="appointment-date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="appointment-time" class="form-label">Hora</label>
                            <input type="time" id="appointment-time" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="appointment-duration" class="form-label">Duração (minutos)</label>
                            <input type="number" id="appointment-duration" class="form-control" value="30" min="15" step="15" required>
                        </div>
                        <div class="mb-3">
                            <label for="appointment-room" class="form-label">Sala/Recurso</label>
                            <input type="text" id="appointment-room" class="form-control" placeholder="Sala 1, Consultório B">
                        </div>
                        <div class="mb-3">
                            <label for="appointment-status" class="form-label">Status</label>
                            <select id="appointment-status" class="form-select" required>
                                <option value="agendado">Agendado</option>
                                <option value="confirmado">Confirmado</option>
                                <option value="presente">Presente</option>
                                <option value="atrasou">Atrasou</option>
                                <option value="finalizado">Finalizado</option>
                                <option value="faltou">Faltou</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="appointment-notes" class="form-label">Notas</label>
                            <textarea id="appointment-notes" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="save-appointment-btn">Salvar Agendamento</button>
                    <button type="button" class="btn btn-danger" id="delete-appointment-btn" style="display: none;">Excluir Agendamento</button>
                    <button type="button" class="btn btn-outline-info" id="mock-send-reminder-btn"><i class="fas fa-bell me-2"></i>Enviar Lembrete (Mock)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Visualizar Arquivo -->
    <div class="modal fade" id="viewFileModal" tabindex="-1" aria-labelledby="viewFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewFileModalLabel">Visualizar Arquivo: <span id="view-file-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="file-preview-area">
                        <!-- Conteúdo de pré-visualização (imagem, iframe para PDF) -->
                        <img id="file-preview-img" class="file-preview" alt="Pré-visualização de imagem" style="display:none;">
                        <iframe id="file-preview-pdf" class="file-preview" style="width:100%; height:500px; display:none;"></iframe>
                        <p id="file-preview-text" class="text-muted" style="display:none;">Conteúdo de texto...</p>
                        <p id="file-preview-unsupported" style="display:none;"><i class="fas fa-exclamation-triangle me-2"></i>Pré-visualização não disponível para este tipo de arquivo.</p>
                    </div>
                    <p class="mt-3">
                        <strong>Paciente:</strong> <span id="view-file-patient-name"></span><br>
                        <strong>Pasta:</strong> <span id="view-file-folder"></span><br>
                        <strong>Upload:</strong> <span id="view-file-date"></span> por <span id="view-file-uploader"></span>
                    </p>
                    <button class="btn btn-outline-primary" id="download-file-btn"><i class="fas fa-download me-2"></i>Baixar Arquivo</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-danger" id="delete-file-btn"><i class="fas fa-trash me-2"></i>Excluir Arquivo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Membro da Equipe -->
    <div class="modal fade" id="teamMemberModal" tabindex="-1" aria-labelledby="teamMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamMemberModalLabel">Adicionar Membro da Equipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="team-member-form">
                        <input type="hidden" id="team-member-id">
                        <div class="mb-3">
                            <label for="team-member-name" class="form-label">Nome</label>
                            <input type="text" id="team-member-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="team-member-email" class="form-label">Email</label>
                            <input type="email" id="team-member-email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="team-member-password" class="form-label">Senha (deixe em branco para não alterar)</label>
                            <input type="password" id="team-member-password" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="team-member-role" class="form-label">Papel</label>
                            <select id="team-member-role" class="form-select" required>
                                <!-- Roles will be populated by JS -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissões Específicas</label>
                            <div id="team-member-permissions-checkboxes">
                                <!-- Checkboxes para permissões por módulo -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Configuração 2FA (Mock)</label>
                            <div id="2fa-setup-area" class="card p-3">
                                <p class="mb-2">Status: <span id="2fa-status-text" class="badge bg-secondary">Inativo</span></p>
                                <div id="2fa-qr-code-display" class="text-center mb-3" style="display:none;">
                                    <img id="2fa-qr-img" src="" alt="QR Code 2FA" class="img-fluid" style="max-width: 150px;">
                                    <p class="mt-2 small">Chave Secreta: <strong id="2fa-secret-key"></strong></p>
                                    <p class="small text-muted">Use um app autenticador (Google Authenticator) para escanear ou digitar a chave.</p>
                                    <p class="text-warning small"><i class="fas fa-exclamation-triangle"></i> **MOCK:** Este 2FA é apenas para demonstração. Não oferece segurança real.</p>
                                </div>
                                <button type="button" class="btn btn-outline-info w-100" id="activate-2fa-mock-btn"><i class="fas fa-shield-alt me-2"></i>Ativar 2FA (Mock)</button>
                                <button type="button" class="btn btn-outline-danger w-100 mt-2" id="deactivate-2fa-mock-btn" style="display:none;"><i class="fas fa-times-circle me-2"></i>Desativar 2FA (Mock)</button>
                            </div>
                            <small class="text-info mt-2"><i class="fas fa-info-circle"></i> Para 2FA real, integre com serviços como Twilio Authy ou TOTP server-side.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="save-team-member-btn">Salvar Membro</button>
                    <button type="button" class="btn btn-danger" id="delete-team-member-btn" style="display: none;">Excluir Membro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Verificação 2FA (Mock) -->
    <div class="modal fade" id="twoFAModal" tabindex="-1" aria-labelledby="twoFAModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="twoFAModalLabel">Verificação 2FA (Mock)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Insira o código gerado pelo seu aplicativo autenticador (Mock).</p>
                    <input type="text" id="2fa-code-input" class="form-control mb-3" placeholder="Código 2FA">
                    <p class="small text-muted text-warning"><i class="fas fa-exclamation-triangle"></i> **MOCK:** Qualquer código de 6 dígitos será aceito para demonstração.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="verify-2fa-mock-btn">Verificar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Template de Documento -->
    <div class="modal fade" id="documentTemplateModal" tabindex="-1" aria-labelledby="documentTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentTemplateModalLabel">Novo Template de Documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="document-template-form">
                        <input type="hidden" id="doc-template-id">
                        <div class="mb-3">
                            <label for="doc-template-name" class="form-label">Nome do Template</label>
                            <input type="text" id="doc-template-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="doc-template-type" class="form-label">Tipo de Documento</label>
                            <select id="doc-template-type" class="form-select">
                                <option value="prescription">Prescrição</option>
                                <option value="exam_request">Solicitação de Exame</option>
                                <option value="medical_certificate">Atestado Médico</option>
                                <option value="medical_report">Laudo Médico</option>
                                <option value="evolution_template">Template de Evolução</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="doc-template-specialty" class="form-label">Especialidade (Opcional)</label>
                            <input type="text" id="doc-template-specialty" class="form-control" placeholder="Ex: Nutrição, Psicologia">
                        </div>
                        <div class="mb-3">
                            <label for="doc-template-content" class="form-label">Conteúdo do Template</label>
                            <div id="doc-template-content-editor" class="quill-container"></div>
                            <small class="text-muted mt-2">Use placeholders como <code>{{patient.name}}</code>, <code>{{professional.name}}</code>, <code>{{org.name}}</code>, <code>{{currentDate}}</code>.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="save-doc-template-btn">Salvar Template</button>
                    <button type="button" class="btn btn-danger" id="delete-doc-template-btn" style="display: none;">Excluir Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciar Organizações -->
    <div class="modal fade" id="manageOrgsModal" tabindex="-1" aria-labelledby="manageOrgsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageOrgsModalLabel">Gerenciar Organizações</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-3" id="org-manage-list">
                        <!-- Organizações serão listadas aqui -->
                    </ul>
                    <button class="btn btn-primary w-100 mb-2" id="create-new-org-modal-btn"><i class="fas fa-plus-circle me-2"></i>Criar Nova Organização</button>
                    <div id="new-org-form-area" style="display:none;">
                        <input type="text" id="new-org-name-input" class="form-control mb-2" placeholder="Nome da Nova Organização">
                        <input type="email" id="new-org-admin-email" class="form-control mb-2" placeholder="Email do Admin (Será o owner)">
                        <input type="password" id="new-org-admin-password" class="form-control mb-2" placeholder="Senha do Admin">
                        <button class="btn btn-success w-100" id="save-new-org-btn">Salvar Nova Organização</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Toasts will be appended here -->
    </div>

    <!-- Online Status Indicator -->
    <div id="online-status-indicator" class="online-status"></div>

    <script>
        dayjs.extend(dayjs_plugin_localizedFormat);
        dayjs.extend(dayjs_plugin_isBetween);
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);

        dayjs.tz.setDefault(dayjs.tz.guess()); // Set default timezone to local

        // --- GLOBAL APP STATE & UTILITIES ---
        const APP_NAME = "ProntuarioPremium";
        let DB_ aqui