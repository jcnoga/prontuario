<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OdontoSystem - Gestão Odontológica</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs (Compatibilidade v9 via CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- PDF Export Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --bg-light: #f8f9fa;
        }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .nav-link { color: #555; margin-bottom: 5px; border-radius: 5px; }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-color); color: white; }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .status-agendado { color: orange; font-weight: bold; }
        .status-confirmado { color: green; font-weight: bold; }
        .status-cancelado { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <!-- Loading Spinner -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-4" style="width: 400px;">
            <h3 class="text-center mb-4"><i class="fas fa-tooth text-primary"></i> OdontoSystem</h3>
            <form id="login-form">
                <div class="mb-3">
                    <label>E-mail</label>
                    <input type="email" id="login-email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" id="login-password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
                <div class="mt-3 text-center">
                    <a href="#" onclick="authModule.recoverPassword()">Esqueci a senha</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Layout Principal (Sidebar + Conteúdo) -->
    <div id="main-layout" class="container-fluid hidden">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block sidebar py-3">
                <div class="text-center mb-4">
                    <h4><i class="fas fa-tooth text-primary"></i> OdontoSys</h4>
                    <small id="user-role-display" class="text-muted">Carregando...</small>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="router.navigate('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="router.navigate('agenda')"><i class="fas fa-calendar-alt"></i> Agenda</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="router.navigate('pacientes')"><i class="fas fa-users"></i> Pacientes</a></li>
                    <li class="nav-item role-admin hidden"><a class="nav-link" href="#" onclick="router.navigate('usuarios')"><i class="fas fa-user-shield"></i> Usuários</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="router.navigate('relatorios')"><i class="fas fa-chart-bar"></i> Relatórios</a></li>
                    <li class="nav-item mt-4"><a class="nav-link text-danger" href="#" onclick="authModule.logout()"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
                </ul>
            </nav>

            <!-- Conteúdo Principal -->
            <main class="col-md-10 ms-sm-auto px-md-4 py-4">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="view-section">
                    <h2>Dashboard</h2>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white p-3">
                                <h5>Consultas Hoje</h5>
                                <h2 id="dash-today-count">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white p-3">
                                <h5>Pacientes Totais</h5>
                                <h2 id="dash-patient-count">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white p-3">
                                <h5>Retornos Pendentes</h5>
                                <h2 id="dash-returns">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3" id="dash-alert">
                        <strong>Avisos:</strong> Verifique a agenda para confirmações pendentes.
                    </div>
                </div>

                <!-- AGENDA -->
                <div id="view-agenda" class="view-section hidden">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Agenda</h2>
                        <button class="btn btn-primary" onclick="agendaModule.openModal()">Nova Consulta</button>
                    </div>
                    <input type="date" id="agenda-date-filter" class="form-control w-auto mb-3" onchange="agendaModule.loadAgenda()">
                    <div class="table-responsive">
                        <table class="table table-hover bg-white">
                            <thead><tr><th>Hora</th><th>Paciente</th><th>Profissional</th><th>Procedimento</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="agenda-list"></tbody>
                        </table>
                    </div>
                </div>

                <!-- PACIENTES -->
                <div id="view-pacientes" class="view-section hidden">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Pacientes</h2>
                        <button class="btn btn-primary" onclick="patientModule.openModal()">Novo Paciente</button>
                    </div>
                    <input type="text" class="form-control mb-3" placeholder="Buscar por nome ou CPF..." onkeyup="patientModule.search(this.value)">
                    <div class="table-responsive">
                        <table class="table table-hover bg-white">
                            <thead><tr><th>Nome</th><th>CPF</th><th>Telefone</th><th>Ações</th></tr></thead>
                            <tbody id="patient-list"></tbody>
                        </table>
                    </div>
                </div>

                <!-- DETALHE PACIENTE (Prontuário) -->
                <div id="view-patient-detail" class="view-section hidden">
                    <button class="btn btn-secondary mb-3" onclick="router.navigate('pacientes')"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <div class="card p-3">
                        <h3 id="detail-name">Nome do Paciente</h3>
                        <p id="detail-info" class="text-muted">CPF: ... | Email: ...</p>
                        
                        <ul class="nav nav-tabs" id="patientTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-anamnese">Anamnese</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-evolucao">Evolução/Prontuário</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-arquivos">Arquivos</button></li>
                        </ul>
                        
                        <div class="tab-content p-3 border border-top-0 bg-white">
                            <!-- Anamnese -->
                            <div class="tab-pane fade show active" id="tab-anamnese">
                                <textarea id="anamnese-text" class="form-control mb-2" rows="5" placeholder="Alergias, Doenças, Histórico..."></textarea>
                                <button class="btn btn-primary" onclick="patientModule.saveAnamnese()">Salvar Anamnese</button>
                            </div>
                            <!-- Evolução -->
                            <div class="tab-pane fade" id="tab-evolucao">
                                <div class="mb-3">
                                    <label>Nova Evolução</label>
                                    <textarea id="evo-text" class="form-control" rows="2"></textarea>
                                    <button class="btn btn-success mt-2" onclick="patientModule.addEvolution()">Adicionar Registro</button>
                                    <button class="btn btn-outline-secondary mt-2 ms-2" onclick="patientModule.exportPDF()">Exportar PDF</button>
                                </div>
                                <div id="evolution-history" class="mt-4 border-top pt-2">
                                    <!-- Histórico injetado aqui -->
                                </div>
                            </div>
                            <!-- Arquivos -->
                            <div class="tab-pane fade" id="tab-arquivos">
                                <div class="input-group mb-3">
                                    <input type="file" class="form-control" id="file-upload-input">
                                    <button class="btn btn-outline-primary" type="button" onclick="patientModule.uploadFile()">Upload</button>
                                </div>
                                <ul class="list-group" id="file-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- USUÁRIOS (Admin) -->
                <div id="view-usuarios" class="view-section hidden">
                    <h2>Gestão de Usuários</h2>
                    <div class="card p-3 mb-3">
                        <h5>Novo Usuário</h5>
                        <form onsubmit="userModule.create(event)">
                            <div class="row">
                                <div class="col"><input type="email" id="new-user-email" placeholder="E-mail" class="form-control" required></div>
                                <div class="col"><input type="password" id="new-user-pass" placeholder="Senha" class="form-control" required></div>
                                <div class="col">
                                    <select id="new-user-role" class="form-control">
                                        <option value="recepcao">Recepção</option>
                                        <option value="dentista">Dentista</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="col-auto"><button type="submit" class="btn btn-primary">Criar</button></div>
                            </div>
                        </form>
                    </div>
                    <table class="table bg-white">
                        <thead><tr><th>Email</th><th>Função</th><th>Ações</th></tr></thead>
                        <tbody id="users-list"></tbody>
                    </table>
                </div>
                
                <!-- RELATÓRIOS -->
                <div id="view-relatorios" class="view-section hidden">
                    <h2>Relatórios</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5>Exportar Pacientes</h5>
                                <button onclick="reportsModule.exportPatientsCSV()" class="btn btn-outline-success">Baixar CSV</button>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL: Agenda -->
    <div class="modal fade" id="modal-agenda" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Agendamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="agenda-id">
                    <label>Paciente</label>
                    <select id="agenda-paciente" class="form-control mb-2"></select>
                    <label>Data e Hora</label>
                    <input type="datetime-local" id="agenda-data" class="form-control mb-2">
                    <label>Procedimento</label>
                    <input type="text" id="agenda-proc" class="form-control mb-2">
                    <label>Status</label>
                    <select id="agenda-status" class="form-control mb-2">
                        <option value="Agendado">Agendado</option>
                        <option value="Confirmado">Confirmado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger hidden" id="btn-delete-agenda" onclick="agendaModule.delete()">Excluir</button>
                    <button type="button" class="btn btn-primary" onclick="agendaModule.save()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Novo Paciente -->
    <div class="modal fade" id="modal-paciente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Dados do Paciente</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="pat-id">
                    <input type="text" id="pat-nome" placeholder="Nome Completo" class="form-control mb-2" required>
                    <input type="text" id="pat-cpf" placeholder="CPF" class="form-control mb-2">
                    <input type="text" id="pat-tel" placeholder="Telefone" class="form-control mb-2">
                    <input type="email" id="pat-email" placeholder="E-mail" class="form-control mb-2">
                    <textarea id="pat-endereco" placeholder="Endereço" class="form-control mb-2"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="patientModule.save()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /** 
         * CONFIGURAÇÃO DO FIREBASE 
         * SUBSTITUA PELAS SUAS CREDENCIAIS DO CONSOLE FIREBASE
         */
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC5lYxqNHxCOBPH-ZFK9Br4PHnOCFzUyXs",
  authDomain: "prontuario-ee1fd.firebaseapp.com",
  projectId: "prontuario-ee1fd",
  storageBucket: "prontuario-ee1fd.firebasestorage.app",
  messagingSenderId: "107787636728",
  appId: "1:107787636728:web:e9928f381c023d9650100d",
  measurementId: "G-SNFKY1NQ1C"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        // Inicialização
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Estado Global
        let currentUser = null;
        let currentRole = null;
        let currentPatientId = null;

        // --- Módulo de Roteamento ---
        const router = {
            navigate: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                
                const target = document.getElementById('view-' + viewId);
                if (target) {
                    target.classList.remove('hidden');
                    // Destaque no menu
                    // Lógica simples para o menu
                }

                if(viewId === 'dashboard') dashboardModule.load();
                if(viewId === 'agenda') agendaModule.loadAgenda();
                if(viewId === 'pacientes') patientModule.loadList();
                if(viewId === 'usuarios') userModule.loadList();
            }
        };

        // --- Módulo de Autenticação ---
        const authModule = {
            init: () => {
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const pass = document.getElementById('login-password').value;
                    try {
                        ui.toggleLoading(true);
                        await auth.signInWithEmailAndPassword(email, pass);
                        // O onAuthStateChanged cuidará do resto
                    } catch (error) {
                        alert("Erro no login: " + error.message);
                        ui.toggleLoading(false);
                    }
                });

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        // Buscar Role
                        const doc = await db.collection('users').doc(user.uid).get();
                        currentRole = doc.exists ? doc.data().role : 'recepcao'; // Default
                        
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('main-layout').classList.remove('hidden');
                        document.getElementById('user-role-display').innerText = `Olá, ${user.email} (${currentRole})`;

                        // Controle de Permissões UI
                        if(currentRole !== 'admin') {
                            document.querySelectorAll('.role-admin').forEach(el => el.classList.add('hidden'));
                        } else {
                            document.querySelectorAll('.role-admin').forEach(el => el.classList.remove('hidden'));
                        }

                        router.navigate('dashboard');
                    } else {
                        document.getElementById('login-screen').classList.remove('hidden');
                        document.getElementById('main-layout').classList.add('hidden');
                        currentUser = null;
                    }
                    ui.toggleLoading(false);
                });
            },
            logout: () => auth.signOut(),
            recoverPassword: () => {
                const email = prompt("Digite seu e-mail para recuperação:");
                if(email) {
                    auth.sendPasswordResetEmail(email)
                        .then(() => alert("E-mail enviado!"))
                        .catch(e => alert("Erro: " + e.message));
                }
            }
        };

        // --- Módulo de Pacientes ---
        const patientModule = {
            modal: new bootstrap.Modal(document.getElementById('modal-paciente')),
            
            loadList: async () => {
                const snapshot = await db.collection('patients').orderBy('name').limit(20).get();
                patientModule.renderTable(snapshot.docs);
            },

            search: async (term) => {
                if(term.length < 3) { patientModule.loadList(); return; }
                // Busca simples (Firebase não tem LIKE nativo perfeito, usando startAt)
                const snapshot = await db.collection('patients')
                    .orderBy('name')
                    .startAt(term)
                    .endAt(term + '\uf8ff')
                    .get();
                patientModule.renderTable(snapshot.docs);
            },

            renderTable: (docs) => {
                const tbody = document.getElementById('patient-list');
                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const data = doc.data();
                    tbody.innerHTML += `
                        <tr>
                            <td>${data.name}</td>
                            <td>${data.cpf || '-'}</td>
                            <td>${data.phone || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white" onclick="patientModule.openDetail('${doc.id}')"><i class="fas fa-folder-open"></i> Prontuário</button>
                                <button class="btn btn-sm btn-secondary" onclick="patientModule.edit('${doc.id}')"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>
                    `;
                });
            },

            openModal: () => {
                document.getElementById('pat-id').value = '';
                document.getElementById('pat-nome').value = '';
                document.getElementById('pat-cpf').value = '';
                document.getElementById('pat-tel').value = '';
                document.getElementById('pat-email').value = '';
                document.getElementById('pat-endereco').value = '';
                patientModule.modal.show();
            },

            edit: async (id) => {
                const doc = await db.collection('patients').doc(id).get();
                const data = doc.data();
                document.getElementById('pat-id').value = id;
                document.getElementById('pat-nome').value = data.name;
                document.getElementById('pat-cpf').value = data.cpf;
                document.getElementById('pat-tel').value = data.phone;
                document.getElementById('pat-email').value = data.email;
                document.getElementById('pat-endereco').value = data.address;
                patientModule.modal.show();
            },

            save: async () => {
                const id = document.getElementById('pat-id').value;
                const data = {
                    name: document.getElementById('pat-nome').value,
                    cpf: document.getElementById('pat-cpf').value,
                    phone: document.getElementById('pat-tel').value,
                    email: document.getElementById('pat-email').value,
                    address: document.getElementById('pat-endereco').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if(id) {
                        await db.collection('patients').doc(id).update(data);
                    } else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('patients').add(data);
                    }
                    patientModule.modal.hide();
                    patientModule.loadList();
                    alert("Salvo com sucesso!");
                } catch (e) {
                    alert("Erro ao salvar: " + e.message);
                }
            },

            // --- Prontuário ---
            openDetail: async (id) => {
                currentPatientId = id;
                const doc = await db.collection('patients').doc(id).get();
                const data = doc.data();
                
                document.getElementById('detail-name').innerText = data.name;
                document.getElementById('detail-info').innerText = `CPF: ${data.cpf} | Email: ${data.email}`;
                document.getElementById('anamnese-text').value = data.anamnese || '';
                
                router.navigate('patient-detail');
                patientModule.loadEvolution(id);
                patientModule.loadFiles(id);
            },

            saveAnamnese: async () => {
                const text = document.getElementById('anamnese-text').value;
                await db.collection('patients').doc(currentPatientId).update({ anamnese: text });
                alert("Anamnese atualizada.");
            },

            addEvolution: async () => {
                const text = document.getElementById('evo-text').value;
                if(!text) return;
                
                await db.collection('patients').doc(currentPatientId).collection('evolution').add({
                    text: text,
                    professional: currentUser.email,
                    date: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('evo-text').value = '';
                patientModule.loadEvolution(currentPatientId);
            },

            loadEvolution: async (id) => {
                const container = document.getElementById('evolution-history');
                container.innerHTML = '<p class="text-muted">Carregando...</p>';
                
                const snap = await db.collection('patients').doc(id).collection('evolution').orderBy('date', 'desc').get();
                container.innerHTML = '';
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const dateStr = d.date ? d.date.toDate().toLocaleString() : 'Agora';
                    container.innerHTML += `
                        <div class="card p-2 bg-light mb-2">
                            <small class="text-muted"><strong>${dateStr}</strong> por ${d.professional}</small>
                            <p class="mb-0 mt-1">${d.text}</p>
                        </div>
                    `;
                });
            },

            uploadFile: async () => {
                const fileInput = document.getElementById('file-upload-input');
                const file = fileInput.files[0];
                if(!file) return alert("Selecione um arquivo.");

                try {
                    ui.toggleLoading(true);
                    const ref = storage.ref().child(`uploads/${currentPatientId}/${Date.now()}_${file.name}`);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();

                    // Salvar referência no Firestore
                    await db.collection('patients').doc(currentPatientId).collection('files').add({
                        name: file.name,
                        url: url,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    ui.toggleLoading(false);
                    fileInput.value = '';
                    patientModule.loadFiles(currentPatientId);
                } catch (e) {
                    ui.toggleLoading(false);
                    alert("Erro no upload: " + e.message);
                }
            },

            loadFiles: async (id) => {
                const list = document.getElementById('file-list');
                list.innerHTML = '';
                const snap = await db.collection('patients').doc(id).collection('files').orderBy('date', 'desc').get();
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${d.name}
                            <a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i></a>
                        </li>
                    `;
                });
            },

            exportPDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const name = document.getElementById('detail-name').innerText;
                const history = document.getElementById('evolution-history').innerText;
                
                doc.text(`Prontuário: ${name}`, 10, 10);
                doc.text("Histórico de Evolução:", 10, 20);
                
                // Split text para caber na página
                const splitText = doc.splitTextToSize(history, 180);
                doc.text(splitText, 10, 30);
                
                doc.save(`prontuario_${name}.pdf`);
            }
        };

        // --- Módulo de Agenda ---
        const agendaModule = {
            modal: new bootstrap.Modal(document.getElementById('modal-agenda')),
            
            loadAgenda: async () => {
                const dateVal = document.getElementById('agenda-date-filter').value || new Date().toISOString().split('T')[0];
                document.getElementById('agenda-date-filter').value = dateVal;

                // Filtro simples por string de data (para simplificar query)
                const start = new Date(dateVal + 'T00:00:00');
                const end = new Date(dateVal + 'T23:59:59');

                const snap = await db.collection('appointments')
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .orderBy('date')
                    .get();

                const tbody = document.getElementById('agenda-list');
                tbody.innerHTML = '';
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const time = d.date.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const statusClass = d.status === 'Confirmado' ? 'status-confirmado' : (d.status === 'Cancelado' ? 'status-cancelado' : 'status-agendado');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${time}</td>
                            <td>${d.patientName}</td>
                            <td>${d.dentist}</td>
                            <td>${d.procedure}</td>
                            <td class="${statusClass}">${d.status}</td>
                            <td>
                                <button class="btn btn-sm btn-light" onclick="agendaModule.edit('${doc.id}')"><i class="fas fa-edit"></i></button>
                                <a href="mailto:${d.patientEmail}?subject=Lembrete de Consulta&body=Olá, lembramos de sua consulta dia ${dateVal} as ${time}." class="btn btn-sm btn-warning"><i class="fas fa-envelope"></i></a>
                            </td>
                        </tr>
                    `;
                });
            },

            openModal: async () => {
                document.getElementById('agenda-id').value = '';
                document.getElementById('agenda-status').value = 'Agendado';
                document.getElementById('btn-delete-agenda').classList.add('hidden');
                
                // Carregar pacientes para o select
                const select = document.getElementById('agenda-paciente');
                select.innerHTML = '';
                const snap = await db.collection('patients').get();
                snap.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.text = doc.data().name;
                    opt.dataset.email = doc.data().email;
                    select.add(opt);
                });

                agendaModule.modal.show();
            },

            edit: async (id) => {
                await agendaModule.openModal(); // Carrega select
                const doc = await db.collection('appointments').doc(id).get();
                const d = doc.data();
                
                document.getElementById('agenda-id').value = id;
                document.getElementById('agenda-paciente').value = d.patientId;
                
                // Format Date for Input
                const dt = d.date.toDate();
                dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
                document.getElementById('agenda-data').value = dt.toISOString().slice(0,16);
                
                document.getElementById('agenda-proc').value = d.procedure;
                document.getElementById('agenda-status').value = d.status;
                document.getElementById('btn-delete-agenda').classList.remove('hidden');
            },

            save: async () => {
                const id = document.getElementById('agenda-id').value;
                const patSelect = document.getElementById('agenda-paciente');
                const dateStr = document.getElementById('agenda-data').value;
                
                if(!dateStr) return alert("Selecione data e hora");

                const data = {
                    patientId: patSelect.value,
                    patientName: patSelect.options[patSelect.selectedIndex].text,
                    patientEmail: patSelect.options[patSelect.selectedIndex].dataset.email,
                    date: new Date(dateStr),
                    procedure: document.getElementById('agenda-proc').value,
                    status: document.getElementById('agenda-status').value,
                    dentist: currentUser.email // Simplificação: quem agenda é o "dono" ou pegar de um select
                };

                // Check Conflict (Simplificado)
                // Em prod, fazer query verificando range
                
                if(id) {
                    await db.collection('appointments').doc(id).update(data);
                } else {
                    await db.collection('appointments').add(data);
                }
                agendaModule.modal.hide();
                agendaModule.loadAgenda();
            },
            
            delete: async () => {
                const id = document.getElementById('agenda-id').value;
                if(confirm("Excluir agendamento?")) {
                    await db.collection('appointments').doc(id).delete();
                    agendaModule.modal.hide();
                    agendaModule.loadAgenda();
                }
            }
        };

        // --- Módulo de Usuários (Admin) ---
        const userModule = {
            create: async (e) => {
                e.preventDefault();
                const email = document.getElementById('new-user-email').value;
                const pass = document.getElementById('new-user-pass').value;
                const role = document.getElementById('new-user-role').value;

                // OBS: Criar usuário secundário enquanto logado requer Cloud Functions
                // ou fazer logout, criar, e relogar.
                // Aqui apenas salvamos no Firestore para fins de registro, 
                // a criação real da Auth deve ser feita no Console Firebase ou via Backend real.
                alert("Atenção: Em um app Client-Side puro, você deve criar o login no Firebase Console > Authentication. Aqui registraremos apenas os metadados de permissão.");

                try {
                    // Simulando a lógica de salvar metadados
                    // O UID teria que vir da criação real. Usaremos email como ID temporário
                    await db.collection('users').doc(email).set({
                        email: email,
                        role: role
                    });
                    alert("Permissão de usuário registrada. Crie a conta no Firebase Auth manualmente.");
                    userModule.loadList();
                } catch(e) {
                    alert("Erro: " + e.message);
                }
            },
            loadList: async () => {
                const tbody = document.getElementById('users-list');
                tbody.innerHTML = '';
                const snap = await db.collection('users').get();
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr><td>${d.email}</td><td>${d.role}</td><td><button class="btn btn-sm btn-danger">X</button></td></tr>`;
                });
            }
        };

        // --- Dashboard & Reports ---
        const dashboardModule = {
            load: async () => {
                // Contadores básicos
                const today = new Date();
                today.setHours(0,0,0,0);
                
                const appSnap = await db.collection('appointments')
                    .where('date', '>=', today)
                    .where('date', '<', new Date(today.getTime() + 86400000))
                    .get();
                document.getElementById('dash-today-count').innerText = appSnap.size;

                const patSnap = await db.collection('patients').get(); // Em prod usar count() aggregation
                document.getElementById('dash-patient-count').innerText = patSnap.size;
            }
        };
        
        const reportsModule = {
            exportPatientsCSV: async () => {
                const snap = await db.collection('patients').get();
                let csv = "Nome,CPF,Email,Telefone\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    csv += `"${d.name}","${d.cpf}","${d.email}","${d.phone}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pacientes.csv';
                a.click();
            }
        };

        // Helpers
        const ui = {
            toggleLoading: (show) => {
                document.getElementById('loading-overlay').classList.toggle('hidden', !show);
            }
        };

        // Inicializa a lógica de UI
        ui.toggleLoading(true);
        authModule.init();

    </script>
</body>
<!-- </html> -->