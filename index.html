<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SaaS Clinic - MVP (Single File)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .fade-in { animation: fadeIn .25s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
    .small { font-size: 0.85rem; }
    ::-webkit-scrollbar { height: 10px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.6); border-radius: 6px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

  <div class="flex h-screen">
    <!-- SIDEBAR -->
    <aside class="w-72 bg-slate-900 text-white p-4 hidden md:flex flex-col">
      <div class="flex items-center gap-3 mb-6">
        <!-- Imagem enviada pelo usuário (caminho local fornecido) -->
        <img src="sandbox:/mnt/data/59feb59c-b7ed-42aa-b427-0c2cb8a87b31.png" alt="Logo" class="w-10 h-10 object-cover rounded" onerror="this.style.display='none'"/>
        <div>
          <h1 class="text-xl font-bold">SaaS Clinic</h1>
          <div class="text-xs text-slate-400">MVP • Agendamento & Pacientes</div>
        </div>
      </div>

      <nav class="flex-1 space-y-1">
        <button onclick="router('dashboard')" id="nav-dashboard" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800 flex items-center gap-3 bg-slate-800 text-blue-400"><i class="fa-solid fa-chart-line"></i> Painel</button>
        <button onclick="router('agenda')" id="nav-agenda" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800 flex items-center gap-3 text-slate-300"><i class="fa-regular fa-calendar-days"></i> Agenda</button>
        <button onclick="router('pacientes')" id="nav-pacientes" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800 flex items-center gap-3 text-slate-300"><i class="fa-solid fa-users"></i> Pacientes</button>
        <button onclick="router('relatorios')" id="nav-relatorios" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800 flex items-center gap-3 text-slate-300"><i class="fa-solid fa-file-lines"></i> Relatórios / Export</button>
      </nav>

      <div class="mt-6 text-xs text-slate-400">
        <div class="border-t border-slate-700 pt-4">
          Versão MVP • LocalStorage
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-auto">
      <!-- Mobile header -->
      <header class="md:hidden bg-slate-900 text-white p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold">S</div>
          <div>
            <div class="font-bold">SaaS Clinic</div>
            <div class="text-xs text-slate-200">MVP</div>
          </div>
        </div>
        <div>
          <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="px-3 py-1"><i class="fa-solid fa-bars"></i></button>
        </div>
      </header>

      <div class="p-6">
        <!-- DASHBOARD -->
        <section id="dashboard" class="fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold">Painel • SaaS Clinic (MVP)</h2>
              <p class="text-slate-500 small">Visão geral rápida dos atendimentos e pacientes.</p>
            </div>
            <div class="flex gap-2">
              <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" onclick="openModal('modal-agendamento')"><i class="fa-solid fa-plus mr-2"></i>Novo Agendamento</button>
              <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" onclick="openModal('modal-paciente')"><i class="fa-solid fa-user-plus mr-2"></i>Novo Paciente</button>
            </div>
          </div>

          <!-- KPI row -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded shadow">
              <div class="text-slate-400 text-xs">Agendamentos Hoje</div>
              <div class="text-2xl font-bold" id="k-agendamentos">0</div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <div class="text-slate-400 text-xs">Pacientes Registrados</div>
              <div class="text-2xl font-bold" id="k-pacientes">0</div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <div class="text-slate-400 text-xs">Faturamento Estimado</div>
              <div class="text-2xl font-bold" id="k-faturamento">R$ 0</div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <div class="text-slate-400 text-xs">Taxa de Confirmação</div>
              <div class="text-2xl font-bold text-blue-600" id="k-confirmacao">-</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-4 rounded shadow lg:col-span-2">
              <h3 class="font-semibold mb-3">Atendimentos da Semana</h3>
              <canvas id="chartAtendimentos" height="120"></canvas>
            </div>

            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold mb-3">Próximos Agendamentos</h3>
              <div id="lista-proximos" class="space-y-3"></div>
            </div>
          </div>
        </section>

        <!-- AGENDA -->
        <section id="agenda" class="hidden fade-in">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Agenda Inteligente</h2>
            <div class="flex gap-2">
              <input type="date" id="filter-date" class="border rounded px-3 py-2 small" onchange="renderAgenda()" />
              <button class="bg-blue-600 text-white px-3 py-2 rounded" onclick="openModal('modal-agendamento')">Novo</button>
            </div>
          </div>

          <div class="bg-white rounded shadow overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-slate-50 text-slate-500 text-sm">
                <tr><th class="p-3">Horário</th><th class="p-3">Paciente</th><th class="p-3">Procedimento</th><th class="p-3">Valor</th><th class="p-3">Status</th><th class="p-3 text-right">Ações</th></tr>
              </thead>
              <tbody id="agenda-list" class="divide-y"></tbody>
            </table>
          </div>
        </section>

        <!-- PACIENTES -->
        <section id="pacientes" class="hidden fade-in">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Pacientes</h2>
            <div class="flex gap-2">
              <input id="search-paciente" placeholder="Buscar por nome ou telefone..." class="border rounded px-3 py-2 small" oninput="renderPacientes()" />
              <button class="bg-green-600 text-white px-3 py-2 rounded" onclick="openModal('modal-paciente')">Novo</button>
            </div>
          </div>

          <div class="bg-white rounded shadow overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-slate-50 text-slate-500 text-sm">
                <tr><th class="p-3">Nome</th><th class="p-3">Telefone</th><th class="p-3">Última Visita</th><th class="p-3 text-right">Ações</th></tr>
              </thead>
              <tbody id="pacientes-list" class="divide-y"></tbody>
            </table>
          </div>
        </section>

        <!-- RELATÓRIOS / EXPORT -->
        <section id="relatorios" class="hidden fade-in">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Exportar / Importar</h2>
            <div class="flex gap-2">
              <input id="file-csv" type="file" accept=".csv" class="hidden" onchange="importCSV(event)" />
              <button class="bg-slate-700 text-white px-3 py-2 rounded" onclick="document.getElementById('file-csv').click()">Importar CSV</button>
              <button class="bg-blue-600 text-white px-3 py-2 rounded" onclick="exportCSV()">Exportar CSV</button>
              <button class="bg-neutral-600 text-white px-3 py-2 rounded" onclick="downloadBackup()">Backup (.json)</button>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow">
            <p class="small text-slate-600">Exporta os dados atuais para CSV (pacientes + agendamentos) ou baixa backup completo em JSON.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- MODAIS -->
  <div id="modal-paciente" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg w-full max-w-md p-6 m-4">
      <h3 class="font-bold text-lg mb-3">Cadastrar / Editar Paciente</h3>
      <form id="form-paciente" onsubmit="event.preventDefault(); savePaciente();">
        <input type="hidden" id="p-id" />
        <div class="space-y-3">
          <div><label class="block text-sm">Nome</label><input id="p-nome" required class="w-full border rounded px-3 py-2" /></div>
          <div><label class="block text-sm">Telefone (formato internacional ex: 5511999999999)</label><input id="p-tel" required class="w-full border rounded px-3 py-2" /></div>
          <div><label class="block text-sm">Email</label><input id="p-email" class="w-full border rounded px-3 py-2" /></div>
          <div><label class="block text-sm">Observações</label><textarea id="p-notes" class="w-full border rounded px-3 py-2 small"></textarea></div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button type="button" class="px-4 py-2 rounded" onclick="closeModal('modal-paciente')">Cancelar</button>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-agendamento" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg w-full max-w-md p-6 m-4">
      <h3 class="font-bold text-lg mb-3">Novo Agendamento</h3>
      <form id="form-agendamento" onsubmit="event.preventDefault(); saveAgendamento();">
        <input type="hidden" id="a-id" />
        <div class="space-y-3">
          <div>
            <label class="block text-sm">Paciente</label>
            <select id="a-paciente" class="w-full border rounded px-3 py-2"></select>
          </div>
          <div class="flex gap-2">
            <div><label class="block text-sm">Data</label><input id="a-data" type="date" required class="border rounded px-3 py-2" /></div>
            <div><label class="block text-sm">Hora</label><input id="a-hora" type="time" required class="border rounded px-3 py-2" /></div>
          </div>
          <div><label class="block text-sm">Procedimento</label><input id="a-procedimento" required class="w-full border rounded px-3 py-2" /></div>
          <div><label class="block text-sm">Valor (R$)</label><input id="a-valor" type="number" step="0.01" class="w-full border rounded px-3 py-2" /></div>
          <div><label class="block text-sm">Observações</label><input id="a-notes" class="w-full border rounded px-3 py-2" /></div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button type="button" class="px-4 py-2 rounded" onclick="closeModal('modal-agendamento')">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Agendar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    /* -------------------------
       Storage / Estado inicial
       ------------------------- */
    const DB_KEY = 'saas_clinic_mvp_v1';
    let db = {
      pacientes: [
        // exemplo
        { id: 1, nome: "Maria Silva", telefone: "5511999998888", email:"maria@email.com", notes:"", lastVisit:"2023-10-01" }
      ],
      agendamentos: [
        // exemplo
      ]
    };

    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if(raw) {
        try { db = JSON.parse(raw); } catch(e) { console.error('DB parse error', e); }
      } else saveDB();
    }
    function saveDB() {
      localStorage.setItem(DB_KEY, JSON.stringify(db));
      updateAll();
    }

    /* -------------------------
       Router / Views
       ------------------------- */
    function router(view) {
      document.querySelectorAll('section[id]').forEach(s => s.classList.add('hidden'));
      document.getElementById(view).classList.remove('hidden');

      // nav active
      document.querySelectorAll('aside button, header button').forEach(b => b.classList.remove('bg-slate-800','text-blue-400'));
      const map = { dashboard: 'nav-dashboard', agenda: 'nav-agenda', pacientes: 'nav-pacientes', relatorios: 'nav-relatorios' };
      if(map[view]) {
        const el = document.getElementById(map[view]);
        if(el) el.classList.add('bg-slate-800','text-blue-400');
      }

      if(view === 'dashboard') updateDashboard();
      if(view === 'agenda') { document.getElementById('filter-date').value = document.getElementById('filter-date').value || todayISO(); renderAgenda(); }
      if(view === 'pacientes') renderPacientes();
      if(view === 'relatorios') {}
    }

    /* -------------------------
       Utilitários
       ------------------------- */
    function todayISO() {
      return new Date().toISOString().split('T')[0];
    }
    function moneyBR(val) {
      if(!val) return 'R$ 0,00';
      return Number(val).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    }
    function genId() { return Date.now() + Math.floor(Math.random()*999); }

    /* -------------------------
       Dashboard
       ------------------------- */
    let chart = null;
    function updateDashboard() {
      const today = todayISO();
      const apptsToday = db.agendamentos.filter(a => a.data === today && a.status !== 'Cancelado');
      const kAg = apptsToday.length;
      const kPac = db.pacientes.length;
      const kFat = db.agendamentos.reduce((s,a)=> s + Number(a.valor || 0),0);

      document.getElementById('k-agendamentos').innerText = kAg;
      document.getElementById('k-pacientes').innerText = kPac;
      document.getElementById('k-faturamento').innerText = moneyBR(kFat);

      // taxa de confirmação = confirmados / (pendente+confirmado)
      const totalRelevant = db.agendamentos.filter(a=>a.status!=='Cancelado').length || 0;
      const confirmed = db.agendamentos.filter(a=>a.status==='Confirmado').length || 0;
      document.getElementById('k-confirmacao').innerText = totalRelevant ? Math.round(confirmed / totalRelevant * 100) + '%' : '-';

      // próximos 5
      const upcoming = db.agendamentos.filter(a=> a.status !== 'Cancelado').sort((a,b) => (a.data + a.hora).localeCompare(b.data + b.hora)).slice(0,5);
      const el = document.getElementById('lista-proximos'); el.innerHTML = '';
      upcoming.forEach(app => {
        const p = db.pacientes.find(x => x.id === app.pacienteId) || { nome: '—', telefone: '' };
        el.innerHTML += `
          <div class="p-3 rounded border bg-slate-50 flex justify-between items-center">
            <div>
              <div class="font-medium">${p.nome}</div>
              <div class="text-xs text-slate-500">${app.data.split('-').reverse().join('/')} ${app.hora} • ${app.procedimento}</div>
            </div>
            <div class="text-right small">
              <div class="${statusColor(app.status)} font-bold">${app.status}</div>
              <div class="mt-2"><button class="text-blue-600 text-sm" onclick="openWhatsAppReminder(${app.id})"><i class="fa-brands fa-whatsapp"></i> Lembrar</button></div>
            </div>
          </div>`;
      });

      // fake weekly data for chart (MVP visual)
      const labels = ['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'];
      const data = labels.map((l, idx) => Math.floor(Math.random()*8)+2); // sample
      renderChart(labels, data);
    }

    function renderChart(labels, data) {
      const ctx = document.getElementById('chartAtendimentos').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Atendimentos', data, borderRadius:6 }] }, options:{ plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true} } } });
    }

    /* -------------------------
       Agenda (CRUD)
       ------------------------- */
    function renderAgenda() {
      const tbody = document.getElementById('agenda-list');
      const filterDate = document.getElementById('filter-date').value || todayISO();
      document.getElementById('filter-date').value = filterDate;
      const list = db.agendamentos.filter(a => a.data === filterDate).sort((a,b)=>a.hora.localeCompare(b.hora));
      tbody.innerHTML = '';
      if(list.length === 0) {
        tbody.innerHTML = `<tr><td class="p-6 text-center text-slate-400" colspan="6">Nenhum agendamento para esta data.</td></tr>`;
        return;
      }
      list.forEach(a => {
        const p = db.pacientes.find(x => x.id === a.pacienteId) || { nome:'—', telefone:'' };
        tbody.innerHTML += `
          <tr class="hover:bg-slate-50">
            <td class="p-3 font-medium">${a.hora}</td>
            <td class="p-3">${p.nome}<div class="text-xs text-slate-400">${p.telefone}</div></td>
            <td class="p-3">${a.procedimento}</td>
            <td class="p-3">${moneyBR(a.valor)}</td>
            <td class="p-3"><span class="${statusColor(a.status)} font-bold">${a.status}</span></td>
            <td class="p-3 text-right small">
              <button class="mr-2" onclick="openWhatsAppReminder(${a.id})" title="Enviar lembrete WhatsApp"><i class="fa-brands fa-whatsapp text-green-600"></i></button>
              <button class="mr-2" onclick="toggleStatus(${a.id})" title="Alterar status"><i class="fa-solid fa-rotate"></i></button>
              <button onclick="editAgendamento(${a.id})" title="Editar"><i class="fa-solid fa-pen-to-square text-sky-600"></i></button>
            </td>
          </tr>`;
      });
    }

    function statusColor(s) {
      if(s==='Confirmado') return 'text-green-600';
      if(s==='Pendente') return 'text-yellow-600';
      if(s==='Cancelado') return 'text-red-600';
      return 'text-slate-600';
    }

    function toggleStatus(id) {
      const a = db.agendamentos.find(x => x.id === id); if(!a) return;
      a.status = a.status === 'Pendente' ? 'Confirmado' : (a.status === 'Confirmado' ? 'Cancelado' : 'Pendente');
      saveDB();
      renderAgenda();
    }

    function saveAgendamento() {
      const id = document.getElementById('a-id').value;
      const pacienteId = Number(document.getElementById('a-paciente').value);
      const data = document.getElementById('a-data').value;
      const hora = document.getElementById('a-hora').value;
      const proc = document.getElementById('a-procedimento').value;
      const valor = Number(document.getElementById('a-valor').value || 0);
      const notes = document.getElementById('a-notes').value || '';

      if(!pacienteId || !data || !hora || !proc) { alert('Preencha paciente, data, hora e procedimento.'); return; }

      if(id) {
        const a = db.agendamentos.find(x=>x.id==id);
        Object.assign(a, { pacienteId, data, hora, procedimento: proc, valor, notes });
      } else {
        db.agendamentos.push({ id: genId(), pacienteId, data, hora, procedimento: proc, valor, notes, status: 'Pendente' });
      }

      saveDB();
      closeModal('modal-agendamento');
      router('agenda');
    }

    function editAgendamento(id) {
      const a = db.agendamentos.find(x => x.id === id); if(!a) return;
      openModal('modal-agendamento');
      document.getElementById('a-id').value = a.id;
      document.getElementById('a-paciente').innerHTML = '';
      db.pacientes.forEach(p => document.getElementById('a-paciente').innerHTML += `<option value="${p.id}" ${p.id===a.pacienteId?'selected':''}>${p.nome}</option>`);
      document.getElementById('a-data').value = a.data;
      document.getElementById('a-hora').value = a.hora;
      document.getElementById('a-procedimento').value = a.procedimento;
      document.getElementById('a-valor').value = a.valor;
      document.getElementById('a-notes').value = a.notes || '';
    }

    /* -------------------------
       Pacientes (CRUD)
       ------------------------- */
    function renderPacientes() {
      const tbody = document.getElementById('pacientes-list');
      const term = document.getElementById('search-paciente').value.toLowerCase();
      const list = db.pacientes.filter(p => p.nome.toLowerCase().includes(term) || p.telefone.includes(term));
      tbody.innerHTML = '';
      if(list.length === 0) {
        tbody.innerHTML = `<tr><td class="p-6 text-center text-slate-400" colspan="4">Nenhum paciente encontrado.</td></tr>`;
        return;
      }
      list.forEach(p => {
        tbody.innerHTML += `
          <tr class="hover:bg-slate-50">
            <td class="p-3 font-medium">${p.nome}</td>
            <td class="p-3">${p.telefone}</td>
            <td class="p-3 small">${p.lastVisit || '-'}</td>
            <td class="p-3 text-right small">
              <button class="mr-2" onclick="openWhatsAppNumber('${p.telefone}')"><i class="fa-brands fa-whatsapp text-green-600"></i></button>
              <button onclick="editPaciente(${p.id})"><i class="fa-solid fa-pen-to-square text-sky-600"></i></button>
            </td>
          </tr>`;
      });
    }

    function savePaciente() {
      const id = document.getElementById('p-id').value;
      const nome = document.getElementById('p-nome').value.trim();
      const tel = document.getElementById('p-tel').value.trim();
      const email = document.getElementById('p-email').value.trim();
      const notes = document.getElementById('p-notes').value.trim();

      if(!nome || !tel) { alert('Nome e telefone são obrigatórios.'); return; }

      if(id) {
        const p = db.pacientes.find(x=>x.id==id);
        Object.assign(p, { nome, telefone: tel, email, notes });
      } else {
        db.pacientes.push({ id: genId(), nome, telefone: tel, email, notes, lastVisit: '-' });
      }

      saveDB();
      closeModal('modal-paciente');
      router('pacientes');
    }

    function editPaciente(id) {
      const p = db.pacientes.find(x => x.id === id); if(!p) return;
      openModal('modal-paciente');
      document.getElementById('p-id').value = p.id;
      document.getElementById('p-nome').value = p.nome;
      document.getElementById('p-tel').value = p.telefone;
      document.getElementById('p-email').value = p.email || '';
      document.getElementById('p-notes').value = p.notes || '';
    }

    /* -------------------------
       Lembretes (WhatsApp / SMS / Email)
       ------------------------- */
    function openWhatsAppReminder(agendamentoId) {
      const a = db.agendamentos.find(x => x.id === agendamentoId); if(!a) return;
      const p = db.pacientes.find(x => x.id === a.pacienteId); if(!p) { alert('Paciente não encontrado'); return; }
      const text = `Olá ${p.nome}, lembramos do seu agendamento em ${a.data.split('-').reverse().join('/')} às ${a.hora} para ${a.procedimento}. Responda SIM para confirmar.`;
      const phone = p.telefone.replace(/\D/g,'');
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank');
    }

    function openWhatsAppNumber(number) {
      const phone = (number || '').replace(/\D/g,'');
      if(!phone) { alert('Telefone inválido'); return; }
      window.open(`https://wa.me/${phone}`, '_blank');
    }

    /* -------------------------
       Import / Export CSV + Backup
       ------------------------- */
    function exportCSV() {
      // export pacientes + agendamentos as two CSVs in a zip-like single file (simple approach: combined CSV with type)
      let csv = 'type,id,field1,field2,field3,field4,field5,field6\n';
      db.pacientes.forEach(p => {
        csv += `patient,${p.id},"${p.nome}","${p.telefone}","${p.email || ''}","${(p.notes||'').replace(/\n/g,' ')}","${p.lastVisit || ''}",\n`;
      });
      db.agendamentos.forEach(a => {
        csv += `appointment,${a.id},${a.pacienteId},${a.data},${a.hora},"${(a.procedimento||'').replace(/"/g,'""')}",${a.valor || 0},${a.status}\n`;
      });

      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'saasclinic-export.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function importCSV(evt) {
      const file = evt.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).slice(1); // skip header
        lines.forEach(line => {
          if(!line.trim()) return;
          // naive CSV parse for this MVP (split by comma, respecting quotes would be better)
          // We expect "type,id,rest..."
          const parts = line.split(',');
          const type = parts[0];
          if(type === 'patient') {
            const id = Number(parts[1]);
            const nome = (parts[2] || '').replace(/(^"|"$)/g,'');
            const telefone = (parts[3] || '').replace(/(^"|"$)/g,'');
            const email = (parts[4] || '').replace(/(^"|"$)/g,'');
            if(!db.pacientes.find(p => p.id === id)) db.pacientes.push({ id, nome, telefone, email, notes:'', lastVisit:'-' });
          }
          if(type === 'appointment') {
            const id = Number(parts[1]);
            const pacienteId = Number(parts[2]);
            const data = parts[3];
            const hora = parts[4];
            const proc = (parts[5] || '').replace(/(^"|"$)/g,'');
            const valor = Number(parts[6] || 0);
            const status = parts[7] || 'Pendente';
            if(!db.agendamentos.find(a => a.id === id)) db.agendamentos.push({ id, pacienteId, data, hora, procedimento: proc, valor, status });
          }
        });
        saveDB();
        alert('Importação concluída (MVP: parse simples).');
      };
      reader.readAsText(file,'UTF-8');
      evt.target.value = ''; // reset
    }

    function downloadBackup() {
      const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'saasclinic-backup.json'; a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    /* -------------------------
       Modals helpers
       ------------------------- */
    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
      if(id === 'modal-paciente') {
        // clear edit fields for new create
        document.getElementById('p-id').value = '';
        document.getElementById('p-nome').value = '';
        document.getElementById('p-tel').value = '';
        document.getElementById('p-email').value = '';
        document.getElementById('p-notes').value = '';
      }
      if(id === 'modal-agendamento') {
        document.getElementById('a-id').value = '';
        const sel = document.getElementById('a-paciente'); sel.innerHTML = '';
        db.pacientes.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.nome}</option>`);
        document.getElementById('a-data').value = todayISO();
        document.getElementById('a-hora').value = '09:00';
        document.getElementById('a-procedimento').value = '';
        document.getElementById('a-valor').value = '';
        document.getElementById('a-notes').value = '';
      }
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    /* -------------------------
       Helpers e Init
       ------------------------- */
    function updateAll() {
      renderPacientes();
      renderAgenda();
      updateDashboard();
    }

    function init() {
      loadDB();
      // if no data, create sample patients
      if(!db.pacientes || db.pacientes.length === 0) { db.pacientes = [{ id: genId(), nome:'Paciente Exemplo', telefone:'5511999998888', email:'', notes:'', lastVisit:'-' }]; saveDB(); }
      router('dashboard');
    }

    // attach forms
    document.getElementById('form-paciente').addEventListener('submit', (e) => { e.preventDefault(); savePaciente(); });
    document.getElementById('form-agendamento').addEventListener('submit', (e) => { e.preventDefault(); saveAgendamento(); });

    // boot
    window.addEventListener('load', init);
  </script>
</body>
</html>
